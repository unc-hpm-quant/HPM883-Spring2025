<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Sean Sylvia, Ph.D.">
<meta name="dcterms.date" content="2025-02-25">
<title>Unit 2.2: Randomization Techniques – HPM 883</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-1fa1d8026083a9bddc52b4aafc7f818e.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-1fa1d8026083a9bddc52b4aafc7f818e.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-ecb6e7fce1ae14730c1686dde9be5040.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-135ac4d113b30199e54d7437fe66c954.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="../site_libs/quarto-diagram/mermaid.min.js"></script><script src="../site_libs/quarto-diagram/mermaid-init.js"></script><link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script><script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script><script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Unit 2.2: Randomization Techniques</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/hpm883" title="GitHub" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
    <a href="https://rstudio.cloud/" title="Rstudio Cloud" class="quarto-navigation-tool px-1" aria-label="Rstudio Cloud"><i class="bi bi-code-square"></i></a>
    <div class="dropdown">
      <a href="" title="Support" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Support"><i class="bi bi-life-preserver"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://placeholder.link/office-hours">
              <i class="bi bi-person-raised-hand pe-1"></i>
            Office hours
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://placeholder.link/help-humans">
              <i class="bi bi-people-fill pe-1"></i>
            Help from humans
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://placeholder.link/chatbot">
              <i class="bi bi-robot pe-1"></i>
            Help from AI (Chatbot)
            </a>
          </li>
      </ul>
</div>
    <a href="https://hpm883.slack.com" title="Slack" class="quarto-navigation-tool px-1" aria-label="Slack"><i class="bi bi-slack"></i></a>
    <div class="dropdown">
      <a href="" title="Canvas" id="quarto-navigation-tool-dropdown-1" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Canvas"><i class="bi bi-file-check-fill"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-1">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://placeholder.link/announcements">
              <i class="bi bi-megaphone-fill pe-1"></i>
            Announcements
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://placeholder.link/gradescope">
              <i class="bi bi-file-arrow-up-fill pe-1"></i>
            Gradescope
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://placeholder.link/gradebook">
              <i class="bi bi-alphabet-uppercase pe-1"></i>
            Gradebook
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Schedule</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Course Information</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course-syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../instructors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instructors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course-communication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Communication</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Semester Project</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project Description</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ex-simulate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Simulation Example</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Unit 0: Foundations</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-0/unit-0-foundations-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 0.0: Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-0/unit-0-foundations-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 0.1: A Field Experiment in Health Services Research</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-0/unit-0-foundations-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 0.2: Computing for Reproducible Research</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Unit 1: Internal Validity</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-1/unit-1-internal-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 1.0: Internal Validity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab-1-InternalValidityPO.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 1: The Hospital of Uncertain Outcomes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-1/unit-1-internal-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 1.1: Statistical Conclusion Validity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab-2-Power.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 2: Power by Simulation</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Unit 2: Design of Experiments</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-2/unit-2-design-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 2.1: Optimal Experimental Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-2/unit-2-design-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 2.2: How to Randomize</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab-3-design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 3: Experiment Design</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Unit 3: Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-3/unit-3-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 3: Supervised Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-3/lec-3-3-slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Slides: Unit 3.3: Tree-based Methods</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Unit 4: Mechanisms</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-4/unit-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 4: Mechanisms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-4/lec-4-1-slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Slides: Unit 4.1: Estimating Average Treatment Effects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-4/lec-4-2-slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Slides: Unit 4.2: Heterogeneous Treatment Effects &amp; Moderation</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">Unit 5: Threats to Validity</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-5/unit-5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 5: Threats to Validity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-5/lec-5-0-slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Slides: Unit 5.0: Threats to Validity</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">Resources</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Useful Reference Materials</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../templates.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Templates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../unit-2/shiny-oed-app.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimal Experiment Design App</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quiz-generator/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Random Question Generator</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#bernoulli-trials" id="toc-bernoulli-trials" class="nav-link" data-scroll-target="#bernoulli-trials">Bernoulli Trials</a></li>
  <li><a href="#complete-randomization" id="toc-complete-randomization" class="nav-link" data-scroll-target="#complete-randomization">Complete Randomization</a></li>
  <li><a href="#re-randomization" id="toc-re-randomization" class="nav-link" data-scroll-target="#re-randomization">Re-randomization</a></li>
  <li><a href="#stratified-block-randomization" id="toc-stratified-block-randomization" class="nav-link" data-scroll-target="#stratified-block-randomization">Stratified (Block) Randomization</a></li>
  <li><a href="#matched-pairs-randomization" id="toc-matched-pairs-randomization" class="nav-link" data-scroll-target="#matched-pairs-randomization">Matched Pairs Randomization</a></li>
  <li><a href="#implementation-3" id="toc-implementation-3" class="nav-link" data-scroll-target="#implementation-3">Implementation</a></li>
  <li><a href="#verifying-balance-approaches-and-best-practices" id="toc-verifying-balance-approaches-and-best-practices" class="nav-link" data-scroll-target="#verifying-balance-approaches-and-best-practices">Verifying Balance: Approaches and Best Practices</a></li>
  <li><a href="#plot-the-proportion-treated-in-each-stratum" id="toc-plot-the-proportion-treated-in-each-stratum" class="nav-link" data-scroll-target="#plot-the-proportion-treated-in-each-stratum">Plot the proportion treated in each stratum</a></li>
  <li><a href="#compare-age-distribution-by-treatment-status-for-all-randomization-methods" id="toc-compare-age-distribution-by-treatment-status-for-all-randomization-methods" class="nav-link" data-scroll-target="#compare-age-distribution-by-treatment-status-for-all-randomization-methods">Compare age distribution by treatment status for all randomization methods</a></li>
  <li><a href="#visualize-matched-pairs-first-20-pairs" id="toc-visualize-matched-pairs-first-20-pairs" class="nav-link" data-scroll-target="#visualize-matched-pairs-first-20-pairs">Visualize matched pairs (first 20 pairs)</a></li>
  <li>
<a href="#compare-balance-across-methods-with-a-p-value-visualization" id="toc-compare-balance-across-methods-with-a-p-value-visualization" class="nav-link" data-scroll-target="#compare-balance-across-methods-with-a-p-value-visualization">Compare balance across methods with a p-value visualization</a>
  <ul class="collapse">
<li><a href="#complex-experimental-designs" id="toc-complex-experimental-designs" class="nav-link" data-scroll-target="#complex-experimental-designs">Complex Experimental Designs</a></li>
  <li><a href="#practical-implementation-tips" id="toc-practical-implementation-tips" class="nav-link" data-scroll-target="#practical-implementation-tips">Practical Implementation Tips</a></li>
  <li><a href="#ethical-considerations-in-randomization" id="toc-ethical-considerations-in-randomization" class="nav-link" data-scroll-target="#ethical-considerations-in-randomization">Ethical Considerations in Randomization</a></li>
  <li><a href="#conclusion-which-method-when" id="toc-conclusion-which-method-when" class="nav-link" data-scroll-target="#conclusion-which-method-when">Conclusion: Which Method When?</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/hpm883/edit/main/unit-2/lec-2-2.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/hpm883/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Unit 2.2: Randomization Techniques</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sean Sylvia, Ph.D. </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 25, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header><section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Building on our previous discussion of optimal experimental design where we focused on maximizing statistical power under various constraints, today we turn our attention to the art and science of randomization itself. Randomization is the cornerstone of causal inference in experimental research, enabling us to make causal claims by balancing both observable and unobservable characteristics between treatment and control groups. Whereas observational studies must rely on often-questionable assumptions about selection mechanisms, properly randomized experiments provide a foundation for causal inference that is far more credible.</p>
<p>The power of randomization comes from its ability to create groups that are, in expectation, identical on all characteristics—not just those we can observe and measure, but also on unobservable factors that might influence outcomes. This property allows us to attribute any differences in outcomes between treatment and control groups to the treatment itself, rather than to pre-existing differences between groups.</p>
<section id="theoretical-foundation-why-randomization-works" class="level3"><h3 class="anchored" data-anchor-id="theoretical-foundation-why-randomization-works">Theoretical Foundation: Why Randomization Works</h3>
<p>Randomization works because it satisfies three essential conditions:</p>
<ol type="1">
<li>
<strong>Non-zero probability condition</strong>: Each unit has a positive probability of receiving any treatment assignment.</li>
<li>
<strong>Individualism</strong>: The assignment of one unit doesn’t depend on the assignments of other units.</li>
<li>
<strong>Unconfoundedness</strong>: The treatment assignment is independent of potential outcomes.</li>
</ol>
<p>When these conditions are met, we can write:</p>
<p><span class="math display">\[E[Y_i(0)|D_i=1] = E[Y_i(0)|D_i=0]\]</span></p>
<p>This equation states that the expected untreated potential outcome for those in the treatment group equals the expected untreated potential outcome for those in the control group. In other words, the groups are balanced on the counterfactual outcome we never get to observe for the treatment group. This balance on unobservables is the key to establishing causality.</p>
</section><section id="elements-needed-for-randomization" class="level3"><h3 class="anchored" data-anchor-id="elements-needed-for-randomization">Elements Needed for Randomization</h3>
<p>Before discussing specific randomization methods, let’s identify what’s generally required to implement randomization:</p>
<ol type="1">
<li>
<strong>Sample of units</strong>: The individuals, clusters, or entities to be randomized</li>
<li>
<strong>Allocation ratio</strong>: The proportion of units to assign to each treatment condition</li>
<li>
<strong>Randomization device</strong>: A physical or computational mechanism to generate random assignments</li>
<li>
<strong>Baseline covariates</strong>: (For some approaches) Information on characteristics to balance across groups</li>
</ol></section><section id="random-sampling-vs.-random-assignment" class="level3"><h3 class="anchored" data-anchor-id="random-sampling-vs.-random-assignment">Random Sampling vs.&nbsp;Random Assignment</h3>
<div class="quarto-figure quarto-figure-center" style="float: right; margin-left: 10px; width: 300px;">
<figure class="figure"><p><img src="media/SamplingVRandom.png" class="img-fluid figure-img"></p>
<figcaption>Random Sampling vs.&nbsp;Random Assignment</figcaption></figure>
</div>
<p>It’s important to distinguish between two distinct concepts that are sometimes confused:</p>
<ul>
<li>
<strong>Random sampling</strong>: The process of selecting units from a population so that each unit has a known probability of selection</li>
<li>
<strong>Random assignment</strong>: The process of allocating units to treatment conditions through a random process</li>
</ul>
<p>Random sampling helps with external validity (generalizability), while random assignment helps with internal validity (causal inference). In many experiments, we don’t have a random sample from the population, but we still randomize treatment assignment within our convenience sample.</p>
</section><section id="graphical-unit-overview" class="level3"><h3 class="anchored" data-anchor-id="graphical-unit-overview">Graphical Unit Overview</h3>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"></figure><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    %% Top nodes - conditions
    A["Non-zero probability condition"]:::gold
    B["Individualism condition"]:::gold
    C["Unconfoundedness condition"]:::gold
    
    %% Middle node - mechanisms
    subgraph D[Classical Random Assignment Mechanisms]
        F["Bernoulli Trial"]:::carolinaBlue
        G["Complete Randomized\nExperiment (CRE)"]:::carolinaBlue
        H["Stratified Randomization"]:::carolinaBlue
        I["Rerandomization"]:::carolinaBlue
        J["Matched Pairs"]:::carolinaBlue
    end
    subgraph E[Complex Experimental Designs]
        K["Blocking"]:::carolinaBlue
        L["Covariate-adaptive Randomization"]:::carolinaBlue
        M["Minimization"]:::carolinaBlue
    end
    
    %% Bottom node - inference
    N{{"Design-conscious Inference"}}:::uncGreen
    
    %% Connections
    A --&gt; D
    B --&gt; D
    C --&gt; D
    A --&gt; E
    B --&gt; E
    C --&gt; E
    D --&gt; N
    E --&gt; N

    %% UNC Brand Colors
    classDef gold fill:#FFD100,stroke:#13294B,stroke-width:1px,color:#13294B
    classDef lightGrey fill:#F7F7F7,stroke:#13294B,stroke-width:1px,color:#13294B
    classDef carolinaBlue fill:#4B9CD3,stroke:#13294B,stroke-width:1px,color:#FFFFFF
    classDef uncGreen fill:#8DB434,stroke:#13294B,stroke-width:1px,color:#13294B
    
    %% Apply lightGrey style to subgraphs
    style D fill:#F7F7F7,stroke:#13294B,stroke-width:1px,color:#13294B
    style E fill:#F7F7F7,stroke:#13294B,stroke-width:1px,color:#13294B
</pre>
</div>
<p></p>
</div>
</div>
</div>
</section><section id="classical-assignment-mechanisms" class="level3"><h3 class="anchored" data-anchor-id="classical-assignment-mechanisms">Classical Assignment Mechanisms</h3>
<p>There are five primary approaches to random assignment, each with distinct advantages and disadvantages:</p>
<ol type="1">
<li>Bernoulli trials</li>
<li>Complete randomization</li>
<li>Re-randomization</li>
<li>Stratified randomization</li>
<li>Matched-pair designs</li>
</ol>
<p>Let’s examine each approach in detail.</p>
</section></section><section id="bernoulli-trials" class="level2"><h2 class="anchored" data-anchor-id="bernoulli-trials">Bernoulli Trials</h2>
<p>Bernoulli trials represent the simplest approach to randomization, where each unit is assigned to treatment independently with a fixed probability. This is conceptually equivalent to flipping a coin for each participant, with heads resulting in treatment assignment and tails resulting in control assignment.</p>
<section id="implementation" class="level3"><h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
<p>Let’s first create a dataset to work with:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate data with 1000 participants</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co"># Create baseline covariates</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>  <span class="co"># ID variable</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>  </span>
<span>  <span class="co"># Covariates that will be used for stratification</span></span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">18</span><span class="op">:</span><span class="fl">80</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,                   <span class="co"># Continuous </span></span>
<span>  education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Primary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Higher"</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>,          <span class="co"># Categorical</span></span>
<span>  </span>
<span>  <span class="co"># Additional covariates not used for stratification</span></span>
<span>  female <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.55</span><span class="op">)</span>,                              <span class="co"># Binary</span></span>
<span>  income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span><span class="va">n</span>, meanlog <span class="op">=</span> <span class="fl">10</span>, sdlog <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,    <span class="co"># Continuous, right-skewed</span></span>
<span>  rural <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.4</span><span class="op">)</span>,                                <span class="co"># Binary</span></span>
<span>  chronic_disease <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.3</span><span class="op">)</span>,                      <span class="co"># Binary</span></span>
<span>  satisfaction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>,             <span class="co"># Ordinal 1-5 scale</span></span>
<span>                       prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert categorical variables to factors for clearer output</span></span>
<span><span class="va">dt</span><span class="op">[</span>, <span class="va">education</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">education</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Primary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Higher"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># View data structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Data structure:"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Data structure:"</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  1000 obs. of  8 variables:
 $ id             : int  1 2 3 4 5 6 7 8 9 10 ...
 $ age            : int  19 34 62 45 44 74 40 24 36 34 ...
 $ education      : Factor w/ 4 levels "None","Primary",..: 3 3 3 2 4 3 3 2 3 3 ...
 $ female         : int  1 1 1 0 1 1 1 1 1 1 ...
 $ income         : num  15382 38850 10788 42119 17465 ...
 $ rural          : int  0 1 0 0 0 1 1 0 1 1 ...
 $ chronic_disease: int  1 0 1 1 1 0 0 0 0 0 ...
 $ satisfaction   : int  2 3 1 2 1 5 3 1 3 3 ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># View the first 10 observations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      id   age education female   income rural chronic_disease satisfaction
   &lt;int&gt; &lt;int&gt;    &lt;fctr&gt;  &lt;int&gt;    &lt;num&gt; &lt;int&gt;           &lt;int&gt;        &lt;int&gt;
1:     1    19 Secondary      1 15381.84     0               1            2
2:     2    34 Secondary      1 38849.92     1               0            3
3:     3    62 Secondary      1 10788.07     0               1            1
4:     4    45   Primary      0 42118.52     0               1            2
5:     5    44    Higher      1 17465.41     0               1            1
6:     6    74 Secondary      1 18718.60     1               0            5</code></pre>
</div>
</div>
<p>Now let’s randomize using Bernoulli:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make a copy of the data (so we can compare to other randomization methods below)</span></span>
<span><span class="va">dt_bern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bernoulli trial example</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">072111</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>  <span class="co"># Probability of treatment assignment</span></span>
<span></span>
<span><span class="co"># Independent random assignment</span></span>
<span><span class="va">dt_bern</span><span class="op">[</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">1</span>, <span class="va">p</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Check resulting allocation</span></span>
<span><span class="va">dt_bern</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">treatment</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treatment     N
       &lt;int&gt; &lt;int&gt;
1:         0   514
2:         1   486</code></pre>
</div>
</div>
</section><section id="advantages-and-disadvantages" class="level3"><h3 class="anchored" data-anchor-id="advantages-and-disadvantages">Advantages and Disadvantages</h3>
<p><strong>Advantages:</strong></p>
<ul>
<li>Simple to implement</li>
<li>Can randomize as participants arrive (no need to know full sample in advance)</li>
<li>No baseline data needed</li>
</ul>
<p><strong>Disadvantages:</strong> - Random group sizes (can result in imbalanced treatment allocation) - Potential imbalance on key covariates - Vulnerable to implementation problems</p>
</section><section id="case-study-the-canadian-national-breast-screening-study" class="level3"><h3 class="anchored" data-anchor-id="case-study-the-canadian-national-breast-screening-study">Case Study: The Canadian National Breast Screening Study</h3>
<p>The Canadian National Breast Screening Study (CNBSS) provides a cautionary tale about vulnerabilities in Bernoulli-type randomization. This major randomized trial evaluated the effectiveness of mammography screening for breast cancer in the 1980s.</p>
<p>The study used a variant of simple alternating assignment—assigning the first woman to treatment, the second to control, and so on. However, several critical flaws emerged:</p>
<ol type="1">
<li>
<strong>Pre-randomization examination</strong>: Women received clinical breast exams before randomization, providing information that could influence assignment</li>
<li>
<strong>Knowledge of the assignment schedule</strong>: Staff knew that assignments alternated, creating opportunities for manipulation</li>
<li>
<strong>Inadequate concealment</strong>: Study coordinators could see which group the next woman would be assigned to</li>
<li>
<strong>Evidence of manipulation</strong>: Later audits found names overwritten, identities reversed, and lines skipped in assignment ledgers</li>
</ol>
<p>The consequences were severe: women with palpable lumps were disproportionately assigned to the mammography group, creating a significant selection bias. The mammography group had a 68% higher incidence of advanced cancers at baseline! This likely masked any potential benefits of screening, as the study ultimately reported no mortality benefit from mammography.[^1]</p>
<p>This case highlights how vulnerable simple randomization schemes can be to manipulation, especially when those implementing the study have preferences about treatment assignment or when the randomization process is transparent and predictable. Note that there is nothing wrong with Bernoulli trials, but you should carefully consider how to impelment randomization to preserve the integrity of the randomization process. Especially when working with partner organizations (which we do all the time in health services research), one needs to work with these partners to devise a randomization protocol that fits their existing workflow but protects the randomization process.</p>
</section></section><section id="complete-randomization" class="level2"><h2 class="anchored" data-anchor-id="complete-randomization">Complete Randomization</h2>
<p>Complete randomization addresses some of the limitations of Bernoulli trials by fixing the number of units assigned to each treatment condition, ensuring the desired allocation ratio is achieved exactly.</p>
<section id="implementation-1" class="level3"><h3 class="anchored" data-anchor-id="implementation-1">Implementation</h3>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Copy data</span></span>
<span><span class="va">dt_cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">072111</span><span class="op">)</span>  <span class="co"># Set seed for reproducibility</span></span>
<span></span>
<span><span class="co"># Parameters</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>          <span class="co"># Proportion to assign to treatment</span></span>
<span></span>
<span><span class="co"># Add a column with uniform random numbers from 0 to 1.</span></span>
<span><span class="va">dt_cr</span><span class="op">[</span>, <span class="va">random_num</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">.N</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Sort by random number</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">dt_cr</span>, <span class="va">random_num</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign first p% to treatment</span></span>
<span><span class="va">dt_cr</span><span class="op">[</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span></span>
<span><span class="va">dt_cr</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">.N</span><span class="op">*</span><span class="va">p</span><span class="op">)</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Check resulting allocation</span></span>
<span><span class="va">dt_cr</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">treatment</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treatment     N
       &lt;num&gt; &lt;int&gt;
1:         1   500
2:         0   500</code></pre>
</div>
</div>
<p>In complete randomization, we first determine exactly how many units will receive each treatment. Then we generate a random ordering of all units and assign the first <span class="math inline">\(N_p\)</span> units to treatment and the remaining <span class="math inline">\(N_0\)</span> units to control.</p>
</section><section id="advantages-and-disadvantages-1" class="level3"><h3 class="anchored" data-anchor-id="advantages-and-disadvantages-1">Advantages and Disadvantages</h3>
<p><strong>Advantages:</strong></p>
<ul>
<li><p>Guarantees exactly the desired allocation ratio</p></li>
<li><p>Avoids power loss from uneven group sizes - Still relatively simple to implement</p></li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li><p>Requires knowing the full sample in advance</p></li>
<li><p>Still subject to chance imbalance on covariates</p></li>
</ul>
<p>Let’s check the balance we got for the two examples above by running t-tests comparing the treatment and control groups.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># First let's create a function to perform t-tests and create a formatted results table</span></span>
<span><span class="va">run_ttests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    p_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">var</span> <span class="kw">in</span> <span class="va">baseline_vars</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># For categorical variables (factor), we need to handle differently</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># For each level of the factor</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">level</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Create temporary binary indicator</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">==</span> <span class="va">level</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="co"># Calculate means</span></span>
<span>        <span class="va">mean_control</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="va">mean_treated</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="co"># Run t-test</span></span>
<span>        <span class="va">t_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">temp</span><span class="op">]</span>, </span>
<span>                           <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">temp</span><span class="op">]</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Add to results</span></span>
<span>        <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">": "</span>, <span class="va">level</span><span class="op">)</span>,</span>
<span>          method <span class="op">=</span> <span class="va">title</span>,</span>
<span>          mean_control <span class="op">=</span> <span class="va">mean_control</span>,</span>
<span>          mean_treated <span class="op">=</span> <span class="va">mean_treated</span>,</span>
<span>          diff <span class="op">=</span> <span class="va">mean_treated</span> <span class="op">-</span> <span class="va">mean_control</span>,</span>
<span>          p_value <span class="op">=</span> <span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>          significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Remove temporary variable</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># For continuous and binary variables</span></span>
<span>      <span class="va">mean_control</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="va">mean_treated</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="co"># Run t-test</span></span>
<span>      <span class="va">t_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span></span>
<span>        <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">]</span>, </span>
<span>        <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Add to results</span></span>
<span>      <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>        variable <span class="op">=</span> <span class="va">var</span>,</span>
<span>        method <span class="op">=</span> <span class="va">title</span>,</span>
<span>        mean_control <span class="op">=</span> <span class="va">mean_control</span>,</span>
<span>        mean_treated <span class="op">=</span> <span class="va">mean_treated</span>,</span>
<span>        diff <span class="op">=</span> <span class="va">mean_treated</span> <span class="op">-</span> <span class="va">mean_control</span>,</span>
<span>        p_value <span class="op">=</span> <span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>        significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Now let's run the tests</span></span>
<span></span>
<span><span class="co">## List of all baseline covariates to test</span></span>
<span><span class="va">baseline_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"education"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run t-tests</span></span>
<span><span class="va">ttest_bern</span> <span class="op">&lt;-</span> <span class="fu">run_ttests</span><span class="op">(</span><span class="va">dt_bern</span>, <span class="st">"Bernoulli - t-test"</span><span class="op">)</span></span>
<span><span class="va">ttest_cr</span> <span class="op">&lt;-</span> <span class="fu">run_ttests</span><span class="op">(</span><span class="va">dt_cr</span>, <span class="st">"Complete - t-test"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ttest_bern</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                variable             method mean_control mean_treated
                  &lt;char&gt;             &lt;char&gt;        &lt;num&gt;        &lt;num&gt;
 1:                  age Bernoulli - t-test 5.029767e+01 4.860905e+01
 2:      education: None Bernoulli - t-test 1.050584e-01 1.172840e-01
 3:   education: Primary Bernoulli - t-test 3.112840e-01 3.209877e-01
 4: education: Secondary Bernoulli - t-test 3.735409e-01 3.971193e-01
 5:    education: Higher Bernoulli - t-test 2.101167e-01 1.646091e-01
 6:               female Bernoulli - t-test 5.972763e-01 5.802469e-01
 7:               income Bernoulli - t-test 3.698802e+04 3.183656e+04
 8:                rural Bernoulli - t-test 3.988327e-01 4.074074e-01
 9:      chronic_disease Bernoulli - t-test 3.171206e-01 3.086420e-01
10:         satisfaction Bernoulli - t-test 2.964981e+00 2.917695e+00
             diff    p_value significant
            &lt;num&gt;      &lt;num&gt;      &lt;char&gt;
 1: -1.688612e+00 0.14555945            
 2:  1.222558e-02 0.53949726            
 3:  9.703608e-03 0.74185085            
 4:  2.357849e-02 0.44441213            
 5: -4.550768e-02 0.06504122            
 6: -1.702935e-02 0.58485993            
 7: -5.151461e+03 0.06919766            
 8:  8.574723e-03 0.78260046            
 9: -8.478647e-03 0.77281943            
10: -4.728507e-02 0.50045109            </code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ttest_cr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                variable            method mean_control mean_treated     diff
                  &lt;char&gt;            &lt;char&gt;        &lt;num&gt;        &lt;num&gt;    &lt;num&gt;
 1:                  age Complete - t-test       48.630       50.324    1.694
 2:      education: None Complete - t-test        0.116        0.106   -0.010
 3:   education: Primary Complete - t-test        0.320        0.312   -0.008
 4: education: Secondary Complete - t-test        0.396        0.374   -0.022
 5:    education: Higher Complete - t-test        0.168        0.208    0.040
 6:               female Complete - t-test        0.584        0.594    0.010
 7:               income Complete - t-test    31828.744    37140.081 5311.337
 8:                rural Complete - t-test        0.404        0.402   -0.002
 9:      chronic_disease Complete - t-test        0.316        0.310   -0.006
10:         satisfaction Complete - t-test        2.914        2.970    0.056
       p_value significant
         &lt;num&gt;      &lt;char&gt;
 1: 0.14434344            
 2: 0.61514873            
 3: 0.78582226            
 4: 0.47518803            
 5: 0.10571624            
 6: 0.74823610            
 7: 0.06446256            
 8: 0.94865983            
 9: 0.83809577            
10: 0.42490327            </code></pre>
</div>
</div>
</section><section id="chance-imbalance-in-complete-randomization" class="level3"><h3 class="anchored" data-anchor-id="chance-imbalance-in-complete-randomization">Chance Imbalance in Complete Randomization</h3>
<p>Even with perfect implementation of complete randomization, covariates may still be imbalanced by chance. In a simulation study using data from the National Longitudinal Survey of Youth (NLSY) with 722 subjects:[^1]</p>
<ul>
<li>~45% of randomizations had all covariates balanced</li>
<li>~30% had one imbalanced covariate</li>
<li>The remaining had multiple imbalanced covariates</li>
</ul>
<p>This raises two critical questions: 1. How can we ensure better balance in the design phase? 2. What should we do if imbalance occurs after randomization?</p>
<p><strong>Our next three approaches address the first question by improving balance through more sophisticated randomization techniques.</strong></p>
</section></section><section id="re-randomization" class="level2"><h2 class="anchored" data-anchor-id="re-randomization">Re-randomization</h2>
<p>Re-randomization attempts to improve covariate balance by generating multiple possible randomizations and selecting one with good balance.</p>
<p>There are two common approaches to re-randomization:</p>
<ol type="1">
<li>
<strong>Threshold approach</strong>: Generate randomizations until all p-values for covariate balance exceed a threshold (e.g., p &gt; 0.1)</li>
<li>
<strong>Optimization approach</strong>: Generate a large number of randomizations (e.g., 1,000) and select the one with the best overall balance</li>
</ol>
<section id="threshold-approach" class="level3"><h3 class="anchored" data-anchor-id="threshold-approach">Threshold Approach</h3>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Copy the data again</span></span>
<span><span class="va">dt_rerand_threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Re-randomization - Threshold Approach:</span></span>
<span><span class="co"># Function to test balance on key covariates</span></span>
<span><span class="va">test_balance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Define key covariates to check balance on</span></span>
<span>  <span class="va">balance_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"education"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Store p-values</span></span>
<span>  <span class="va">p_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">balance_vars</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">p_values</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">balance_vars</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">balance_vars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">var</span> <span class="op">&lt;-</span> <span class="va">balance_vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># For categorical variables</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Create model matrix (one-hot encoding)</span></span>
<span>      <span class="va">formula_str</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"~ "</span>, <span class="va">var</span>, <span class="st">" - 1"</span><span class="op">)</span></span>
<span>      <span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">formula_str</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span>      <span class="co"># Test each level except the reference</span></span>
<span>      <span class="va">p_vals_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">t_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">mm</span><span class="op">[</span><span class="va">dt</span><span class="op">$</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">j</span><span class="op">]</span>, <span class="va">mm</span><span class="op">[</span><span class="va">dt</span><span class="op">$</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">p_vals_cat</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="co"># Use minimum p-value (most imbalanced category)</span></span>
<span>      <span class="va">p_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">p_vals_cat</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># For continuous or binary variables</span></span>
<span>      <span class="va">t_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">]</span>, <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">p_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">p_values</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Re-randomization with threshold approach</span></span>
<span><span class="co"># Continue generating randomizations until all p-values &gt; 0.10</span></span>
<span><span class="va">max_attempts</span> <span class="op">&lt;-</span> <span class="fl">1000</span>  <span class="co"># Safety limit to prevent infinite loops</span></span>
<span><span class="va">attempt</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">balanced</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nPerforming re-randomization with threshold approach...\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Performing re-randomization with threshold approach...</code></pre>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">while</span> <span class="op">(</span><span class="op">!</span><span class="va">balanced</span> <span class="op">&amp;&amp;</span> <span class="va">attempt</span> <span class="op">&lt;</span> <span class="va">max_attempts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">attempt</span> <span class="op">&lt;-</span> <span class="va">attempt</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># Generate a new randomization</span></span>
<span>  <span class="va">dt_rerand_threshold</span><span class="op">[</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Test balance</span></span>
<span>  <span class="va">p_values</span> <span class="op">&lt;-</span> <span class="fu">test_balance</span><span class="op">(</span><span class="va">dt_rerand_threshold</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Check if all p-values are above threshold (0.10)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">p_values</span> <span class="op">&gt;</span> <span class="fl">0.10</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">balanced</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Found balanced randomization after"</span>, <span class="va">attempt</span>, <span class="st">"attempts\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Balance p-values:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">p_values</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">p_values</span>, <span class="fl">4</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">attempt</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">100</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Completed"</span>, <span class="va">attempt</span>, <span class="st">"attempts, continuing search...\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found balanced randomization after 1 attempts
Balance p-values: age 0.3607, education 0.1213, female 0.6851, income 0.595, rural 0.6301, chronic_disease 0.3026, satisfaction 0.1012 </code></pre>
</div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">balanced</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Warning: Could not find perfectly balanced randomization after"</span>, <span class="va">max_attempts</span>, <span class="st">"attempts\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Using best randomization found so far\n\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="optimization-approach" class="level3"><h3 class="anchored" data-anchor-id="optimization-approach">Optimization approach</h3>
<p>You can define the “best” overall balance in different ways. Here we’ll use the Mahalanobis distance.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Mahalanobis distance is a statistical measure that quantifies the distance between a point and a distribution in multivariate space. The Mahalanobis distance is formally defined as:</p>
<p><span class="math display">\[
d_{maha} = \sqrt{(x_B - X_A)^TC^{-1}(x_B - x_A)}
\]</span></p>
<p>Where: • <span class="math inline">\(x_A\)</span> and <span class="math inline">\(x_B\)</span> are a pair of objects • <span class="math inline">\(C\)</span> is the sample covariance matrix • <span class="math inline">\(C^{-1}\)</span> is the inverse of the covariance matrix • <span class="math inline">\(T\)</span> denotes the transpose operation</p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Copy data</span></span>
<span></span>
<span><span class="va">dt_rerand_optimal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Re-randomization - Optimization Approach:</span></span>
<span><span class="co"># Generate multiple randomizations and select the one with best overall balance</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Performing re-randomization with optimization approach...\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Performing re-randomization with optimization approach...</code></pre>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n_candidates</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">mahalanobis_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_candidates</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate covariates matrix (need to handle factors separately)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Converting covariates to numeric for Mahalanobis distance calculation...\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Converting covariates to numeric for Mahalanobis distance calculation...</code></pre>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cov_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add dummy variables for education</span></span>
<span><span class="va">edu_dummies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">education</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">dt_rerand_optimal</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dt_rerand_optimal</span><span class="op">[</span>, <span class="va">..cov_vars</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="va">edu_dummies</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate covariance matrix of covariates</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">S_inv</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>  <span class="co"># Try to compute inverse</span></span>
<span><span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Covariance matrix is singular, using pseudoinverse...\n"</span><span class="op">)</span></span>
<span>  <span class="co"># Use pseudoinverse if matrix is singular</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/ginv.html">ginv</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Covariance matrix is singular, using pseudoinverse...</code></pre>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Generate candidate randomizations and calculate balance measure</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_candidates</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Generate a new randomization</span></span>
<span>  <span class="va">treatment_assign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate difference in means</span></span>
<span>  <span class="va">mean_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">treatment_assign</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">treatment_assign</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate Mahalanobis distance</span></span>
<span>  <span class="va">mahalanobis_distances</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mean_diff</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">S_inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mean_diff</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">200</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Generated"</span>, <span class="va">i</span>, <span class="st">"candidate randomizations...\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generated 200 candidate randomizations...
Generated 400 candidate randomizations...
Generated 600 candidate randomizations...
Generated 800 candidate randomizations...
Generated 1000 candidate randomizations...</code></pre>
</div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Find the randomization with smallest Mahalanobis distance</span></span>
<span><span class="va">best_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">mahalanobis_distances</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Selected optimal randomization (candidate"</span>, <span class="va">best_idx</span>, <span class="st">"with Mahalanobis distance ="</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mahalanobis_distances</span><span class="op">[</span><span class="va">best_idx</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">")\n\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Selected optimal randomization (candidate 165 with Mahalanobis distance = 0 )</code></pre>
</div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Generate the best randomization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">best_idx</span><span class="op">)</span>  <span class="co"># For reproducibility</span></span>
<span><span class="va">dt_rerand_optimal</span><span class="op">[</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="drawbacks-of-re-randomization" class="level3"><h3 class="anchored" data-anchor-id="drawbacks-of-re-randomization">Drawbacks of Re-randomization</h3>
<p>While re-randomization can improve balance, it has several limitations:</p>
<ul>
<li>
<strong>Opaque constraints</strong>: The process creates a “black box” where it’s unclear what constraints are being imposed</li>
<li>
<strong>Unusual handling of outliers</strong>: Extreme values may force unusual allocation patterns</li>
<li>
<strong>Computational cost</strong>: May require many iterations, especially with multiple covariates</li>
<li>
<strong>Potential futility</strong>: If criteria are too strict, acceptable randomizations may be extremely rare</li>
<li>
<strong>Statistical inference complications</strong>: Standard methods don’t account for the re-randomization process</li>
<li>
<strong>Limited scope</strong>: Still cannot balance on unobserved covariates</li>
</ul></section></section><section id="stratified-block-randomization" class="level2"><h2 class="anchored" data-anchor-id="stratified-block-randomization">Stratified (Block) Randomization</h2>
<p>Stratified randomization (also called block randomization) directly addresses the balance issue by dividing the sample into strata based on covariates and randomizing separately within each stratum.</p>
<p>In this approach, we first create strata based on combinations of important covariates, then randomize separately within each stratum. This guarantees perfect balance on the stratification variables.</p>
<section id="selecting-stratification-variables" class="level3"><h3 class="anchored" data-anchor-id="selecting-stratification-variables">Selecting Stratification Variables</h3>
<p>Not all covariates are equally important for stratification. Consider these guidelines:</p>
<ul>
<li>
<strong>Discrete variables</strong> are easier to implement than continuous ones</li>
<li>Prioritize variables that <strong>strongly predict outcomes</strong> (baseline values of the outcome variable are especially important)</li>
<li>Include variables where <strong>heterogeneous effects</strong> are expected (facilitates subgroup analysis)</li>
<li>Be careful about creating <strong>too many strata</strong>, which can lead to “small cell” problems</li>
</ul></section><section id="handling-misfits" class="level3"><h3 class="anchored" data-anchor-id="handling-misfits">Handling “Misfits”</h3>
<p>A practical challenge in stratified randomization occurs when strata sizes are not divisible by the number of treatment conditions (e.g., three people in a stratum with two treatment conditions). Options for these “misfits” include:</p>
<ul>
<li>Remove units randomly to create divisible strata</li>
<li>Create a separate stratum for misfits</li>
<li>Use a different randomization approach for misfits</li>
</ul></section><section id="implementation-2" class="level3"><h3 class="anchored" data-anchor-id="implementation-2">Implementation</h3>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Copy the Data</span></span>
<span><span class="va">dt_strat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the seed using Zoe's bday</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">072111</span><span class="op">)</span>  <span class="co"># For reproducibility</span></span>
<span></span>
<span><span class="co"># Convert categorical variables to factors for clearer output</span></span>
<span><span class="va">dt_strat</span><span class="op">[</span>, <span class="va">education</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">education</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Primary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Higher"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Create age quintiles</span></span>
<span><span class="va">dt_strat</span><span class="op">[</span>, <span class="va">age_quintile</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">age</span>, </span>
<span>                         breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">age</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                         labels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>                         include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># View data structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Data structure:"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Data structure:"</code></pre>
</div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">dt_strat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  1000 obs. of  9 variables:
 $ id             : int  1 2 3 4 5 6 7 8 9 10 ...
 $ age            : int  19 34 62 45 44 74 40 24 36 34 ...
 $ education      : Factor w/ 4 levels "None","Primary",..: 3 3 3 2 4 3 3 2 3 3 ...
 $ female         : int  1 1 1 0 1 1 1 1 1 1 ...
 $ income         : num  15382 38850 10788 42119 17465 ...
 $ rural          : int  0 1 0 0 0 1 1 0 1 1 ...
 $ chronic_disease: int  1 0 1 1 1 0 0 0 0 0 ...
 $ satisfaction   : int  2 3 1 2 1 5 3 1 3 3 ...
 $ age_quintile   : Factor w/ 5 levels "1","2","3","4",..: 1 2 4 3 3 5 2 1 2 2 ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create strata ID by combining education and age quintile</span></span>
<span><span class="va">dt_strat</span><span class="op">[</span>, <span class="va">strata</span> <span class="op">:=</span> <span class="va">.GRP</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">education</span>, <span class="va">age_quintile</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Print strata information</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Strata information:"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Strata information:"</code></pre>
</div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dt_strat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">education</span>, <span class="va">age_quintile</span>, <span class="va">strata</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    education age_quintile strata count
       &lt;fctr&gt;       &lt;fctr&gt;  &lt;int&gt; &lt;int&gt;
 1: Secondary            1      1    86
 2: Secondary            2      2    75
 3: Secondary            4      3    71
 4:   Primary            3      4    60
 5:    Higher            3      5    42
 6: Secondary            5      6    76
 7:   Primary            1      7    66
 8:   Primary            4      8    69
 9:   Primary            5      9    65
10:   Primary            2     10    56
11:      None            5     11    21
12:    Higher            4     12    36
13:    Higher            1     13    42
14:    Higher            2     14    38
15:    Higher            5     15    30
16:      None            2     16    29
17: Secondary            3     17    77
18:      None            3     18    17
19:      None            4     19    24
20:      None            1     20    20
    education age_quintile strata count</code></pre>
</div>
</div>
<p>Now let’s randomize half of the observations in each strata to treatment and half to control. To ensure 50/50 split, we’ll use the Complete Randomization method within each strata:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dt_strat</span><span class="op">[</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span>  <span class="co"># Initialize all to control</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">dt_strat</span><span class="op">$</span><span class="va">strata</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get all units in this stratum</span></span>
<span>  <span class="va">stratum_units</span> <span class="op">&lt;-</span> <span class="va">dt_strat</span><span class="op">[</span><span class="va">strata</span> <span class="op">==</span> <span class="va">s</span>, <span class="va">id</span><span class="op">]</span></span>
<span>  <span class="va">n_units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">stratum_units</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Determine number to treat (half, rounded down)</span></span>
<span>  <span class="va">n_treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">n_units</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Misfits: If n_units is odd, flip a coin to decide whether to round up or down</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">n_units</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="va">n_treat</span> <span class="op">&lt;-</span> <span class="va">n_treat</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Randomly select units for treatment</span></span>
<span>  <span class="va">treated_units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">stratum_units</span>, <span class="va">n_treat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Assign treatment</span></span>
<span>  <span class="va">dt_strat</span><span class="op">[</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">treated_units</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Print treatment assignment by strata for stratified randomization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Treatment assignment by strata in stratified randomization:"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Treatment assignment by strata in stratified randomization:"</code></pre>
</div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dt_strat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>N <span class="op">=</span> <span class="va">.N</span>, </span>
<span>             n_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>, </span>
<span>             pct_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span>, </span>
<span>         by <span class="op">=</span> <span class="va">strata</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    strata     N n_treated pct_treated
     &lt;int&gt; &lt;int&gt;     &lt;num&gt;       &lt;num&gt;
 1:      1    86        43    50.00000
 2:      2    75        38    50.66667
 3:      3    71        36    50.70423
 4:      4    60        30    50.00000
 5:      5    42        21    50.00000
 6:      6    76        38    50.00000
 7:      7    66        33    50.00000
 8:      8    69        34    49.27536
 9:      9    65        33    50.76923
10:     10    56        28    50.00000
11:     11    21        11    52.38095
12:     12    36        18    50.00000
13:     13    42        21    50.00000
14:     14    38        19    50.00000
15:     15    30        15    50.00000
16:     16    29        14    48.27586
17:     17    77        39    50.64935
18:     18    17         9    52.94118
19:     19    24        12    50.00000
20:     20    20        10    50.00000
    strata     N n_treated pct_treated</code></pre>
</div>
</div>
</section></section><section id="matched-pairs-randomization" class="level2"><h2 class="anchored" data-anchor-id="matched-pairs-randomization">Matched Pairs Randomization</h2>
<p>Matched pairs randomization represents the extreme case of stratification, where each stratum contains exactly two similar units, and one is randomly assigned to treatment and one to control.</p>
<p>In this approach, we first create pairs of similar units based on a distance metric, then randomly assign one member of each pair to treatment and the other to control. This guarantees excellent balance on the matching variables.</p>
</section><section id="implementation-3" class="level2"><h2 class="anchored" data-anchor-id="implementation-3">Implementation</h2>
<div class="{callout-warning}">
<p>In this example, we’re using what is referred to as a “greedy” matching algorithm. It is “greedy” because it makes locally optimal choices at each step without reconsidering earlier decisions, potentially missing the globally optimal solution. We’re using this for now because it is clear and simple to impelment.</p>
<p>In practice, “canned” matching commands are commonly used to form matches and these often use other optimal matching algorithms. A non-greedy, optimal matching algorithm would consider all possible ways to pair units and select the configuration that minimizes the total sum of distances across all pairs. This is computationally more intensive (often solved using network optimization methods like the Hungarian algorithm) but guarantees the global minimum total distance.</p>
</div>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dt_matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the seed using Zoe's bday</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">072111</span><span class="op">)</span>  <span class="co"># For reproducibility</span></span>
<span></span>
<span><span class="co"># 1. Prepare data for matching</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nPerforming matched randomization using Mahalanobis distance...\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Performing matched randomization using Mahalanobis distance...</code></pre>
</div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create matrix of variables to match on</span></span>
<span><span class="va">match_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert education to dummy variables for inclusion in distance calculation</span></span>
<span><span class="va">edu_dummies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">education</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">dt_matched</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">edu_dummies</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"edu_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt_matched</span><span class="op">$</span><span class="va">education</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine numeric variables with education dummies</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dt_matched</span><span class="op">[</span>, <span class="va">..match_vars</span><span class="op">]</span><span class="op">)</span>, <span class="va">edu_dummies</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate covariance matrix and inverse</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">S_inv</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>  <span class="co"># Try to compute inverse</span></span>
<span><span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Covariance matrix is singular, using pseudoinverse...\n"</span><span class="op">)</span></span>
<span>  <span class="co"># Use pseudoinverse if matrix is singular</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/ginv.html">ginv</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Covariance matrix is singular, using pseudoinverse...</code></pre>
</div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 2. Calculate pairwise Mahalanobis distances between all units</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt_matched</span><span class="op">)</span></span>
<span><span class="va">dist_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Store original IDs to maintain correct mapping</span></span>
<span><span class="va">original_ids</span> <span class="op">&lt;-</span> <span class="va">dt_matched</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Calculating Mahalanobis distances between all units...\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating Mahalanobis distances between all units...</code></pre>
</div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Calculate vector of differences between units i and j</span></span>
<span>    <span class="va">diff</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Calculate Mahalanobis distance</span></span>
<span>    <span class="va">dist_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dist_matrix</span><span class="op">[</span><span class="va">j</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">S_inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">diff</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">100</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Processed"</span>, <span class="va">i</span>, <span class="st">"of"</span>, <span class="va">n</span>, <span class="st">"units...\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 100 of 1000 units...
Processed 200 of 1000 units...
Processed 300 of 1000 units...
Processed 400 of 1000 units...
Processed 500 of 1000 units...
Processed 600 of 1000 units...
Processed 700 of 1000 units...
Processed 800 of 1000 units...
Processed 900 of 1000 units...</code></pre>
</div>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 3. Create optimal pairs using greedy algorithm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Creating optimal pairs...\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating optimal pairs...</code></pre>
</div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unpaired_idx</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>  <span class="co"># These are indices, not IDs</span></span>
<span><span class="va">pairs_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Store pairs of indices</span></span>
<span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">unpaired_idx</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Find the nearest neighbor for the first unpaired unit</span></span>
<span>  <span class="va">current_idx</span> <span class="op">&lt;-</span> <span class="va">unpaired_idx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="va">dist_matrix</span><span class="op">[</span><span class="va">current_idx</span>, <span class="va">unpaired_idx</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">nearest_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span></span>
<span>  <span class="va">nearest_idx</span> <span class="op">&lt;-</span> <span class="va">unpaired_idx</span><span class="op">[</span><span class="va">nearest_pos</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>  <span class="co"># +1 because we excluded current from unpaired</span></span>
<span>  </span>
<span>  <span class="co"># Create a new pair of indices</span></span>
<span>  <span class="va">pairs_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pairs_idx</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">current_idx</span>, <span class="va">nearest_idx</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Remove these indices from unpaired</span></span>
<span>  <span class="va">unpaired_idx</span> <span class="op">&lt;-</span> <span class="va">unpaired_idx</span><span class="op">[</span><span class="op">!</span><span class="va">unpaired_idx</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">current_idx</span>, <span class="va">nearest_idx</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pairs_idx</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">50</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pairs_idx</span><span class="op">)</span>, <span class="st">"pairs...\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Created 50 pairs...
Created 100 pairs...
Created 150 pairs...
Created 200 pairs...
Created 250 pairs...
Created 300 pairs...
Created 350 pairs...
Created 400 pairs...
Created 450 pairs...
Created 500 pairs...</code></pre>
</div>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Handle leftover unit if odd number of units</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">unpaired_idx</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Note: Odd number of units. Unit index"</span>, <span class="va">unpaired_idx</span>, <span class="st">"will be randomly assigned.\n"</span><span class="op">)</span></span>
<span>  <span class="co"># This unit will be handled separately</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 4. Convert index pairs to ID pairs and assign treatments</span></span>
<span><span class="va">pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">pairs_idx</span>, <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="va">original_ids</span><span class="op">[</span><span class="va">p</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reset pair_id and treatment in the dataset</span></span>
<span><span class="va">dt_matched</span><span class="op">[</span>, <span class="va">pair_id</span> <span class="op">:=</span> <span class="cn">NA_integer_</span><span class="op">]</span></span>
<span><span class="va">dt_matched</span><span class="op">[</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span>  <span class="co"># Initialize all to control</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Assigning pair IDs and treatment...\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Assigning pair IDs and treatment...</code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">pairs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Assign pair ID to both units in the pair</span></span>
<span>  <span class="va">dt_matched</span><span class="op">[</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">pairs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">pair_id</span> <span class="op">:=</span> <span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Randomly select one unit for treatment</span></span>
<span>  <span class="va">treated_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">pairs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">dt_matched</span><span class="op">[</span><span class="va">id</span> <span class="op">==</span> <span class="va">treated_id</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Handle leftover unit if exists</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">unpaired_idx</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">leftover_id</span> <span class="op">&lt;-</span> <span class="va">original_ids</span><span class="op">[</span><span class="va">unpaired_idx</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Assign to a special "pair" ID</span></span>
<span>  <span class="va">dt_matched</span><span class="op">[</span><span class="va">id</span> <span class="op">==</span> <span class="va">leftover_id</span>, <span class="va">pair_id</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pairs</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Randomly assign to treatment or control</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dt_matched</span><span class="op">[</span><span class="va">id</span> <span class="op">==</span> <span class="va">leftover_id</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Verify pair assignments</span></span>
<span><span class="va">pair_counts</span> <span class="op">&lt;-</span> <span class="va">dt_matched</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">pair_id</span><span class="op">)</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">pair_id</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nVerifying pair assignments:\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Verifying pair assignments:</code></pre>
</div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Number of unique pairs:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pair_counts</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of unique pairs: 500 </code></pre>
</div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Distribution of pair sizes:\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distribution of pair sizes:</code></pre>
</div>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pair_counts</span><span class="op">$</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  2 
500 </code></pre>
</div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Check treatment balance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nTreatment balance:\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Treatment balance:</code></pre>
</div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Treatment group size:"</span>, <span class="va">dt_matched</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">.N</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Treatment group size: 500 </code></pre>
</div>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Control group size:"</span>, <span class="va">dt_matched</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">.N</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Control group size: 500 </code></pre>
</div>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Display the first 10 pairs, sorted by pair_id</span></span>
<span><span class="va">dt_matched</span><span class="op">[</span><span class="va">pair_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">pair_id</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span><span class="va">id</span>, <span class="va">pair_id</span>, <span class="va">treatment</span>, <span class="va">age</span>, <span class="va">education</span>, <span class="va">income</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id pair_id treatment   age education   income
    &lt;int&gt;   &lt;int&gt;     &lt;num&gt; &lt;int&gt;    &lt;fctr&gt;    &lt;num&gt;
 1:     1       1         1    19 Secondary 15381.84
 2:   314       1         0    19      None 15029.52
 3:     2       2         1    34 Secondary 38849.92
 4:   377       2         0    33   Primary 35934.18
 5:     3       3         0    62 Secondary 10788.07
 6:   241       3         1    62 Secondary  9877.48
 7:     4       4         0    45   Primary 42118.52
 8:   449       4         1    45 Secondary 40293.28
 9:     5       5         1    44    Higher 17465.41
10:   846       5         0    44   Primary 17352.46
11:     6       6         0    74 Secondary 18718.60
12:   760       6         1    74 Secondary 18864.18
13:     7       7         0    40 Secondary 13593.29
14:   308       7         1    40 Secondary 15251.64
15:     8       8         1    24   Primary 21565.13
16:   468       8         0    24   Primary 22107.18
17:     9       9         1    36 Secondary 22274.83
18:   660       9         0    36    Higher 23510.64
19:    10      10         1    34 Secondary  9627.04
20:   490      10         0    34    Higher  9721.55
       id pair_id treatment   age education   income</code></pre>
</div>
</div>
<section id="advantages-and-limitations" class="level3"><h3 class="anchored" data-anchor-id="advantages-and-limitations">Advantages and Limitations</h3>
<p><strong>Advantages:</strong> - Achieves excellent balance on matching variables - Works well with continuous covariates - Reduces variance in treatment effect estimates</p>
<p><strong>Limitations:</strong> - Finding good matches becomes difficult with many covariates - May discard units that can’t be well-matched - Requires all baseline data before randomization - Analysis must account for pairing structure</p>
</section></section><section id="verifying-balance-approaches-and-best-practices" class="level2"><h2 class="anchored" data-anchor-id="verifying-balance-approaches-and-best-practices">Verifying Balance: Approaches and Best Practices</h2>
<p>After randomization, it’s crucial to verify that balance between the treatment and control group was achieved. Several approaches exist:</p>
<ul>
<li>Individual Covariate Tests: Test balance one-by-one</li>
<li>Joint Omnibus Test: Test that all covariates are jointly balanced (often combined with tests on each covariate)</li>
<li>Regression-Based Tests: Regress treatment assignment on each covariate. Also allows you to control for strata or matched pair fixed effects.</li>
</ul>
<section id="individual-covariate-tests" class="level3"><h3 class="anchored" data-anchor-id="individual-covariate-tests">Individual Covariate Tests</h3>
<p>The most common approach is to test each covariate separately: - t-tests for continuous variables - Chi-square tests for categorical variables</p>
<p>Let’s demonstrate this with data from the strata randomization example.</p>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># List of all baseline covariates to test</span></span>
<span><span class="va">baseline_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"education"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to perform t-tests and create a formatted results table</span></span>
<span><span class="va">run_ttests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    p_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">var</span> <span class="kw">in</span> <span class="va">baseline_vars</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># For categorical variables (factor), we need to handle differently</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># For each level of the factor</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">level</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Create temporary binary indicator</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">==</span> <span class="va">level</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="co"># Calculate means</span></span>
<span>        <span class="va">mean_control</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="va">mean_treated</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="co"># Run t-test</span></span>
<span>        <span class="va">t_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">temp</span><span class="op">]</span>, </span>
<span>                           <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">temp</span><span class="op">]</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Add to results</span></span>
<span>        <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">": "</span>, <span class="va">level</span><span class="op">)</span>,</span>
<span>          method <span class="op">=</span> <span class="va">title</span>,</span>
<span>          mean_control <span class="op">=</span> <span class="va">mean_control</span>,</span>
<span>          mean_treated <span class="op">=</span> <span class="va">mean_treated</span>,</span>
<span>          diff <span class="op">=</span> <span class="va">mean_treated</span> <span class="op">-</span> <span class="va">mean_control</span>,</span>
<span>          p_value <span class="op">=</span> <span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>          significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Remove temporary variable</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># For continuous and binary variables</span></span>
<span>      <span class="va">mean_control</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="va">mean_treated</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="co"># Run t-test</span></span>
<span>      <span class="va">t_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span></span>
<span>        <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">]</span>, </span>
<span>        <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Add to results</span></span>
<span>      <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>        variable <span class="op">=</span> <span class="va">var</span>,</span>
<span>        method <span class="op">=</span> <span class="va">title</span>,</span>
<span>        mean_control <span class="op">=</span> <span class="va">mean_control</span>,</span>
<span>        mean_treated <span class="op">=</span> <span class="va">mean_treated</span>,</span>
<span>        diff <span class="op">=</span> <span class="va">mean_treated</span> <span class="op">-</span> <span class="va">mean_control</span>,</span>
<span>        p_value <span class="op">=</span> <span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>        significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">t_result</span><span class="op">$</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run t-tests for all randomization methods</span></span>
<span><span class="va">ttest_strat</span> <span class="op">&lt;-</span> <span class="fu">run_ttests</span><span class="op">(</span><span class="va">dt_strat</span>, <span class="st">"Stratified - t-test"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Display Result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="joint-omnibus-tests" class="level3"><h3 class="anchored" data-anchor-id="joint-omnibus-tests">Joint Omnibus Tests</h3>
<p>F-tests can test multiple covariates simultaneously, reducing the multiple testing problem.</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to perform F-test</span></span>
<span><span class="va">joint_balance_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Regress treatment on covariates</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">female</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">chronic_disease</span>, </span>
<span>              data <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract F-statistic and p-value for joint significance</span></span>
<span>  <span class="va">f_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">fstatistic</span></span>
<span>  <span class="va">f_value</span> <span class="op">&lt;-</span> <span class="va">f_test</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">df1</span> <span class="op">&lt;-</span> <span class="va">f_test</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">df2</span> <span class="op">&lt;-</span> <span class="va">f_test</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">p_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">pf</a></span><span class="op">(</span><span class="va">f_value</span>, <span class="va">df1</span>, <span class="va">df2</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>    f_value <span class="op">=</span> <span class="va">f_value</span>,</span>
<span>    df1 <span class="op">=</span> <span class="va">df1</span>,</span>
<span>    df2 <span class="op">=</span> <span class="va">df2</span>,</span>
<span>    p_value <span class="op">=</span> <span class="va">p_value</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run joint test</span></span>
<span><span class="va">joint_test</span> <span class="op">&lt;-</span> <span class="fu">joint_balance_test</span><span class="op">(</span><span class="va">dt_strat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Joint balance test (F-test):\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Joint balance test (F-test):</code></pre>
</div>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"F("</span>, <span class="va">joint_test</span><span class="op">$</span><span class="va">df1</span>, <span class="st">","</span>, <span class="va">joint_test</span><span class="op">$</span><span class="va">df2</span>, <span class="st">") = "</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">joint_test</span><span class="op">$</span><span class="va">f_value</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">", p = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">joint_test</span><span class="op">$</span><span class="va">p_value</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>F(7,992) = 0.49, p = 0.841</code></pre>
</div>
</div>
</section><section id="regression-based-tests" class="level3"><h3 class="anchored" data-anchor-id="regression-based-tests">Regression-Based Tests</h3>
<p>Regress treatment assignment on each covariate; if randomization worked, coefficients should be insignificant.</p>
<p>Again, we’ll use the data created for the stratified randomization example. First, let’s look at this approach not controlling for strata fixed effects:</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span> <span class="co"># For fixed effects</span></span>
<span></span>
<span><span class="co"># Function to perform OLS regressions without strata fixed effects</span></span>
<span><span class="va">run_ols_no_strata</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    coefficient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    std_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    p_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">var</span> <span class="kw">in</span> <span class="va">baseline_vars</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Handle factor variables</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Create one-hot encoding</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">level</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># Skip first level (reference)</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">==</span> <span class="va">level</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="co"># Run regression</span></span>
<span>        <span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">~</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Add to results</span></span>
<span>        <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">": "</span>, <span class="va">level</span>, <span class="st">" vs "</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>          method <span class="op">=</span> <span class="va">title</span>,</span>
<span>          coefficient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>          std_error <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">se</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>          p_value <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>          significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Remove temporary variable</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># For continuous and binary variables</span></span>
<span>      <span class="va">formula_str</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">" ~ treatment"</span><span class="op">)</span></span>
<span>      <span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">formula_str</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Add to results</span></span>
<span>      <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>        variable <span class="op">=</span> <span class="va">var</span>,</span>
<span>        method <span class="op">=</span> <span class="va">title</span>,</span>
<span>        coefficient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>        std_error <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">se</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>        p_value <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>        significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run OLS without strata for both randomization methods</span></span>
<span><span class="va">ols_strat</span> <span class="op">&lt;-</span> <span class="fu">run_ols_no_strata</span><span class="op">(</span><span class="va">dt_strat</span>, <span class="st">"Stratified  - OLS no Strata FE"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ols_strat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       variable                         method   coefficient
                         &lt;char&gt;                         &lt;char&gt;         &lt;num&gt;
1:                          age Stratified  - OLS no Strata FE  2.221876e-01
2:   education: Primary vs None Stratified  - OLS no Strata FE -2.528040e-03
3: education: Secondary vs None Stratified  - OLS no Strata FE  2.920047e-03
4:    education: Higher vs None Stratified  - OLS no Strata FE -1.504024e-03
5:                       female Stratified  - OLS no Strata FE -3.471256e-02
6:                       income Stratified  - OLS no Strata FE  1.481540e+03
7:                        rural Stratified  - OLS no Strata FE  1.477624e-02
8:              chronic_disease Stratified  - OLS no Strata FE -4.050465e-02
9:                 satisfaction Stratified  - OLS no Strata FE  4.446471e-02
      std_error   p_value significant
          &lt;num&gt;     &lt;num&gt;      &lt;char&gt;
1: 1.160745e+00 0.8482370            
2: 2.943325e-02 0.9315706            
3: 3.080592e-02 0.9245019            
4: 2.473571e-02 0.9515277            
5: 3.112980e-02 0.2650800            
6: 2.873209e+03 0.6062205            
7: 3.104979e-02 0.6342580            
8: 2.932947e-02 0.1675812            
9: 7.016046e-02 0.5263844            </code></pre>
</div>
</div>
<p>These should be very close to the t-tests above.</p>
<p>Now let’s do this controlling for strata. The reason we’d want to do this is because, as we’ll see later, we need to estimate the treatment effect following the way the randomization was done, period. In other words, these need to be aligned. So, if we want to test our balance on baseline covariates, estimate the treatment effect once we have the endline data, it makes sense to include strata fixed effects here.</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to perform OLS regressions with strata fixed effects</span></span>
<span><span class="va">run_ols_with_strata</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    coefficient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    std_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    p_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">var</span> <span class="kw">in</span> <span class="va">baseline_vars</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Handle factor variables</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">level</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># Skip first level (reference)</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">==</span> <span class="va">level</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="co"># Run regression with strata fixed effects</span></span>
<span>        <span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">|</span> <span class="va">strata</span>, data <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Add to results</span></span>
<span>        <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">": "</span>, <span class="va">level</span>, <span class="st">" vs "</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>          method <span class="op">=</span> <span class="va">title</span>,</span>
<span>          coefficient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>          std_error <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">se</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>          p_value <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>          significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Remove temporary variable</span></span>
<span>        <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># For continuous and binary variables</span></span>
<span>      <span class="va">formula_str</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">" ~ treatment | strata"</span><span class="op">)</span></span>
<span>      <span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">formula_str</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Add to results</span></span>
<span>      <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>        variable <span class="op">=</span> <span class="va">var</span>,</span>
<span>        method <span class="op">=</span> <span class="va">title</span>,</span>
<span>        coefficient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>        std_error <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">se</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>        p_value <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>,</span>
<span>        significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coeftable.html">pvalue</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run OLS with strata/pair fixed effects</span></span>
<span><span class="va">ols_strat_fe</span> <span class="op">&lt;-</span> <span class="fu">run_ols_with_strata</span><span class="op">(</span><span class="va">dt_strat</span>, <span class="st">"Stratified - OLS with strata FE"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ols_strat_fe</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       variable                          method   coefficient
                         &lt;char&gt;                          &lt;char&gt;         &lt;num&gt;
1:                          age Stratified - OLS with strata FE    0.11773106
2:   education: Primary vs None Stratified - OLS with strata FE    0.00000000
3: education: Secondary vs None Stratified - OLS with strata FE    0.00000000
4:    education: Higher vs None Stratified - OLS with strata FE    0.00000000
5:                       female Stratified - OLS with strata FE   -0.03450692
6:                       income Stratified - OLS with strata FE 1478.11717275
7:                        rural Stratified - OLS with strata FE    0.01458971
8:              chronic_disease Stratified - OLS with strata FE   -0.04085313
9:                 satisfaction Stratified - OLS with strata FE    0.04348112
      std_error   p_value significant
          &lt;num&gt;     &lt;num&gt;      &lt;char&gt;
1: 2.273435e-01 0.6105367            
2:          NaN        NA        &lt;NA&gt;
3:          NaN        NA        &lt;NA&gt;
4:          NaN        NA        &lt;NA&gt;
5: 2.982420e-02 0.2616078            
6: 2.687661e+03 0.5887514            
7: 2.894125e-02 0.6199764            
8: 2.597797e-02 0.1323144            
9: 8.089327e-02 0.5971538            </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice the regressions for education variables are not computing. Why do you think this is?</p>
</div>
</div>
</section><section id="standardized-differences" class="level3"><h3 class="anchored" data-anchor-id="standardized-differences">Standardized Differences</h3>
<p>For large samples, p-values become less informative as tiny imbalances become statistically significant. Standardized mean differences (SMDs) provide a sample size-independent measure:</p>
<p><span class="math display">\[SMD = \frac{\bar{X}_{treatment} - \bar{X}_{control}}{\sqrt{\frac{s^2_{treatment} + s^2_{control}}{2}}}\]</span></p>
<p>A common rule of thumb is that an absolute SMD less than 0.1 indicates negligible imbalance.</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate standardized differences </span></span>
<span><span class="va">standardized_diff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">covariates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span>, <span class="st">"female"</span>, <span class="st">"chronic_disease"</span><span class="op">)</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>    covariate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    sd_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    sd_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    std_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">cov</span> <span class="kw">in</span> <span class="va">covariates</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Calculate means and SDs by group</span></span>
<span>    <span class="va">treated</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span><span class="op">]</span>  <span class="co"># Use get() to retrieve column dynamically</span></span>
<span>    <span class="va">control</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span><span class="op">]</span>  <span class="co"># Use get() to retrieve column dynamically</span></span>
<span>    </span>
<span>    <span class="va">mean_treated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">treated</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">mean_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">control</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">sd_treated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">treated</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">sd_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">control</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Calculate standardized difference</span></span>
<span>    <span class="va">pooled_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">sd_treated</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">sd_control</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">std_diff</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">mean_treated</span> <span class="op">-</span> <span class="va">mean_control</span><span class="op">)</span> <span class="op">/</span> <span class="va">pooled_sd</span></span>
<span>    </span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>      covariate <span class="op">=</span> <span class="va">cov</span>,</span>
<span>      mean_treated <span class="op">=</span> <span class="va">mean_treated</span>,</span>
<span>      mean_control <span class="op">=</span> <span class="va">mean_control</span>,</span>
<span>      sd_treated <span class="op">=</span> <span class="va">sd_treated</span>,</span>
<span>      sd_control <span class="op">=</span> <span class="va">sd_control</span>,</span>
<span>      std_diff <span class="op">=</span> <span class="va">std_diff</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Handle education separately (categorical variable)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"education"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># For each level of education</span></span>
<span>    <span class="va">edu_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">education</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">level</span> <span class="kw">in</span> <span class="va">edu_levels</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Create indicator for this level</span></span>
<span>      <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">education</span> <span class="op">==</span> <span class="va">level</span><span class="op">)</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="co"># Calculate means by group</span></span>
<span>      <span class="va">treated</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="va">control</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="co"># For proportions, the SD is sqrt(p*(1-p))</span></span>
<span>      <span class="va">sd_treated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">treated</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">treated</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">sd_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">control</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">control</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Calculate standardized difference</span></span>
<span>      <span class="va">pooled_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">sd_treated</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">sd_control</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="co"># Avoid division by zero</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">pooled_sd</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">std_diff</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">std_diff</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">treated</span> <span class="op">-</span> <span class="va">control</span><span class="op">)</span> <span class="op">/</span> <span class="va">pooled_sd</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>        covariate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"education: "</span>, <span class="va">level</span><span class="op">)</span>,</span>
<span>        mean_treated <span class="op">=</span> <span class="va">treated</span>,</span>
<span>        mean_control <span class="op">=</span> <span class="va">control</span>,</span>
<span>        sd_treated <span class="op">=</span> <span class="va">sd_treated</span>,</span>
<span>        sd_control <span class="op">=</span> <span class="va">sd_control</span>,</span>
<span>        std_diff <span class="op">=</span> <span class="va">std_diff</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Remove temporary variable</span></span>
<span>      <span class="va">dt</span><span class="op">[</span>, <span class="va">temp</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Calculate standardized differences</span></span>
<span><span class="va">std_diffs</span> <span class="op">&lt;-</span> <span class="fu">standardized_diff</span><span class="op">(</span><span class="va">dt_strat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">std_diffs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              covariate mean_treated mean_control   sd_treated   sd_control
                 &lt;char&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;
1:                  age 4.958765e+01 4.936546e+01 1.833769e+01 1.836811e+01
2:               income 3.522222e+04 3.374068e+04 4.624246e+04 4.459409e+04
3:               female 5.717131e-01 6.064257e-01 4.953241e-01 4.890335e-01
4:      chronic_disease 2.928287e-01 3.333333e-01 4.555144e-01 4.718785e-01
5:      education: None 1.115538e-01 1.104418e-01 3.148167e-01 3.134396e-01
6:   education: Primary 3.147410e-01 3.172691e-01 4.644127e-01 4.654132e-01
7: education: Secondary 3.864542e-01 3.835341e-01 4.869367e-01 4.862465e-01
8:    education: Higher 1.872510e-01 1.887550e-01 3.901129e-01 3.913139e-01
       std_diff
          &lt;num&gt;
1:  0.012106399
2:  0.032614530
3: -0.070526901
4: -0.087338046
5:  0.003540005
6: -0.005437661
7:  0.006001020
8: -0.003849426</code></pre>
</div>
</div>
</section><section id="comprehensive-table-1" class="level3"><h3 class="anchored" data-anchor-id="comprehensive-table-1">Comprehensive “Table 1”</h3>
<p>Now, let’s create a comprehensive “Table 1” for the stratified random sample</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Install and load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate standardized differences for stratified randomization</span></span>
<span><span class="va">std_diff_strat</span> <span class="op">&lt;-</span> <span class="fu">standardized_diff</span><span class="op">(</span><span class="va">dt_strat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to extract p-values from all balance tests</span></span>
<span><span class="va">extract_pvalues</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">test_results</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="va">test_results</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">variable</span>, <span class="va">p_value</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">results</span>, <span class="st">"variable"</span>, <span class="st">"covariate"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Extract p-values from different testing approaches for stratified randomization</span></span>
<span><span class="va">pvals_strat_ttest</span> <span class="op">&lt;-</span> <span class="fu">extract_pvalues</span><span class="op">(</span><span class="va">ttest_strat</span><span class="op">)</span></span>
<span><span class="va">pvals_strat_ttest</span><span class="op">[</span>, <span class="va">approach</span> <span class="op">:=</span> <span class="st">"t-test"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pvals_strat_ols</span> <span class="op">&lt;-</span> <span class="fu">extract_pvalues</span><span class="op">(</span><span class="va">ols_strat</span><span class="op">)</span></span>
<span><span class="va">pvals_strat_ols</span><span class="op">[</span>, <span class="va">approach</span> <span class="op">:=</span> <span class="st">"OLS (no strata FE)"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pvals_strat_ols_fe</span> <span class="op">&lt;-</span> <span class="fu">extract_pvalues</span><span class="op">(</span><span class="va">ols_strat_fe</span><span class="op">)</span></span>
<span><span class="va">pvals_strat_ols_fe</span><span class="op">[</span>, <span class="va">approach</span> <span class="op">:=</span> <span class="st">"OLS (with strata FE)"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Combine all p-values for stratified randomization</span></span>
<span><span class="va">strat_pvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">pvals_strat_ttest</span>,</span>
<span>  <span class="va">pvals_strat_ols</span>,</span>
<span>  <span class="va">pvals_strat_ols_fe</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a wide format of p-values</span></span>
<span><span class="va">pvals_wide</span> <span class="op">&lt;-</span> <span class="va">strat_pvals</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    id_cols <span class="op">=</span> <span class="va">covariate</span>,</span>
<span>    names_from <span class="op">=</span> <span class="va">approach</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">p_value</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Join with standardized differences</span></span>
<span><span class="va">strat_balance_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span></span>
<span>  <span class="va">std_diff_strat</span>, </span>
<span>  <span class="va">pvals_wide</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"covariate"</span>, </span>
<span>  all <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark significant values with asterisks directly in the data</span></span>
<span><span class="va">strat_balance_table</span> <span class="op">&lt;-</span> <span class="va">strat_balance_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    std_diff_mark <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">std_diff</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.25</span>, </span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">std_diff</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span>, <span class="st">"†"</span><span class="op">)</span>, </span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">std_diff</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    `t-test_mark` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">`t-test`</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, </span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">`t-test`</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span>, <span class="st">"*"</span><span class="op">)</span>, </span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">`t-test`</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    `OLS (no strata FE)_mark` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">`OLS (no strata FE)`</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">`OLS (no strata FE)`</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span>, <span class="st">"*"</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">`OLS (no strata FE)`</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    `OLS (with strata FE)_mark` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">`OLS (with strata FE)`</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, </span>
<span>                                        <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">`OLS (with strata FE)`</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span>, <span class="st">"*"</span><span class="op">)</span>, </span>
<span>                                        <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">`OLS (with strata FE)`</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create gt table with the marked columns</span></span>
<span><span class="va">strat_balance_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">covariate</span>, <span class="va">std_diff_mark</span>, <span class="va">`t-test_mark`</span>, <span class="va">`OLS (no strata FE)_mark`</span>, <span class="va">`OLS (with strata FE)_mark`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Rename columns</span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span></span>
<span>    covariate <span class="op">=</span> <span class="st">"Baseline Covariate"</span>,</span>
<span>    std_diff_mark <span class="op">=</span> <span class="st">"Standardized Difference"</span>,</span>
<span>    `t-test_mark` <span class="op">=</span> <span class="st">"t-test"</span>,</span>
<span>    `OLS (no strata FE)_mark` <span class="op">=</span> <span class="st">"OLS (standard)"</span>,</span>
<span>    `OLS (with strata FE)_mark` <span class="op">=</span> <span class="st">"OLS (with strata FE)"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add column spanners for organization</span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Balance Measure"</span>,</span>
<span>    columns <span class="op">=</span> <span class="st">"std_diff_mark"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"P-values by Testing Approach"</span>,</span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t-test_mark"</span>, <span class="st">"OLS (no strata FE)_mark"</span>, <span class="st">"OLS (with strata FE)_mark"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add title and footnotes</span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Table 1: Balance Assessment in Stratified Randomization"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Comparison of Different Testing Approaches"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op">(</span></span>
<span>    footnote <span class="op">=</span> <span class="st">"† Standardized differences &gt;0.25, indicating potential imbalance."</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_column_labels.html">cells_column_labels</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"std_diff_mark"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op">(</span></span>
<span>    footnote <span class="op">=</span> <span class="st">"* P-values &lt;0.05, indicating statistically significant differences."</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_column_spanners.html">cells_column_spanners</a></span><span class="op">(</span>spanners <span class="op">=</span> <span class="st">"P-values by Testing Approach"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op">(</span></span>
<span>    footnote <span class="op">=</span> <span class="st">"OLS with strata fixed effects is the most appropriate approach given the stratified design."</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_column_labels.html">cells_column_labels</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"OLS (with strata FE)_mark"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Nicer formatting</span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op">(</span></span>
<span>    column_labels.font.weight <span class="op">=</span> <span class="st">"bold"</span>,</span>
<span>    column_labels.background.color <span class="op">=</span> <span class="st">"#EEEEEE"</span>,</span>
<span>    table.width <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/pct.html">pct</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>    heading.background.color <span class="op">=</span> <span class="st">"#E6F0FF"</span>,</span>
<span>    heading.title.font.size <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/px.html">px</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span>,</span>
<span>    heading.subtitle.font.size <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/px.html">px</a></span><span class="op">(</span><span class="fl">14</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="pmtmutpmmk" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#pmtmutpmmk table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#pmtmutpmmk thead, #pmtmutpmmk tbody, #pmtmutpmmk tfoot, #pmtmutpmmk tr, #pmtmutpmmk td, #pmtmutpmmk th {
  border-style: none;
}

#pmtmutpmmk p {
  margin: 0;
  padding: 0;
}

#pmtmutpmmk .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: 100%;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#pmtmutpmmk .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#pmtmutpmmk .gt_title {
  color: #333333;
  font-size: 16px;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#pmtmutpmmk .gt_subtitle {
  color: #333333;
  font-size: 14px;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#pmtmutpmmk .gt_heading {
  background-color: #E6F0FF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pmtmutpmmk .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pmtmutpmmk .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pmtmutpmmk .gt_col_heading {
  color: #333333;
  background-color: #EEEEEE;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#pmtmutpmmk .gt_column_spanner_outer {
  color: #333333;
  background-color: #EEEEEE;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#pmtmutpmmk .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#pmtmutpmmk .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#pmtmutpmmk .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#pmtmutpmmk .gt_spanner_row {
  border-bottom-style: hidden;
}

#pmtmutpmmk .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#pmtmutpmmk .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#pmtmutpmmk .gt_from_md > :first-child {
  margin-top: 0;
}

#pmtmutpmmk .gt_from_md > :last-child {
  margin-bottom: 0;
}

#pmtmutpmmk .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#pmtmutpmmk .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#pmtmutpmmk .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#pmtmutpmmk .gt_row_group_first td {
  border-top-width: 2px;
}

#pmtmutpmmk .gt_row_group_first th {
  border-top-width: 2px;
}

#pmtmutpmmk .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pmtmutpmmk .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#pmtmutpmmk .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#pmtmutpmmk .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pmtmutpmmk .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pmtmutpmmk .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#pmtmutpmmk .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#pmtmutpmmk .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#pmtmutpmmk .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pmtmutpmmk .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pmtmutpmmk .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#pmtmutpmmk .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pmtmutpmmk .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#pmtmutpmmk .gt_left {
  text-align: left;
}

#pmtmutpmmk .gt_center {
  text-align: center;
}

#pmtmutpmmk .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#pmtmutpmmk .gt_font_normal {
  font-weight: normal;
}

#pmtmutpmmk .gt_font_bold {
  font-weight: bold;
}

#pmtmutpmmk .gt_font_italic {
  font-style: italic;
}

#pmtmutpmmk .gt_super {
  font-size: 65%;
}

#pmtmutpmmk .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#pmtmutpmmk .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#pmtmutpmmk .gt_indent_1 {
  text-indent: 5px;
}

#pmtmutpmmk .gt_indent_2 {
  text-indent: 10px;
}

#pmtmutpmmk .gt_indent_3 {
  text-indent: 15px;
}

#pmtmutpmmk .gt_indent_4 {
  text-indent: 20px;
}

#pmtmutpmmk .gt_indent_5 {
  text-indent: 25px;
}

#pmtmutpmmk .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#pmtmutpmmk div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>
<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="gt_heading header">
<th colspan="5" class="gt_heading gt_title gt_font_normal">Table 1: Balance Assessment in Stratified Randomization</th>
</tr>
<tr class="gt_heading even">
<th colspan="5" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border">Comparison of Different Testing Approaches</th>
</tr>
<tr class="gt_col_headings gt_spanner_row header">
<th rowspan="2" id="covariate" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Baseline Covariate</th>
<th id="Balance Measure" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="col"><div class="gt_column_spanner">
Balance Measure
</div></th>
<th colspan="3" id="P-values by Testing Approach" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><div class="gt_column_spanner">
P-values by Testing Approach<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>1</sup></span>
</div></th>
</tr>
<tr class="gt_col_headings even">
<th id="std_diff_mark" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Standardized Difference<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>2</sup></span>
</th>
<th id="t-test_mark" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">t-test</th>
<th id="OLS-(no-strata-FE)_mark" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">OLS (standard)</th>
<th id="OLS-(with-strata-FE)_mark" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">OLS (with strata FE)<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>3</sup></span>
</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="covariate">age</td>
<td class="gt_row gt_right" headers="std_diff_mark">0.012</td>
<td class="gt_row gt_right" headers="t-test_mark">0.848</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.848</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">0.611</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="covariate">chronic_disease</td>
<td class="gt_row gt_right" headers="std_diff_mark">-0.087</td>
<td class="gt_row gt_right" headers="t-test_mark">0.168</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.168</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">0.132</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="covariate">education: Higher</td>
<td class="gt_row gt_right" headers="std_diff_mark">-0.004</td>
<td class="gt_row gt_right" headers="t-test_mark">0.952</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">NA</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="covariate">education: Higher vs None</td>
<td class="gt_row gt_right" headers="std_diff_mark">NA</td>
<td class="gt_row gt_right" headers="t-test_mark">NA</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.952</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">NA</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="covariate">education: None</td>
<td class="gt_row gt_right" headers="std_diff_mark">0.004</td>
<td class="gt_row gt_right" headers="t-test_mark">0.955</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">NA</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="covariate">education: Primary</td>
<td class="gt_row gt_right" headers="std_diff_mark">-0.005</td>
<td class="gt_row gt_right" headers="t-test_mark">0.932</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">NA</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">NA</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="covariate">education: Primary vs None</td>
<td class="gt_row gt_right" headers="std_diff_mark">NA</td>
<td class="gt_row gt_right" headers="t-test_mark">NA</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.932</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="covariate">education: Secondary</td>
<td class="gt_row gt_right" headers="std_diff_mark">0.006</td>
<td class="gt_row gt_right" headers="t-test_mark">0.925</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">NA</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">NA</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="covariate">education: Secondary vs None</td>
<td class="gt_row gt_right" headers="std_diff_mark">NA</td>
<td class="gt_row gt_right" headers="t-test_mark">NA</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.925</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="covariate">female</td>
<td class="gt_row gt_right" headers="std_diff_mark">-0.071</td>
<td class="gt_row gt_right" headers="t-test_mark">0.265</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.265</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">0.262</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="covariate">income</td>
<td class="gt_row gt_right" headers="std_diff_mark">0.033</td>
<td class="gt_row gt_right" headers="t-test_mark">0.606</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.606</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">0.589</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="covariate">rural</td>
<td class="gt_row gt_right" headers="std_diff_mark">NA</td>
<td class="gt_row gt_right" headers="t-test_mark">0.634</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.634</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">0.620</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="covariate">satisfaction</td>
<td class="gt_row gt_right" headers="std_diff_mark">NA</td>
<td class="gt_row gt_right" headers="t-test_mark">0.526</td>
<td class="gt_row gt_right" headers="OLS (no strata FE)_mark">0.526</td>
<td class="gt_row gt_right" headers="OLS (with strata FE)_mark">0.597</td>
</tr>
</tbody>
<tfoot class="gt_footnotes">
<tr class="odd">
<td colspan="5" class="gt_footnote">
<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>1</sup></span> * P-values &lt;0.05, indicating statistically significant differences.</td>
</tr>
<tr class="even">
<td colspan="5" class="gt_footnote">
<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>2</sup></span> † Standardized differences &gt;0.25, indicating potential imbalance.</td>
</tr>
<tr class="odd">
<td colspan="5" class="gt_footnote">
<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>3</sup></span> OLS with strata fixed effects is the most appropriate approach given the stratified design.</td>
</tr>
</tfoot>
</table>
</div>
</div>
</div>
</section><section id="interpreting-balance-results" class="level3"><h3 class="anchored" data-anchor-id="interpreting-balance-results">Interpreting Balance Results</h3>
<p>When reviewing balance tables, it’s important to consider:</p>
<ol type="1">
<li><p><strong>Statistical vs.&nbsp;Practical Significance</strong>: With large samples, even tiny differences can be statistically significant. Focus on the magnitude of differences (SMD) rather than p-values.</p></li>
<li><p><strong>Multiple Testing</strong>: With many covariates, expect some to show “significant” differences by chance. This is why joint tests and SMDs are often more informative.</p></li>
<li><p><strong>Key Predictors</strong>: Pay special attention to covariates that strongly predict outcomes. Imbalance on these variables is more concerning.</p></li>
<li><p><strong>Visual Inspection</strong>: Sometimes graphical displays of covariate distributions can complement statistical tests. Consider density plots or boxplots comparing treatment and control.</p></li>
<li><p><strong>Overall Assessment</strong>: Look at the pattern of results rather than focusing on any single test. If multiple measures suggest imbalance on important predictors, consider covariate adjustment in analysis.</p></li>
</ol>
<p>Let’s create visual assessments of balance as well:</p>
</section></section><section id="plot-the-proportion-treated-in-each-stratum" class="level1"><h1>Plot the proportion treated in each stratum</h1>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize treatment assignment by strata</span></span>
<span><span class="va">strata_summary</span> <span class="op">&lt;-</span> <span class="va">dt_strat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  count <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  n_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>,</span>
<span>  pct_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">strata</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">strata_summary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">pct_treated</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">50</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Treatment Assignment by Strata in Stratified Randomization"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Red line indicates 50% treatment assignment"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Strata ID"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Percent Treated (%)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="compare-age-distribution-by-treatment-status-for-all-randomization-methods" class="level1"><h1>Compare age distribution by treatment status for all randomization methods</h1>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dt_bern</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Age Distribution by Treatment (Bernoulli Randomization)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Treatment Status"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Age"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dt_cr</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Age Distribution by Treatment (Complete Randomization)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Treatment Status"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Age"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dt_rerand_threshold</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightpink"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Age Distribution by Treatment (Re-randomization - Threshold)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Treatment Status"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Age"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dt_rerand_optimal</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightyellow"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Age Distribution by Treatment (Re-randomization - Optimization)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Treatment Status"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Age"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dt_strat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Age Distribution by Treatment (Stratified Randomization)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Treatment Status"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Age"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dt_matched</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightsalmon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Age Distribution by Treatment (Matched Randomization)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Treatment Status"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Age"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the boxplots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-19-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-19-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-19-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="visualize-matched-pairs-first-20-pairs" class="level1"><h1>Visualize matched pairs (first 20 pairs)</h1>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Visualize matched pairs (first 20 pairs) with jittering</span></span>
<span><span class="va">sample_pairs</span> <span class="op">&lt;-</span> <span class="va">dt_matched</span><span class="op">[</span><span class="va">pair_id</span> <span class="op">&lt;=</span> <span class="fl">20</span><span class="op">]</span></span>
<span><span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">sample_pairs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">pair_id</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">age</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add jitter to horizontal position, keep vertical position exact</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitter.html">position_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span>, height <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Age within Matched Pairs (First 20 Pairs)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Pair ID"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Treatment"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span> <span class="op">=</span> <span class="st">"blue"</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Treatment"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="compare-balance-across-methods-with-a-p-value-visualization" class="level1"><h1>Compare balance across methods with a p-value visualization</h1>
<div class="cell">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ttest_strat</span> <span class="op">&lt;-</span> <span class="fu">run_ttests</span><span class="op">(</span><span class="va">dt_strat</span>, <span class="st">"Stratified - t-test"</span><span class="op">)</span></span>
<span><span class="va">ttest_rerand_threshold</span> <span class="op">&lt;-</span> <span class="fu">run_ttests</span><span class="op">(</span><span class="va">dt_rerand_threshold</span>, <span class="st">"ReRand Threshold - t-test"</span><span class="op">)</span></span>
<span><span class="va">ttest_rerand_optimal</span> <span class="op">&lt;-</span> <span class="fu">run_ttests</span><span class="op">(</span><span class="va">dt_rerand_optimal</span>, <span class="st">"ReRand Optimal - t-test"</span><span class="op">)</span></span>
<span><span class="va">ttest_matched</span> <span class="op">&lt;-</span> <span class="fu">run_ttests</span><span class="op">(</span><span class="va">dt_matched</span>, <span class="st">"Matched - t-test"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine all results</span></span>
<span><span class="va">all_ttest_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">ttest_bern</span>, <span class="va">ttest_cr</span>, <span class="va">ttest_rerand_threshold</span>, <span class="va">ttest_rerand_optimal</span>, <span class="va">ttest_strat</span>, <span class="va">ttest_matched</span><span class="op">)</span></span>
<span>                           </span>
<span><span class="va">method_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Bernoulli - t-test"</span>, </span>
<span>                  <span class="st">"Complete - t-test"</span>,</span>
<span>                  <span class="st">"ReRand Threshold - t-test"</span>, </span>
<span>                  <span class="st">"ReRand Optimal - t-test"</span>,</span>
<span>                  <span class="st">"Stratified - t-test"</span>, </span>
<span>                  <span class="st">"Matched - t-test"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">balance_viz_data</span> <span class="op">&lt;-</span> <span class="va">all_ttest_results</span><span class="op">[</span><span class="va">method</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">method_order</span>, </span>
<span>                                    <span class="fu">.</span><span class="op">(</span><span class="va">variable</span>, <span class="va">method</span>, <span class="va">p_value</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Reorder methods for better visualization</span></span>
<span><span class="va">balance_viz_data</span><span class="op">[</span>, <span class="va">method</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">method</span>, levels <span class="op">=</span> <span class="va">method_order</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">p7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">balance_viz_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">variable</span>, <span class="op">-</span><span class="va">p_value</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">p_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"red"</span>, mid <span class="op">=</span> <span class="st">"yellow"</span>, high <span class="op">=</span> <span class="st">"green"</span>, </span>
<span>                      midpoint <span class="op">=</span> <span class="fl">0.5</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">p_value</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Balance Test P-values Across Randomization Methods"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Randomization Method"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Variable"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"P-value"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p7</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="lec-2-2_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This combination of numerical metrics and visual displays provides a comprehensive assessment of balance.</p>
<section id="complex-experimental-designs" class="level2"><h2 class="anchored" data-anchor-id="complex-experimental-designs">Complex Experimental Designs</h2>
<p>Beyond the basic approaches, several complex randomization designs address specific research challenges:</p>
<section id="units-of-randomization-spillovers" class="level3"><h3 class="anchored" data-anchor-id="units-of-randomization-spillovers">Units of Randomization &amp; Spillovers</h3>
<p>A critical decision is choosing what entity (e.g.&nbsp;person or cluster) to randomize:</p>
<p><strong>Key considerations:</strong></p>
<ul>
<li>Match observational unit when possible</li>
<li>Align with treatment delivery</li>
<li>Minimize spillovers</li>
<li>Consider statistical power</li>
</ul>
<p><strong>Common units:</strong></p>
<ul>
<li>
<strong>Individual</strong>: Patients, students</li>
<li>
<strong>Cluster</strong>: Villages, clinics, schools</li>
<li>
<strong>Time periods</strong>: Days, weeks, shifts</li>
<li>
<strong>Networks</strong>: Households, peer groups</li>
</ul>
<p>The tradeoff is often between statistical power (favoring individual randomization) and internal validity (which may require cluster randomization to minimize spillovers).</p>
</section><section id="the-spillover-problem" class="level3"><h3 class="anchored" data-anchor-id="the-spillover-problem">The Spillover Problem</h3>
<p>Spillovers occur when treatment affects untreated units, through:</p>
<ul>
<li>Direct interaction between units</li>
<li>General equilibrium effects</li>
<li>Information diffusion</li>
<li>Resource competition</li>
</ul>
<p>When spillovers are a concern, randomization at a higher level (clustering) can help minimize unwanted contamination. Alternatively, a two-stage randomization design can help measure spillover effects explicitly.</p>
</section><section id="two-stage-randomization-for-measuring-spillovers" class="level3"><h3 class="anchored" data-anchor-id="two-stage-randomization-for-measuring-spillovers">Two-Stage Randomization for Measuring Spillovers</h3>
<p>This approach:</p>
<ol type="1">
<li>First randomizes clusters to high or low treatment intensity</li>
<li>Then randomizes individuals within clusters to treatment or control</li>
</ol>
<p>This design allows measurement of:</p>
<ul>
<li>Direct treatment effects</li>
<li>Within-cluster spillovers</li>
<li>Between-cluster spillovers</li>
</ul></section><section id="cluster-randomization" class="level3"><h3 class="anchored" data-anchor-id="cluster-randomization">Cluster Randomization</h3>
<p>Cluster randomization assigns groups rather than individuals to treatment conditions: (we saw this last unit)</p>
<p><strong>Examples of clusters:</strong></p>
<ul>
<li>Schools</li>
<li>Clinics</li>
<li>Villages</li>
<li>Neighborhoods</li>
</ul>
<p>The key parameter affecting statistical power is the intraclass correlation coefficient (ICC), which measures how correlated outcomes are within clusters. The design effect formula shows how clustering reduces effective sample size:</p>
<p><span class="math display">\[DE = 1 + (m-1) \times ICC\]</span></p>
<p>where <span class="math inline">\(m\)</span> is the average cluster size. A larger design effect means a larger required sample size to achieve the same power.</p>
<p>Analysis needs to account for clustering through one of:</p>
<ul>
<li>Cluster-robust standard errors</li>
<li>Mixed-effects models</li>
<li>Generalized estimating equations (GEE)</li>
</ul></section><section id="factorial-designs-testing-multiple-treatments" class="level3"><h3 class="anchored" data-anchor-id="factorial-designs-testing-multiple-treatments">Factorial Designs: Testing Multiple Treatments</h3>
<p>Factorial designs test multiple interventions simultaneously:</p>
<table class="caption-top table">
<thead><tr class="header">
<th>Intervention B</th>
<th>No Intervention A</th>
<th>Intervention A</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>No</strong></td>
<td>Control</td>
<td>A only</td>
</tr>
<tr class="even">
<td><strong>Yes</strong></td>
<td>B only</td>
<td>A and B</td>
</tr>
</tbody>
</table>
<p>This approach:</p>
<ul>
<li>Tests multiple treatments simultaneously</li>
<li>Estimates main effects AND interactions</li>
<li>Uses resources efficiently</li>
</ul>
<p>For example, with two interventions (A and B), we have four groups:</p>
<ul>
<li>No intervention (control)</li>
<li>Intervention A only</li>
<li>Intervention B only</li>
<li>Both A and B</li>
</ul>
<p>Factorial designs are particularly valuable when:</p>
<ol type="1">
<li>You want to test combinations of interventions</li>
<li>You suspect treatments might interact (enhance or interfere with each other)</li>
<li>You need to maximize efficiency with limited resources</li>
</ol>
<p>Here’s how we might implement a 2×2 factorial design in R:</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">072311</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>  <span class="co"># Total sample size</span></span>
<span></span>
<span><span class="co"># Create data table</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First randomization for factor A</span></span>
<span><span class="va">dt</span><span class="op">[</span>, <span class="va">A</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Second randomization for factor B</span></span>
<span><span class="va">dt</span><span class="op">[</span>, <span class="va">B</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Create combined treatment variable</span></span>
<span><span class="va">dt</span><span class="op">[</span>, <span class="va">treatment</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="va">A</span>, <span class="st">"B"</span>, <span class="va">B</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Check allocation</span></span>
<span><span class="va">dt</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">treatment</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treatment     N
      &lt;char&gt; &lt;int&gt;
1:      A1B1    49
2:      A0B1    51
3:      A1B0    51
4:      A0B0    49</code></pre>
</div>
</div>
</section><section id="randomized-phase-in-designs" class="level3"><h3 class="anchored" data-anchor-id="randomized-phase-in-designs">Randomized Phase-in Designs</h3>
<p>In randomized phase-in designs, all units eventually receive treatment, but the timing of treatment is randomized.</p>
<p><strong>Advantages:</strong></p>
<ul>
<li>Improves compliance since everyone gets treatment eventually</li>
<li>Works well with resource constraints</li>
<li>Offers a politically appealing compromise</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>May create anticipation effects</li>
<li>Limits long-term impact measurement</li>
<li>Eventually loses the control group</li>
</ul></section><section id="adaptive-randomization" class="level3"><h3 class="anchored" data-anchor-id="adaptive-randomization">Adaptive Randomization</h3>
<p>Adaptive designs update assignment probabilities based on accumulated data, balancing:</p>
<ul>
<li>
<strong>Exploration</strong>: Learning which treatment works best</li>
<li>
<strong>Exploitation</strong>: Assigning more units to better treatments</li>
</ul>
<p>The key *ethical** advantage is that fewer participants receive inferior treatments as evidence accumulates. We’ll cover adaptive designs in more detail in a future lecture.</p>
<p>A simple example of response-adaptive randomization might look like this:</p>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Simplified response-adaptive randomization simulation</span></span>
<span><span class="va">simulate_adaptive_randomization</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_total</span> <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                                          <span class="va">true_success_A</span> <span class="op">=</span> <span class="fl">0.3</span>, </span>
<span>                                          <span class="va">true_success_B</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Initialize data storage</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_total</span>,</span>
<span>    treatment <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    outcome <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Initial equal assignment probabilities</span></span>
<span>  <span class="va">prob_A</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span>  </span>
<span>  <span class="co"># Track successes and failures</span></span>
<span>  <span class="va">success_A</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">total_A</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">success_B</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">total_B</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  </span>
<span>  <span class="co"># Simulate sequential enrollment</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Assign treatment based on current probability</span></span>
<span>    <span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">prob_A</span>, <span class="fl">1</span><span class="op">-</span><span class="va">prob_A</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">results</span><span class="op">$</span><span class="va">treatment</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">treatment</span></span>
<span>    </span>
<span>    <span class="co"># Generate outcome based on true success rates</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">true_success_A</span><span class="op">)</span></span>
<span>      <span class="va">success_A</span> <span class="op">&lt;-</span> <span class="va">success_A</span> <span class="op">+</span> <span class="va">outcome</span></span>
<span>      <span class="va">total_A</span> <span class="op">&lt;-</span> <span class="va">total_A</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">true_success_B</span><span class="op">)</span></span>
<span>      <span class="va">success_B</span> <span class="op">&lt;-</span> <span class="va">success_B</span> <span class="op">+</span> <span class="va">outcome</span></span>
<span>      <span class="va">total_B</span> <span class="op">&lt;-</span> <span class="va">total_B</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">results</span><span class="op">$</span><span class="va">outcome</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">outcome</span></span>
<span>    </span>
<span>    <span class="co"># Update probability for next assignment using Beta prior</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&lt;</span> <span class="va">n_total</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># No need to update after last patient</span></span>
<span>      <span class="co"># Beta-Bernoulli update (adding 1 for prior)</span></span>
<span>      <span class="va">prob_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">success_A</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">total_A</span> <span class="op">-</span> <span class="va">success_A</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span></span>
<span>               <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">success_A</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">total_A</span> <span class="op">-</span> <span class="va">success_A</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">success_B</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">total_B</span> <span class="op">-</span> <span class="va">success_B</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="practical-implementation-tips" class="level2"><h2 class="anchored" data-anchor-id="practical-implementation-tips">Practical Implementation Tips</h2>
<p>Regardless of which randomization approach you choose, follow these best practices:</p>
<ol type="1">
<li>Create a single entry per randomization unit</li>
<li>Sort the file in a reproducible way</li>
<li>Set and preserve a random seed</li>
<li>Assign treatments</li>
<li>Save assignments securely</li>
<li>Test balance extensively</li>
</ol>
<p>Always document your randomization procedure thoroughly to enhance transparency and reproducibility.</p>
<p>Below is a template for implementing and documenting randomization:</p>
<div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Randomization implementation template</span></span>
<span></span>
<span><span class="co"># 1. Document parameters</span></span>
<span><span class="va">study_name</span> <span class="op">&lt;-</span> <span class="st">"My Clinical Trial"</span></span>
<span><span class="va">randomization_date</span> <span class="op">&lt;-</span> <span class="st">"2025-02-25"</span></span>
<span><span class="va">randomization_conducted_by</span> <span class="op">&lt;-</span> <span class="st">"J. Smith"</span></span>
<span><span class="va">random_seed</span> <span class="op">&lt;-</span> <span class="fl">072311</span>  <span class="co"># Document why this seed was chosen</span></span>
<span><span class="va">allocation_ratio</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>  <span class="co"># Equal allocation</span></span>
<span><span class="va">stratification_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"gender"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Set up reproducible environment</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">random_seed</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Load and prepare data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"participant_data.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Implement randomization</span></span>
<span><span class="co"># Example: stratified randomization</span></span>
<span></span>
<span></span>
<span><span class="co"># 5. Check balance</span></span>
<span><span class="co"># Generate Balance Table</span></span>
<span></span>
<span><span class="co"># 6. Save results securely</span></span>
<span><span class="co"># a) Save randomization details</span></span>
<span><span class="va">randomization_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  study_name <span class="op">=</span> <span class="va">study_name</span>,</span>
<span>  date <span class="op">=</span> <span class="va">randomization_date</span>,</span>
<span>  conducted_by <span class="op">=</span> <span class="va">randomization_conducted_by</span>,</span>
<span>  seed <span class="op">=</span> <span class="va">random_seed</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"stratified"</span>,</span>
<span>  stratification_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">stratification_variables</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">randomization_log</span>, <span class="st">"randomization_log.csv"</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># b) Save assignment data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">treatment</span>, <span class="va">stratum_id</span><span class="op">)</span>, </span>
<span>  <span class="st">"treatment_assignments.csv"</span>, </span>
<span>  row.names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># c) Save balance checks</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">balance_table</span>, <span class="st">"balance_checks.csv"</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ethical-considerations-in-randomization" class="level2"><h2 class="anchored" data-anchor-id="ethical-considerations-in-randomization">Ethical Considerations in Randomization</h2>
<p>Randomization raises several ethical considerations:</p>
<ul>
<li>
<strong>Long-term benefits</strong> vs.&nbsp;short-term resource distribution</li>
<li>
<strong>Equity</strong> in who receives potentially beneficial treatments</li>
<li>
<strong>Transparency</strong> with participants about randomization</li>
<li>
<strong>Minimizing harm</strong> from potentially ineffective interventions</li>
</ul>
<p>These issues must be carefully considered and addressed in the design phase. Specific approaches that can address ethical concerns include:</p>
<ol type="1">
<li>
<strong>Randomized phase-in designs</strong>: Ensures everyone eventually receives the intervention</li>
<li>
<strong>Adaptive randomization</strong>: Skews allocation toward better-performing treatments over time</li>
<li>
<strong>Risk-based randomization</strong>: Targets interventions toward those most likely to benefit (we’ll cover in the future if time)</li>
<li>
<strong>Minimization of control group size</strong>: Uses unequal allocation ratios to minimize the number of participants not receiving intervention (could add this consideration to optimal allocation)</li>
</ol></section><section id="conclusion-which-method-when" class="level2"><h2 class="anchored" data-anchor-id="conclusion-which-method-when">Conclusion: Which Method When?</h2>
<p>There is no one-size-fits-all approach. The best randomization strategy depends on:</p>
<ul>
<li>The research question</li>
<li>Available baseline data</li>
<li>Logistical constraints</li>
<li>Expected heterogeneity in treatment effects</li>
</ul>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 36%">
<col style="width: 38%">
</colgroup>
<thead><tr class="header">
<th>Approach</th>
<th>When to Use</th>
<th>Key Consideration</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Simple</td>
<td>Large samples</td>
<td>Simplicity</td>
</tr>
<tr class="even">
<td>Stratified</td>
<td>Strong predictors known</td>
<td>Number of strata</td>
</tr>
<tr class="odd">
<td>Matched-Pair</td>
<td>Small samples</td>
<td>Finding good matches</td>
</tr>
<tr class="even">
<td>Re-randomization</td>
<td>Balance is critical</td>
<td>Complexity of inference</td>
</tr>
<tr class="odd">
<td>Cluster</td>
<td>Group-level intervention</td>
<td>ICC and number of clusters</td>
</tr>
</tbody>
</table>
<p>The choice of randomization method should be guided by:</p>
<ol type="1">
<li>The unit of randomization (individual vs.&nbsp;cluster)</li>
<li>The importance of balance on specific variables</li>
<li>Feasibility constraints</li>
<li>Analysis plans</li>
</ol>
<p>Happy randomizing!</p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/hpm883\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb98" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Unit 2.2: Randomization Techniques"</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Sean Sylvia, Ph.D."</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> February 25, 2025</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 2</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> false</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>Building on our previous discussion of optimal experimental design where we focused on maximizing statistical power under various constraints, today we turn our attention to the art and science of randomization itself. Randomization is the cornerstone of causal inference in experimental research, enabling us to make causal claims by balancing both observable and unobservable characteristics between treatment and control groups. Whereas observational studies must rely on often-questionable assumptions about selection mechanisms, properly randomized experiments provide a foundation for causal inference that is far more credible.</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>The power of randomization comes from its ability to create groups that are, in expectation, identical on all characteristics—not just those we can observe and measure, but also on unobservable factors that might influence outcomes. This property allows us to attribute any differences in outcomes between treatment and control groups to the treatment itself, rather than to pre-existing differences between groups.</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="fu">### Theoretical Foundation: Why Randomization Works</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>Randomization works because it satisfies three essential conditions:</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Non-zero probability condition**: Each unit has a positive probability of receiving any treatment assignment.</span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Individualism**: The assignment of one unit doesn't depend on the assignments of other units.</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Unconfoundedness**: The treatment assignment is independent of potential outcomes.</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>When these conditions are met, we can write:</span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">Y_i(0)|D_i=1</span><span class="co">]</span> = E<span class="co">[</span><span class="ot">Y_i(0)|D_i=0</span><span class="co">]</span>$$</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>This equation states that the expected untreated potential outcome for those in the treatment group equals the expected untreated potential outcome for those in the control group. In other words, the groups are balanced on the counterfactual outcome we never get to observe for the treatment group. This balance on unobservables is the key to establishing causality.</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a><span class="fu">### Elements Needed for Randomization</span></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>Before discussing specific randomization methods, let's identify what's generally required to implement randomization:</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Sample of units**: The individuals, clusters, or entities to be randomized</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Allocation ratio**: The proportion of units to assign to each treatment condition</span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Randomization device**: A physical or computational mechanism to generate random assignments</span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Baseline covariates**: (For some approaches) Information on characteristics to balance across groups</span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random Sampling vs. Random Assignment</span></span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a><span class="al">![Random Sampling vs. Random Assignment](media/SamplingVRandom.png)</span>{style="float: right; margin-left: 10px; width: 300px;"}</span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>It's important to distinguish between two distinct concepts that are sometimes confused:</span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Random sampling**: The process of selecting units from a population so that each unit has a known probability of selection</span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Random assignment**: The process of allocating units to treatment conditions through a random process</span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a>Random sampling helps with external validity (generalizability), while random assignment helps with internal validity (causal inference). In many experiments, we don't have a random sample from the population, but we still randomize treatment assignment within our convenience sample.</span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a><span class="fu">### Graphical Unit Overview</span></span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart TD</span></span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a><span class="in">    %% Top nodes - conditions</span></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a><span class="in">    A["Non-zero probability condition"]:::gold</span></span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a><span class="in">    B["Individualism condition"]:::gold</span></span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a><span class="in">    C["Unconfoundedness condition"]:::gold</span></span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a><span class="in">    %% Middle node - mechanisms</span></span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph D[Classical Random Assignment Mechanisms]</span></span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a><span class="in">        F["Bernoulli Trial"]:::carolinaBlue</span></span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a><span class="in">        G["Complete Randomized\nExperiment (CRE)"]:::carolinaBlue</span></span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a><span class="in">        H["Stratified Randomization"]:::carolinaBlue</span></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a><span class="in">        I["Rerandomization"]:::carolinaBlue</span></span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a><span class="in">        J["Matched Pairs"]:::carolinaBlue</span></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph E[Complex Experimental Designs]</span></span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a><span class="in">        K["Blocking"]:::carolinaBlue</span></span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a><span class="in">        L["Covariate-adaptive Randomization"]:::carolinaBlue</span></span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a><span class="in">        M["Minimization"]:::carolinaBlue</span></span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a><span class="in">    %% Bottom node - inference</span></span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a><span class="in">    N{{"Design-conscious Inference"}}:::uncGreen</span></span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a><span class="in">    %% Connections</span></span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a><span class="in">    A --&gt; D</span></span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a><span class="in">    B --&gt; D</span></span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a><span class="in">    C --&gt; D</span></span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a><span class="in">    A --&gt; E</span></span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a><span class="in">    B --&gt; E</span></span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a><span class="in">    C --&gt; E</span></span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a><span class="in">    D --&gt; N</span></span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a><span class="in">    E --&gt; N</span></span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a><span class="in">    %% UNC Brand Colors</span></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef gold fill:#FFD100,stroke:#13294B,stroke-width:1px,color:#13294B</span></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef lightGrey fill:#F7F7F7,stroke:#13294B,stroke-width:1px,color:#13294B</span></span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef carolinaBlue fill:#4B9CD3,stroke:#13294B,stroke-width:1px,color:#FFFFFF</span></span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef uncGreen fill:#8DB434,stroke:#13294B,stroke-width:1px,color:#13294B</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a><span class="in">    %% Apply lightGrey style to subgraphs</span></span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a><span class="in">    style D fill:#F7F7F7,stroke:#13294B,stroke-width:1px,color:#13294B</span></span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a><span class="in">    style E fill:#F7F7F7,stroke:#13294B,stroke-width:1px,color:#13294B</span></span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-104"><a href="#cb98-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-105"><a href="#cb98-105" aria-hidden="true" tabindex="-1"></a><span class="fu">### Classical Assignment Mechanisms</span></span>
<span id="cb98-106"><a href="#cb98-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-107"><a href="#cb98-107" aria-hidden="true" tabindex="-1"></a>There are five primary approaches to random assignment, each with distinct advantages and disadvantages:</span>
<span id="cb98-108"><a href="#cb98-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-109"><a href="#cb98-109" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Bernoulli trials</span>
<span id="cb98-110"><a href="#cb98-110" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Complete randomization</span>
<span id="cb98-111"><a href="#cb98-111" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Re-randomization</span>
<span id="cb98-112"><a href="#cb98-112" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Stratified randomization</span>
<span id="cb98-113"><a href="#cb98-113" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>Matched-pair designs</span>
<span id="cb98-114"><a href="#cb98-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-115"><a href="#cb98-115" aria-hidden="true" tabindex="-1"></a>Let's examine each approach in detail.</span>
<span id="cb98-116"><a href="#cb98-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-117"><a href="#cb98-117" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bernoulli Trials</span></span>
<span id="cb98-118"><a href="#cb98-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-119"><a href="#cb98-119" aria-hidden="true" tabindex="-1"></a>Bernoulli trials represent the simplest approach to randomization, where each unit is assigned to treatment independently with a fixed probability. This is conceptually equivalent to flipping a coin for each participant, with heads resulting in treatment assignment and tails resulting in control assignment.</span>
<span id="cb98-120"><a href="#cb98-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-121"><a href="#cb98-121" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb98-122"><a href="#cb98-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-123"><a href="#cb98-123" aria-hidden="true" tabindex="-1"></a>Let's first create a dataset to work with:</span>
<span id="cb98-124"><a href="#cb98-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-127"><a href="#cb98-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-128"><a href="#cb98-128" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb98-129"><a href="#cb98-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-130"><a href="#cb98-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data with 1000 participants</span></span>
<span id="cb98-131"><a href="#cb98-131" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb98-132"><a href="#cb98-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-133"><a href="#cb98-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Create baseline covariates</span></span>
<span id="cb98-134"><a href="#cb98-134" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb98-135"><a href="#cb98-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ID variable</span></span>
<span id="cb98-136"><a href="#cb98-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb98-137"><a href="#cb98-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-138"><a href="#cb98-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Covariates that will be used for stratification</span></span>
<span id="cb98-139"><a href="#cb98-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">sample</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">80</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>),                   <span class="co"># Continuous </span></span>
<span id="cb98-140"><a href="#cb98-140" aria-hidden="true" tabindex="-1"></a>  <span class="at">education =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"None"</span>, <span class="st">"Primary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Higher"</span>), n, <span class="at">replace =</span> <span class="cn">TRUE</span>, </span>
<span id="cb98-141"><a href="#cb98-141" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>)),          <span class="co"># Categorical</span></span>
<span id="cb98-142"><a href="#cb98-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-143"><a href="#cb98-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Additional covariates not used for stratification</span></span>
<span id="cb98-144"><a href="#cb98-144" aria-hidden="true" tabindex="-1"></a>  <span class="at">female =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.55</span>),                              <span class="co"># Binary</span></span>
<span id="cb98-145"><a href="#cb98-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">income =</span> <span class="fu">round</span>(<span class="fu">rlnorm</span>(n, <span class="at">meanlog =</span> <span class="dv">10</span>, <span class="at">sdlog =</span> <span class="dv">1</span>), <span class="dv">2</span>),    <span class="co"># Continuous, right-skewed</span></span>
<span id="cb98-146"><a href="#cb98-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">rural =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.4</span>),                                <span class="co"># Binary</span></span>
<span id="cb98-147"><a href="#cb98-147" aria-hidden="true" tabindex="-1"></a>  <span class="at">chronic_disease =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.3</span>),                      <span class="co"># Binary</span></span>
<span id="cb98-148"><a href="#cb98-148" aria-hidden="true" tabindex="-1"></a>  <span class="at">satisfaction =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>,             <span class="co"># Ordinal 1-5 scale</span></span>
<span id="cb98-149"><a href="#cb98-149" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>))</span>
<span id="cb98-150"><a href="#cb98-150" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-151"><a href="#cb98-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-152"><a href="#cb98-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert categorical variables to factors for clearer output</span></span>
<span id="cb98-153"><a href="#cb98-153" aria-hidden="true" tabindex="-1"></a>dt[, education <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(education, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"None"</span>, <span class="st">"Primary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Higher"</span>))]</span>
<span id="cb98-154"><a href="#cb98-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-155"><a href="#cb98-155" aria-hidden="true" tabindex="-1"></a><span class="co"># View data structure</span></span>
<span id="cb98-156"><a href="#cb98-156" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Data structure:"</span>)</span>
<span id="cb98-157"><a href="#cb98-157" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(dt)</span>
<span id="cb98-158"><a href="#cb98-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-159"><a href="#cb98-159" aria-hidden="true" tabindex="-1"></a><span class="co"># View the first 10 observations</span></span>
<span id="cb98-160"><a href="#cb98-160" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt)</span>
<span id="cb98-161"><a href="#cb98-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-162"><a href="#cb98-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-163"><a href="#cb98-163" aria-hidden="true" tabindex="-1"></a>Now let's randomize using Bernoulli:</span>
<span id="cb98-164"><a href="#cb98-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-167"><a href="#cb98-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-168"><a href="#cb98-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a copy of the data (so we can compare to other randomization methods below)</span></span>
<span id="cb98-169"><a href="#cb98-169" aria-hidden="true" tabindex="-1"></a>dt_bern <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb98-170"><a href="#cb98-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-171"><a href="#cb98-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Bernoulli trial example</span></span>
<span id="cb98-172"><a href="#cb98-172" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">072111</span>)</span>
<span id="cb98-173"><a href="#cb98-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-174"><a href="#cb98-174" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fl">0.5</span>  <span class="co"># Probability of treatment assignment</span></span>
<span id="cb98-175"><a href="#cb98-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-176"><a href="#cb98-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Independent random assignment</span></span>
<span id="cb98-177"><a href="#cb98-177" aria-hidden="true" tabindex="-1"></a>dt_bern[, treatment <span class="sc">:</span><span class="er">=</span> <span class="fu">rbinom</span>(.N, <span class="dv">1</span>, p)]</span>
<span id="cb98-178"><a href="#cb98-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-179"><a href="#cb98-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Check resulting allocation</span></span>
<span id="cb98-180"><a href="#cb98-180" aria-hidden="true" tabindex="-1"></a>dt_bern[, .N, by <span class="ot">=</span> treatment]</span>
<span id="cb98-181"><a href="#cb98-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-182"><a href="#cb98-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-183"><a href="#cb98-183" aria-hidden="true" tabindex="-1"></a><span class="fu">### Advantages and Disadvantages</span></span>
<span id="cb98-184"><a href="#cb98-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-185"><a href="#cb98-185" aria-hidden="true" tabindex="-1"></a>**Advantages:**</span>
<span id="cb98-186"><a href="#cb98-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-187"><a href="#cb98-187" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Simple to implement</span>
<span id="cb98-188"><a href="#cb98-188" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Can randomize as participants arrive (no need to know full sample in advance)</span>
<span id="cb98-189"><a href="#cb98-189" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>No baseline data needed</span>
<span id="cb98-190"><a href="#cb98-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-191"><a href="#cb98-191" aria-hidden="true" tabindex="-1"></a>**Disadvantages:** - Random group sizes (can result in imbalanced treatment allocation) - Potential imbalance on key covariates - Vulnerable to implementation problems</span>
<span id="cb98-192"><a href="#cb98-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-193"><a href="#cb98-193" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case Study: The Canadian National Breast Screening Study</span></span>
<span id="cb98-194"><a href="#cb98-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-195"><a href="#cb98-195" aria-hidden="true" tabindex="-1"></a>The Canadian National Breast Screening Study (CNBSS) provides a cautionary tale about vulnerabilities in Bernoulli-type randomization. This major randomized trial evaluated the effectiveness of mammography screening for breast cancer in the 1980s.</span>
<span id="cb98-196"><a href="#cb98-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-197"><a href="#cb98-197" aria-hidden="true" tabindex="-1"></a>The study used a variant of simple alternating assignment—assigning the first woman to treatment, the second to control, and so on. However, several critical flaws emerged:</span>
<span id="cb98-198"><a href="#cb98-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-199"><a href="#cb98-199" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Pre-randomization examination**: Women received clinical breast exams before randomization, providing information that could influence assignment</span>
<span id="cb98-200"><a href="#cb98-200" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Knowledge of the assignment schedule**: Staff knew that assignments alternated, creating opportunities for manipulation</span>
<span id="cb98-201"><a href="#cb98-201" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Inadequate concealment**: Study coordinators could see which group the next woman would be assigned to</span>
<span id="cb98-202"><a href="#cb98-202" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Evidence of manipulation**: Later audits found names overwritten, identities reversed, and lines skipped in assignment ledgers</span>
<span id="cb98-203"><a href="#cb98-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-204"><a href="#cb98-204" aria-hidden="true" tabindex="-1"></a>The consequences were severe: women with palpable lumps were disproportionately assigned to the mammography group, creating a significant selection bias. The mammography group had a 68% higher incidence of advanced cancers at baseline! This likely masked any potential benefits of screening, as the study ultimately reported no mortality benefit from mammography.<span class="sc">\[</span>\^1<span class="sc">\]</span></span>
<span id="cb98-205"><a href="#cb98-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-206"><a href="#cb98-206" aria-hidden="true" tabindex="-1"></a>This case highlights how vulnerable simple randomization schemes can be to manipulation, especially when those implementing the study have preferences about treatment assignment or when the randomization process is transparent and predictable. Note that there is nothing wrong with Bernoulli trials, but you should carefully consider how to impelment randomization to preserve the integrity of the randomization process. Especially when working with partner organizations (which we do all the time in health services research), one needs to work with these partners to devise a randomization protocol that fits their existing workflow but protects the randomization process.</span>
<span id="cb98-207"><a href="#cb98-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-208"><a href="#cb98-208" aria-hidden="true" tabindex="-1"></a><span class="fu">## Complete Randomization</span></span>
<span id="cb98-209"><a href="#cb98-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-210"><a href="#cb98-210" aria-hidden="true" tabindex="-1"></a>Complete randomization addresses some of the limitations of Bernoulli trials by fixing the number of units assigned to each treatment condition, ensuring the desired allocation ratio is achieved exactly.</span>
<span id="cb98-211"><a href="#cb98-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-212"><a href="#cb98-212" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb98-213"><a href="#cb98-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-216"><a href="#cb98-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-217"><a href="#cb98-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy data</span></span>
<span id="cb98-218"><a href="#cb98-218" aria-hidden="true" tabindex="-1"></a>dt_cr <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb98-219"><a href="#cb98-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-220"><a href="#cb98-220" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">072111</span>)  <span class="co"># Set seed for reproducibility</span></span>
<span id="cb98-221"><a href="#cb98-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-222"><a href="#cb98-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb98-223"><a href="#cb98-223" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fl">0.5</span>          <span class="co"># Proportion to assign to treatment</span></span>
<span id="cb98-224"><a href="#cb98-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-225"><a href="#cb98-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a column with uniform random numbers from 0 to 1.</span></span>
<span id="cb98-226"><a href="#cb98-226" aria-hidden="true" tabindex="-1"></a>dt_cr[, random_num <span class="sc">:</span><span class="er">=</span> <span class="fu">runif</span>(.N, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)]</span>
<span id="cb98-227"><a href="#cb98-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-228"><a href="#cb98-228" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by random number</span></span>
<span id="cb98-229"><a href="#cb98-229" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(dt_cr, random_num)</span>
<span id="cb98-230"><a href="#cb98-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-231"><a href="#cb98-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign first p% to treatment</span></span>
<span id="cb98-232"><a href="#cb98-232" aria-hidden="true" tabindex="-1"></a>dt_cr[, treatment <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb98-233"><a href="#cb98-233" aria-hidden="true" tabindex="-1"></a>dt_cr[<span class="dv">1</span><span class="sc">:</span>(.N<span class="sc">*</span>p), treatment <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span>]</span>
<span id="cb98-234"><a href="#cb98-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-235"><a href="#cb98-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Check resulting allocation</span></span>
<span id="cb98-236"><a href="#cb98-236" aria-hidden="true" tabindex="-1"></a>dt_cr[, .N, by <span class="ot">=</span> treatment]</span>
<span id="cb98-237"><a href="#cb98-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-238"><a href="#cb98-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-239"><a href="#cb98-239" aria-hidden="true" tabindex="-1"></a>In complete randomization, we first determine exactly how many units will receive each treatment. Then we generate a random ordering of all units and assign the first $N_p$ units to treatment and the remaining $N_0$ units to control.</span>
<span id="cb98-240"><a href="#cb98-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-241"><a href="#cb98-241" aria-hidden="true" tabindex="-1"></a><span class="fu">### Advantages and Disadvantages</span></span>
<span id="cb98-242"><a href="#cb98-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-243"><a href="#cb98-243" aria-hidden="true" tabindex="-1"></a>**Advantages:**</span>
<span id="cb98-244"><a href="#cb98-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-245"><a href="#cb98-245" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Guarantees exactly the desired allocation ratio</span>
<span id="cb98-246"><a href="#cb98-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-247"><a href="#cb98-247" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Avoids power loss from uneven group sizes - Still relatively simple to implement</span>
<span id="cb98-248"><a href="#cb98-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-249"><a href="#cb98-249" aria-hidden="true" tabindex="-1"></a>**Disadvantages:**</span>
<span id="cb98-250"><a href="#cb98-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-251"><a href="#cb98-251" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Requires knowing the full sample in advance</span>
<span id="cb98-252"><a href="#cb98-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-253"><a href="#cb98-253" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Still subject to chance imbalance on covariates</span>
<span id="cb98-254"><a href="#cb98-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-255"><a href="#cb98-255" aria-hidden="true" tabindex="-1"></a>Let's check the balance we got for the two examples above by running t-tests comparing the treatment and control groups.</span>
<span id="cb98-256"><a href="#cb98-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-259"><a href="#cb98-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-260"><a href="#cb98-260" aria-hidden="true" tabindex="-1"></a><span class="co"># First let's create a function to perform t-tests and create a formatted results table</span></span>
<span id="cb98-261"><a href="#cb98-261" aria-hidden="true" tabindex="-1"></a>run_ttests <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, title) {</span>
<span id="cb98-262"><a href="#cb98-262" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb98-263"><a href="#cb98-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">character</span>(),</span>
<span id="cb98-264"><a href="#cb98-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">character</span>(),</span>
<span id="cb98-265"><a href="#cb98-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_control =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-266"><a href="#cb98-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_treated =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-267"><a href="#cb98-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-268"><a href="#cb98-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-269"><a href="#cb98-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> <span class="fu">character</span>()</span>
<span id="cb98-270"><a href="#cb98-270" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-271"><a href="#cb98-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-272"><a href="#cb98-272" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> baseline_vars) {</span>
<span id="cb98-273"><a href="#cb98-273" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For categorical variables (factor), we need to handle differently</span></span>
<span id="cb98-274"><a href="#cb98-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.factor</span>(dt[[var]])) {</span>
<span id="cb98-275"><a href="#cb98-275" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For each level of the factor</span></span>
<span id="cb98-276"><a href="#cb98-276" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (level <span class="cf">in</span> <span class="fu">levels</span>(dt[[var]])) {</span>
<span id="cb98-277"><a href="#cb98-277" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create temporary binary indicator</span></span>
<span id="cb98-278"><a href="#cb98-278" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">get</span>(var) <span class="sc">==</span> level)]</span>
<span id="cb98-279"><a href="#cb98-279" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-280"><a href="#cb98-280" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate means</span></span>
<span id="cb98-281"><a href="#cb98-281" aria-hidden="true" tabindex="-1"></a>        mean_control <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">mean</span>(temp)]</span>
<span id="cb98-282"><a href="#cb98-282" aria-hidden="true" tabindex="-1"></a>        mean_treated <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(temp)]</span>
<span id="cb98-283"><a href="#cb98-283" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-284"><a href="#cb98-284" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run t-test</span></span>
<span id="cb98-285"><a href="#cb98-285" aria-hidden="true" tabindex="-1"></a>        t_result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(dt[treatment <span class="sc">==</span> <span class="dv">1</span>, temp], </span>
<span id="cb98-286"><a href="#cb98-286" aria-hidden="true" tabindex="-1"></a>                           dt[treatment <span class="sc">==</span> <span class="dv">0</span>, temp])</span>
<span id="cb98-287"><a href="#cb98-287" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-288"><a href="#cb98-288" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add to results</span></span>
<span id="cb98-289"><a href="#cb98-289" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-290"><a href="#cb98-290" aria-hidden="true" tabindex="-1"></a>          <span class="at">variable =</span> <span class="fu">paste0</span>(var, <span class="st">": "</span>, level),</span>
<span id="cb98-291"><a href="#cb98-291" aria-hidden="true" tabindex="-1"></a>          <span class="at">method =</span> title,</span>
<span id="cb98-292"><a href="#cb98-292" aria-hidden="true" tabindex="-1"></a>          <span class="at">mean_control =</span> mean_control,</span>
<span id="cb98-293"><a href="#cb98-293" aria-hidden="true" tabindex="-1"></a>          <span class="at">mean_treated =</span> mean_treated,</span>
<span id="cb98-294"><a href="#cb98-294" aria-hidden="true" tabindex="-1"></a>          <span class="at">diff =</span> mean_treated <span class="sc">-</span> mean_control,</span>
<span id="cb98-295"><a href="#cb98-295" aria-hidden="true" tabindex="-1"></a>          <span class="at">p_value =</span> t_result<span class="sc">$</span>p.value,</span>
<span id="cb98-296"><a href="#cb98-296" aria-hidden="true" tabindex="-1"></a>          <span class="at">significant =</span> <span class="fu">ifelse</span>(t_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-297"><a href="#cb98-297" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb98-298"><a href="#cb98-298" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-299"><a href="#cb98-299" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove temporary variable</span></span>
<span id="cb98-300"><a href="#cb98-300" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb98-301"><a href="#cb98-301" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-302"><a href="#cb98-302" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb98-303"><a href="#cb98-303" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For continuous and binary variables</span></span>
<span id="cb98-304"><a href="#cb98-304" aria-hidden="true" tabindex="-1"></a>      mean_control <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">mean</span>(<span class="fu">get</span>(var), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb98-305"><a href="#cb98-305" aria-hidden="true" tabindex="-1"></a>      mean_treated <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(<span class="fu">get</span>(var), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb98-306"><a href="#cb98-306" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-307"><a href="#cb98-307" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Run t-test</span></span>
<span id="cb98-308"><a href="#cb98-308" aria-hidden="true" tabindex="-1"></a>      t_result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(</span>
<span id="cb98-309"><a href="#cb98-309" aria-hidden="true" tabindex="-1"></a>        dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">get</span>(var)], </span>
<span id="cb98-310"><a href="#cb98-310" aria-hidden="true" tabindex="-1"></a>        dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">get</span>(var)]</span>
<span id="cb98-311"><a href="#cb98-311" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb98-312"><a href="#cb98-312" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-313"><a href="#cb98-313" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add to results</span></span>
<span id="cb98-314"><a href="#cb98-314" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-315"><a href="#cb98-315" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> var,</span>
<span id="cb98-316"><a href="#cb98-316" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> title,</span>
<span id="cb98-317"><a href="#cb98-317" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_control =</span> mean_control,</span>
<span id="cb98-318"><a href="#cb98-318" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_treated =</span> mean_treated,</span>
<span id="cb98-319"><a href="#cb98-319" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff =</span> mean_treated <span class="sc">-</span> mean_control,</span>
<span id="cb98-320"><a href="#cb98-320" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_value =</span> t_result<span class="sc">$</span>p.value,</span>
<span id="cb98-321"><a href="#cb98-321" aria-hidden="true" tabindex="-1"></a>        <span class="at">significant =</span> <span class="fu">ifelse</span>(t_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-322"><a href="#cb98-322" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb98-323"><a href="#cb98-323" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-324"><a href="#cb98-324" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-325"><a href="#cb98-325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-326"><a href="#cb98-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb98-327"><a href="#cb98-327" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-328"><a href="#cb98-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-329"><a href="#cb98-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's run the tests</span></span>
<span id="cb98-330"><a href="#cb98-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-331"><a href="#cb98-331" aria-hidden="true" tabindex="-1"></a><span class="do">## List of all baseline covariates to test</span></span>
<span id="cb98-332"><a href="#cb98-332" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"education"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span>)</span>
<span id="cb98-333"><a href="#cb98-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-334"><a href="#cb98-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Run t-tests</span></span>
<span id="cb98-335"><a href="#cb98-335" aria-hidden="true" tabindex="-1"></a>ttest_bern <span class="ot">&lt;-</span> <span class="fu">run_ttests</span>(dt_bern, <span class="st">"Bernoulli - t-test"</span>)</span>
<span id="cb98-336"><a href="#cb98-336" aria-hidden="true" tabindex="-1"></a>ttest_cr <span class="ot">&lt;-</span> <span class="fu">run_ttests</span>(dt_cr, <span class="st">"Complete - t-test"</span>)</span>
<span id="cb98-337"><a href="#cb98-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-338"><a href="#cb98-338" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ttest_bern)</span>
<span id="cb98-339"><a href="#cb98-339" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ttest_cr)</span>
<span id="cb98-340"><a href="#cb98-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-341"><a href="#cb98-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-342"><a href="#cb98-342" aria-hidden="true" tabindex="-1"></a><span class="fu">### Chance Imbalance in Complete Randomization</span></span>
<span id="cb98-343"><a href="#cb98-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-344"><a href="#cb98-344" aria-hidden="true" tabindex="-1"></a>Even with perfect implementation of complete randomization, covariates may still be imbalanced by chance. In a simulation study using data from the National Longitudinal Survey of Youth (NLSY) with 722 subjects:<span class="sc">\[</span>\^1<span class="sc">\]</span></span>
<span id="cb98-345"><a href="#cb98-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-346"><a href="#cb98-346" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>\~45% of randomizations had all covariates balanced</span>
<span id="cb98-347"><a href="#cb98-347" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>\~30% had one imbalanced covariate</span>
<span id="cb98-348"><a href="#cb98-348" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The remaining had multiple imbalanced covariates</span>
<span id="cb98-349"><a href="#cb98-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-350"><a href="#cb98-350" aria-hidden="true" tabindex="-1"></a>This raises two critical questions: 1. How can we ensure better balance in the design phase? 2. What should we do if imbalance occurs after randomization?</span>
<span id="cb98-351"><a href="#cb98-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-352"><a href="#cb98-352" aria-hidden="true" tabindex="-1"></a>**Our next three approaches address the first question by improving balance through more sophisticated randomization techniques.**</span>
<span id="cb98-353"><a href="#cb98-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-354"><a href="#cb98-354" aria-hidden="true" tabindex="-1"></a><span class="fu">## Re-randomization</span></span>
<span id="cb98-355"><a href="#cb98-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-356"><a href="#cb98-356" aria-hidden="true" tabindex="-1"></a>Re-randomization attempts to improve covariate balance by generating multiple possible randomizations and selecting one with good balance.</span>
<span id="cb98-357"><a href="#cb98-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-358"><a href="#cb98-358" aria-hidden="true" tabindex="-1"></a>There are two common approaches to re-randomization:</span>
<span id="cb98-359"><a href="#cb98-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-360"><a href="#cb98-360" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Threshold approach**: Generate randomizations until all p-values for covariate balance exceed a threshold (e.g., p <span class="sc">\&gt;</span> 0.1)</span>
<span id="cb98-361"><a href="#cb98-361" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Optimization approach**: Generate a large number of randomizations (e.g., 1,000) and select the one with the best overall balance</span>
<span id="cb98-362"><a href="#cb98-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-363"><a href="#cb98-363" aria-hidden="true" tabindex="-1"></a><span class="fu">### Threshold Approach</span></span>
<span id="cb98-364"><a href="#cb98-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-367"><a href="#cb98-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-368"><a href="#cb98-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the data again</span></span>
<span id="cb98-369"><a href="#cb98-369" aria-hidden="true" tabindex="-1"></a>dt_rerand_threshold <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb98-370"><a href="#cb98-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-371"><a href="#cb98-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-randomization - Threshold Approach:</span></span>
<span id="cb98-372"><a href="#cb98-372" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to test balance on key covariates</span></span>
<span id="cb98-373"><a href="#cb98-373" aria-hidden="true" tabindex="-1"></a>test_balance <span class="ot">&lt;-</span> <span class="cf">function</span>(dt) {</span>
<span id="cb98-374"><a href="#cb98-374" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define key covariates to check balance on</span></span>
<span id="cb98-375"><a href="#cb98-375" aria-hidden="true" tabindex="-1"></a>  balance_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"education"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span>)</span>
<span id="cb98-376"><a href="#cb98-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-377"><a href="#cb98-377" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store p-values</span></span>
<span id="cb98-378"><a href="#cb98-378" aria-hidden="true" tabindex="-1"></a>  p_values <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(balance_vars))</span>
<span id="cb98-379"><a href="#cb98-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(p_values) <span class="ot">&lt;-</span> balance_vars</span>
<span id="cb98-380"><a href="#cb98-380" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-381"><a href="#cb98-381" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(balance_vars)) {</span>
<span id="cb98-382"><a href="#cb98-382" aria-hidden="true" tabindex="-1"></a>    var <span class="ot">&lt;-</span> balance_vars[i]</span>
<span id="cb98-383"><a href="#cb98-383" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-384"><a href="#cb98-384" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For categorical variables</span></span>
<span id="cb98-385"><a href="#cb98-385" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.factor</span>(dt[[var]])) {</span>
<span id="cb98-386"><a href="#cb98-386" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create model matrix (one-hot encoding)</span></span>
<span id="cb98-387"><a href="#cb98-387" aria-hidden="true" tabindex="-1"></a>      formula_str <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~ "</span>, var, <span class="st">" - 1"</span>)</span>
<span id="cb98-388"><a href="#cb98-388" aria-hidden="true" tabindex="-1"></a>      mm <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> dt)</span>
<span id="cb98-389"><a href="#cb98-389" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Test each level except the reference</span></span>
<span id="cb98-390"><a href="#cb98-390" aria-hidden="true" tabindex="-1"></a>      p_vals_cat <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">ncol</span>(mm))</span>
<span id="cb98-391"><a href="#cb98-391" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(mm)) {</span>
<span id="cb98-392"><a href="#cb98-392" aria-hidden="true" tabindex="-1"></a>        t_result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(mm[dt<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>, j], mm[dt<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">0</span>, j])</span>
<span id="cb98-393"><a href="#cb98-393" aria-hidden="true" tabindex="-1"></a>        p_vals_cat[j] <span class="ot">&lt;-</span> t_result<span class="sc">$</span>p.value</span>
<span id="cb98-394"><a href="#cb98-394" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-395"><a href="#cb98-395" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use minimum p-value (most imbalanced category)</span></span>
<span id="cb98-396"><a href="#cb98-396" aria-hidden="true" tabindex="-1"></a>      p_values[i] <span class="ot">&lt;-</span> <span class="fu">min</span>(p_vals_cat)</span>
<span id="cb98-397"><a href="#cb98-397" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb98-398"><a href="#cb98-398" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For continuous or binary variables</span></span>
<span id="cb98-399"><a href="#cb98-399" aria-hidden="true" tabindex="-1"></a>      t_result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">get</span>(var)], dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">get</span>(var)])</span>
<span id="cb98-400"><a href="#cb98-400" aria-hidden="true" tabindex="-1"></a>      p_values[i] <span class="ot">&lt;-</span> t_result<span class="sc">$</span>p.value</span>
<span id="cb98-401"><a href="#cb98-401" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-402"><a href="#cb98-402" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-403"><a href="#cb98-403" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-404"><a href="#cb98-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p_values)</span>
<span id="cb98-405"><a href="#cb98-405" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-406"><a href="#cb98-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-407"><a href="#cb98-407" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-randomization with threshold approach</span></span>
<span id="cb98-408"><a href="#cb98-408" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue generating randomizations until all p-values &gt; 0.10</span></span>
<span id="cb98-409"><a href="#cb98-409" aria-hidden="true" tabindex="-1"></a>max_attempts <span class="ot">&lt;-</span> <span class="dv">1000</span>  <span class="co"># Safety limit to prevent infinite loops</span></span>
<span id="cb98-410"><a href="#cb98-410" aria-hidden="true" tabindex="-1"></a>attempt <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-411"><a href="#cb98-411" aria-hidden="true" tabindex="-1"></a>balanced <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb98-412"><a href="#cb98-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-413"><a href="#cb98-413" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Performing re-randomization with threshold approach...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-414"><a href="#cb98-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-415"><a href="#cb98-415" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="sc">!</span>balanced <span class="sc">&amp;&amp;</span> attempt <span class="sc">&lt;</span> max_attempts) {</span>
<span id="cb98-416"><a href="#cb98-416" aria-hidden="true" tabindex="-1"></a>  attempt <span class="ot">&lt;-</span> attempt <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb98-417"><a href="#cb98-417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-418"><a href="#cb98-418" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate a new randomization</span></span>
<span id="cb98-419"><a href="#cb98-419" aria-hidden="true" tabindex="-1"></a>  dt_rerand_threshold[, treatment <span class="sc">:</span><span class="er">=</span> <span class="fu">rbinom</span>(.N, <span class="dv">1</span>, <span class="fl">0.5</span>)]</span>
<span id="cb98-420"><a href="#cb98-420" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-421"><a href="#cb98-421" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test balance</span></span>
<span id="cb98-422"><a href="#cb98-422" aria-hidden="true" tabindex="-1"></a>  p_values <span class="ot">&lt;-</span> <span class="fu">test_balance</span>(dt_rerand_threshold)</span>
<span id="cb98-423"><a href="#cb98-423" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-424"><a href="#cb98-424" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if all p-values are above threshold (0.10)</span></span>
<span id="cb98-425"><a href="#cb98-425" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(p_values <span class="sc">&gt;</span> <span class="fl">0.10</span>)) {</span>
<span id="cb98-426"><a href="#cb98-426" aria-hidden="true" tabindex="-1"></a>    balanced <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb98-427"><a href="#cb98-427" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Found balanced randomization after"</span>, attempt, <span class="st">"attempts</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-428"><a href="#cb98-428" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Balance p-values:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(p_values), <span class="fu">round</span>(p_values, <span class="dv">4</span>), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb98-429"><a href="#cb98-429" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (attempt <span class="sc">%%</span> <span class="dv">100</span> <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb98-430"><a href="#cb98-430" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Completed"</span>, attempt, <span class="st">"attempts, continuing search...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-431"><a href="#cb98-431" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-432"><a href="#cb98-432" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-433"><a href="#cb98-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-434"><a href="#cb98-434" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>balanced) {</span>
<span id="cb98-435"><a href="#cb98-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Could not find perfectly balanced randomization after"</span>, max_attempts, <span class="st">"attempts</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-436"><a href="#cb98-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using best randomization found so far</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb98-437"><a href="#cb98-437" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-438"><a href="#cb98-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-439"><a href="#cb98-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-440"><a href="#cb98-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-441"><a href="#cb98-441" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optimization approach</span></span>
<span id="cb98-442"><a href="#cb98-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-443"><a href="#cb98-443" aria-hidden="true" tabindex="-1"></a>You can define the "best" overall balance in different ways. Here we'll use the Mahalanobis distance.</span>
<span id="cb98-444"><a href="#cb98-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-445"><a href="#cb98-445" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb98-446"><a href="#cb98-446" aria-hidden="true" tabindex="-1"></a>The Mahalanobis distance is a statistical measure that quantifies the distance between a point and a distribution in multivariate space. The Mahalanobis distance is formally defined as:</span>
<span id="cb98-447"><a href="#cb98-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-448"><a href="#cb98-448" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb98-449"><a href="#cb98-449" aria-hidden="true" tabindex="-1"></a>d_{maha} = \sqrt{(x_B - X_A)^TC^{-1}(x_B - x_A)}</span>
<span id="cb98-450"><a href="#cb98-450" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb98-451"><a href="#cb98-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-452"><a href="#cb98-452" aria-hidden="true" tabindex="-1"></a>Where: • $x_A$ and $x_B$ are a pair of objects • $C$ is the sample covariance matrix • $C^{-1}$ is the inverse of the covariance matrix • $T$ denotes the transpose operation</span>
<span id="cb98-453"><a href="#cb98-453" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb98-454"><a href="#cb98-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-457"><a href="#cb98-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-458"><a href="#cb98-458" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy data</span></span>
<span id="cb98-459"><a href="#cb98-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-460"><a href="#cb98-460" aria-hidden="true" tabindex="-1"></a>dt_rerand_optimal <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb98-461"><a href="#cb98-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-462"><a href="#cb98-462" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-randomization - Optimization Approach:</span></span>
<span id="cb98-463"><a href="#cb98-463" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate multiple randomizations and select the one with best overall balance</span></span>
<span id="cb98-464"><a href="#cb98-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-465"><a href="#cb98-465" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Performing re-randomization with optimization approach...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-466"><a href="#cb98-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-467"><a href="#cb98-467" aria-hidden="true" tabindex="-1"></a>n_candidates <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb98-468"><a href="#cb98-468" aria-hidden="true" tabindex="-1"></a>mahalanobis_distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_candidates)</span>
<span id="cb98-469"><a href="#cb98-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-470"><a href="#cb98-470" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate covariates matrix (need to handle factors separately)</span></span>
<span id="cb98-471"><a href="#cb98-471" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Converting covariates to numeric for Mahalanobis distance calculation...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-472"><a href="#cb98-472" aria-hidden="true" tabindex="-1"></a>cov_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span>)</span>
<span id="cb98-473"><a href="#cb98-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-474"><a href="#cb98-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dummy variables for education</span></span>
<span id="cb98-475"><a href="#cb98-475" aria-hidden="true" tabindex="-1"></a>edu_dummies <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> education <span class="sc">-</span> <span class="dv">1</span>, <span class="at">data =</span> dt_rerand_optimal)</span>
<span id="cb98-476"><a href="#cb98-476" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb98-477"><a href="#cb98-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(dt_rerand_optimal[, ..cov_vars]),</span>
<span id="cb98-478"><a href="#cb98-478" aria-hidden="true" tabindex="-1"></a>  edu_dummies</span>
<span id="cb98-479"><a href="#cb98-479" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-480"><a href="#cb98-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-481"><a href="#cb98-481" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate covariance matrix of covariates</span></span>
<span id="cb98-482"><a href="#cb98-482" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">cov</span>(X)</span>
<span id="cb98-483"><a href="#cb98-483" aria-hidden="true" tabindex="-1"></a>S_inv <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb98-484"><a href="#cb98-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve</span>(S)  <span class="co"># Try to compute inverse</span></span>
<span id="cb98-485"><a href="#cb98-485" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb98-486"><a href="#cb98-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Covariance matrix is singular, using pseudoinverse...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-487"><a href="#cb98-487" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use pseudoinverse if matrix is singular</span></span>
<span id="cb98-488"><a href="#cb98-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MASS)</span>
<span id="cb98-489"><a href="#cb98-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ginv</span>(S)</span>
<span id="cb98-490"><a href="#cb98-490" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb98-491"><a href="#cb98-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-492"><a href="#cb98-492" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate candidate randomizations and calculate balance measure</span></span>
<span id="cb98-493"><a href="#cb98-493" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_candidates) {</span>
<span id="cb98-494"><a href="#cb98-494" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate a new randomization</span></span>
<span id="cb98-495"><a href="#cb98-495" aria-hidden="true" tabindex="-1"></a>  treatment_assign <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb98-496"><a href="#cb98-496" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-497"><a href="#cb98-497" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate difference in means</span></span>
<span id="cb98-498"><a href="#cb98-498" aria-hidden="true" tabindex="-1"></a>  mean_diff <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(X[treatment_assign <span class="sc">==</span> <span class="dv">1</span>, ]) <span class="sc">-</span> <span class="fu">colMeans</span>(X[treatment_assign <span class="sc">==</span> <span class="dv">0</span>, ])</span>
<span id="cb98-499"><a href="#cb98-499" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-500"><a href="#cb98-500" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate Mahalanobis distance</span></span>
<span id="cb98-501"><a href="#cb98-501" aria-hidden="true" tabindex="-1"></a>  mahalanobis_distances[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(mean_diff) <span class="sc">%*%</span> S_inv <span class="sc">%*%</span> mean_diff</span>
<span id="cb98-502"><a href="#cb98-502" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-503"><a href="#cb98-503" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">%%</span> <span class="dv">200</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"Generated"</span>, i, <span class="st">"candidate randomizations...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-504"><a href="#cb98-504" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-505"><a href="#cb98-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-506"><a href="#cb98-506" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the randomization with smallest Mahalanobis distance</span></span>
<span id="cb98-507"><a href="#cb98-507" aria-hidden="true" tabindex="-1"></a>best_idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(mahalanobis_distances)</span>
<span id="cb98-508"><a href="#cb98-508" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Selected optimal randomization (candidate"</span>, best_idx, <span class="st">"with Mahalanobis distance ="</span>, </span>
<span id="cb98-509"><a href="#cb98-509" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(mahalanobis_distances[best_idx], <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb98-510"><a href="#cb98-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-511"><a href="#cb98-511" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the best randomization</span></span>
<span id="cb98-512"><a href="#cb98-512" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(best_idx)  <span class="co"># For reproducibility</span></span>
<span id="cb98-513"><a href="#cb98-513" aria-hidden="true" tabindex="-1"></a>dt_rerand_optimal[, treatment <span class="sc">:</span><span class="er">=</span> <span class="fu">rbinom</span>(.N, <span class="dv">1</span>, <span class="fl">0.5</span>)]</span>
<span id="cb98-514"><a href="#cb98-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-515"><a href="#cb98-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-516"><a href="#cb98-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-517"><a href="#cb98-517" aria-hidden="true" tabindex="-1"></a><span class="fu">### Drawbacks of Re-randomization</span></span>
<span id="cb98-518"><a href="#cb98-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-519"><a href="#cb98-519" aria-hidden="true" tabindex="-1"></a>While re-randomization can improve balance, it has several limitations:</span>
<span id="cb98-520"><a href="#cb98-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-521"><a href="#cb98-521" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Opaque constraints**: The process creates a "black box" where it's unclear what constraints are being imposed</span>
<span id="cb98-522"><a href="#cb98-522" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Unusual handling of outliers**: Extreme values may force unusual allocation patterns</span>
<span id="cb98-523"><a href="#cb98-523" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Computational cost**: May require many iterations, especially with multiple covariates</span>
<span id="cb98-524"><a href="#cb98-524" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Potential futility**: If criteria are too strict, acceptable randomizations may be extremely rare</span>
<span id="cb98-525"><a href="#cb98-525" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Statistical inference complications**: Standard methods don't account for the re-randomization process</span>
<span id="cb98-526"><a href="#cb98-526" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Limited scope**: Still cannot balance on unobserved covariates</span>
<span id="cb98-527"><a href="#cb98-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-528"><a href="#cb98-528" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stratified (Block) Randomization</span></span>
<span id="cb98-529"><a href="#cb98-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-530"><a href="#cb98-530" aria-hidden="true" tabindex="-1"></a>Stratified randomization (also called block randomization) directly addresses the balance issue by dividing the sample into strata based on covariates and randomizing separately within each stratum.</span>
<span id="cb98-531"><a href="#cb98-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-532"><a href="#cb98-532" aria-hidden="true" tabindex="-1"></a>In this approach, we first create strata based on combinations of important covariates, then randomize separately within each stratum. This guarantees perfect balance on the stratification variables.</span>
<span id="cb98-533"><a href="#cb98-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-534"><a href="#cb98-534" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selecting Stratification Variables</span></span>
<span id="cb98-535"><a href="#cb98-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-536"><a href="#cb98-536" aria-hidden="true" tabindex="-1"></a>Not all covariates are equally important for stratification. Consider these guidelines:</span>
<span id="cb98-537"><a href="#cb98-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-538"><a href="#cb98-538" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Discrete variables** are easier to implement than continuous ones</span>
<span id="cb98-539"><a href="#cb98-539" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Prioritize variables that **strongly predict outcomes** (baseline values of the outcome variable are especially important)</span>
<span id="cb98-540"><a href="#cb98-540" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Include variables where **heterogeneous effects** are expected (facilitates subgroup analysis)</span>
<span id="cb98-541"><a href="#cb98-541" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Be careful about creating **too many strata**, which can lead to "small cell" problems</span>
<span id="cb98-542"><a href="#cb98-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-543"><a href="#cb98-543" aria-hidden="true" tabindex="-1"></a><span class="fu">### Handling "Misfits"</span></span>
<span id="cb98-544"><a href="#cb98-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-545"><a href="#cb98-545" aria-hidden="true" tabindex="-1"></a>A practical challenge in stratified randomization occurs when strata sizes are not divisible by the number of treatment conditions (e.g., three people in a stratum with two treatment conditions). Options for these "misfits" include:</span>
<span id="cb98-546"><a href="#cb98-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-547"><a href="#cb98-547" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Remove units randomly to create divisible strata</span>
<span id="cb98-548"><a href="#cb98-548" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Create a separate stratum for misfits</span>
<span id="cb98-549"><a href="#cb98-549" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use a different randomization approach for misfits</span>
<span id="cb98-550"><a href="#cb98-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-551"><a href="#cb98-551" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb98-552"><a href="#cb98-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-555"><a href="#cb98-555" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-556"><a href="#cb98-556" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the Data</span></span>
<span id="cb98-557"><a href="#cb98-557" aria-hidden="true" tabindex="-1"></a>dt_strat <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb98-558"><a href="#cb98-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-559"><a href="#cb98-559" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the seed using Zoe's bday</span></span>
<span id="cb98-560"><a href="#cb98-560" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">072111</span>)  <span class="co"># For reproducibility</span></span>
<span id="cb98-561"><a href="#cb98-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-562"><a href="#cb98-562" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert categorical variables to factors for clearer output</span></span>
<span id="cb98-563"><a href="#cb98-563" aria-hidden="true" tabindex="-1"></a>dt_strat[, education <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(education, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"None"</span>, <span class="st">"Primary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Higher"</span>))]</span>
<span id="cb98-564"><a href="#cb98-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-565"><a href="#cb98-565" aria-hidden="true" tabindex="-1"></a><span class="co"># Create age quintiles</span></span>
<span id="cb98-566"><a href="#cb98-566" aria-hidden="true" tabindex="-1"></a>dt_strat[, age_quintile <span class="sc">:</span><span class="er">=</span> <span class="fu">cut</span>(age, </span>
<span id="cb98-567"><a href="#cb98-567" aria-hidden="true" tabindex="-1"></a>                         <span class="at">breaks =</span> <span class="fu">quantile</span>(age, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb98-568"><a href="#cb98-568" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, </span>
<span id="cb98-569"><a href="#cb98-569" aria-hidden="true" tabindex="-1"></a>                         <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb98-570"><a href="#cb98-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-571"><a href="#cb98-571" aria-hidden="true" tabindex="-1"></a><span class="co"># View data structure</span></span>
<span id="cb98-572"><a href="#cb98-572" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Data structure:"</span>)</span>
<span id="cb98-573"><a href="#cb98-573" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(dt_strat)</span>
<span id="cb98-574"><a href="#cb98-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-575"><a href="#cb98-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-578"><a href="#cb98-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-579"><a href="#cb98-579" aria-hidden="true" tabindex="-1"></a><span class="co"># Create strata ID by combining education and age quintile</span></span>
<span id="cb98-580"><a href="#cb98-580" aria-hidden="true" tabindex="-1"></a>dt_strat[, strata <span class="sc">:</span><span class="er">=</span> .GRP, by <span class="ot">=</span> .(education, age_quintile)]</span>
<span id="cb98-581"><a href="#cb98-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-582"><a href="#cb98-582" aria-hidden="true" tabindex="-1"></a><span class="co"># Print strata information</span></span>
<span id="cb98-583"><a href="#cb98-583" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Strata information:"</span>)</span>
<span id="cb98-584"><a href="#cb98-584" aria-hidden="true" tabindex="-1"></a>dt_strat[, .(<span class="at">count =</span> .N), by <span class="ot">=</span> .(education, age_quintile, strata)][<span class="fu">order</span>(strata)]</span>
<span id="cb98-585"><a href="#cb98-585" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-586"><a href="#cb98-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-587"><a href="#cb98-587" aria-hidden="true" tabindex="-1"></a>Now let's randomize half of the observations in each strata to treatment and half to control. To ensure 50/50 split, we'll use the Complete Randomization method within each strata:</span>
<span id="cb98-588"><a href="#cb98-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-591"><a href="#cb98-591" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-592"><a href="#cb98-592" aria-hidden="true" tabindex="-1"></a>dt_strat[, treatment <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]  <span class="co"># Initialize all to control</span></span>
<span id="cb98-593"><a href="#cb98-593" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">unique</span>(dt_strat<span class="sc">$</span>strata)) {</span>
<span id="cb98-594"><a href="#cb98-594" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get all units in this stratum</span></span>
<span id="cb98-595"><a href="#cb98-595" aria-hidden="true" tabindex="-1"></a>  stratum_units <span class="ot">&lt;-</span> dt_strat[strata <span class="sc">==</span> s, id]</span>
<span id="cb98-596"><a href="#cb98-596" aria-hidden="true" tabindex="-1"></a>  n_units <span class="ot">&lt;-</span> <span class="fu">length</span>(stratum_units)</span>
<span id="cb98-597"><a href="#cb98-597" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-598"><a href="#cb98-598" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine number to treat (half, rounded down)</span></span>
<span id="cb98-599"><a href="#cb98-599" aria-hidden="true" tabindex="-1"></a>  n_treat <span class="ot">&lt;-</span> <span class="fu">floor</span>(n_units<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb98-600"><a href="#cb98-600" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-601"><a href="#cb98-601" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Misfits: If n_units is odd, flip a coin to decide whether to round up or down</span></span>
<span id="cb98-602"><a href="#cb98-602" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n_units <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb98-603"><a href="#cb98-603" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> <span class="fl">0.5</span>) n_treat <span class="ot">&lt;-</span> n_treat <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb98-604"><a href="#cb98-604" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-605"><a href="#cb98-605" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-606"><a href="#cb98-606" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Randomly select units for treatment</span></span>
<span id="cb98-607"><a href="#cb98-607" aria-hidden="true" tabindex="-1"></a>  treated_units <span class="ot">&lt;-</span> <span class="fu">sample</span>(stratum_units, n_treat)</span>
<span id="cb98-608"><a href="#cb98-608" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-609"><a href="#cb98-609" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign treatment</span></span>
<span id="cb98-610"><a href="#cb98-610" aria-hidden="true" tabindex="-1"></a>  dt_strat[id <span class="sc">%in%</span> treated_units, treatment <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span>]</span>
<span id="cb98-611"><a href="#cb98-611" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-612"><a href="#cb98-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-613"><a href="#cb98-613" aria-hidden="true" tabindex="-1"></a><span class="co"># Print treatment assignment by strata for stratified randomization</span></span>
<span id="cb98-614"><a href="#cb98-614" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Treatment assignment by strata in stratified randomization:"</span>)</span>
<span id="cb98-615"><a href="#cb98-615" aria-hidden="true" tabindex="-1"></a>dt_strat[, .(<span class="at">N =</span> .N, </span>
<span id="cb98-616"><a href="#cb98-616" aria-hidden="true" tabindex="-1"></a>             <span class="at">n_treated =</span> <span class="fu">sum</span>(treatment), </span>
<span id="cb98-617"><a href="#cb98-617" aria-hidden="true" tabindex="-1"></a>             <span class="at">pct_treated =</span> <span class="fu">mean</span>(treatment)<span class="sc">*</span><span class="dv">100</span>), </span>
<span id="cb98-618"><a href="#cb98-618" aria-hidden="true" tabindex="-1"></a>         by <span class="ot">=</span> strata][<span class="fu">order</span>(strata)]</span>
<span id="cb98-619"><a href="#cb98-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-620"><a href="#cb98-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-621"><a href="#cb98-621" aria-hidden="true" tabindex="-1"></a><span class="fu">## Matched Pairs Randomization</span></span>
<span id="cb98-622"><a href="#cb98-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-623"><a href="#cb98-623" aria-hidden="true" tabindex="-1"></a>Matched pairs randomization represents the extreme case of stratification, where each stratum contains exactly two similar units, and one is randomly assigned to treatment and one to control.</span>
<span id="cb98-624"><a href="#cb98-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-625"><a href="#cb98-625" aria-hidden="true" tabindex="-1"></a>In this approach, we first create pairs of similar units based on a distance metric, then randomly assign one member of each pair to treatment and the other to control. This guarantees excellent balance on the matching variables.</span>
<span id="cb98-626"><a href="#cb98-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-627"><a href="#cb98-627" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation</span></span>
<span id="cb98-628"><a href="#cb98-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-629"><a href="#cb98-629" aria-hidden="true" tabindex="-1"></a>::: {callout-warning}</span>
<span id="cb98-630"><a href="#cb98-630" aria-hidden="true" tabindex="-1"></a>In this example, we're using what is referred to as a "greedy" matching algorithm. It is "greedy" because it makes locally optimal choices at each step without reconsidering earlier decisions, potentially missing the globally optimal solution. We're using this for now because it is clear and simple to impelment.</span>
<span id="cb98-631"><a href="#cb98-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-632"><a href="#cb98-632" aria-hidden="true" tabindex="-1"></a>In practice, "canned" matching commands are commonly used to form matches and these often use other optimal matching algorithms. A non-greedy, optimal matching algorithm would consider all possible ways to pair units and select the configuration that minimizes the total sum of distances across all pairs. This is computationally more intensive (often solved using network optimization methods like the Hungarian algorithm) but guarantees the global minimum total distance.</span>
<span id="cb98-633"><a href="#cb98-633" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb98-634"><a href="#cb98-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-637"><a href="#cb98-637" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-638"><a href="#cb98-638" aria-hidden="true" tabindex="-1"></a>dt_matched <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb98-639"><a href="#cb98-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-640"><a href="#cb98-640" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the seed using Zoe's bday</span></span>
<span id="cb98-641"><a href="#cb98-641" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">072111</span>)  <span class="co"># For reproducibility</span></span>
<span id="cb98-642"><a href="#cb98-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-643"><a href="#cb98-643" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Prepare data for matching</span></span>
<span id="cb98-644"><a href="#cb98-644" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Performing matched randomization using Mahalanobis distance...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-645"><a href="#cb98-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-646"><a href="#cb98-646" aria-hidden="true" tabindex="-1"></a><span class="co"># Create matrix of variables to match on</span></span>
<span id="cb98-647"><a href="#cb98-647" aria-hidden="true" tabindex="-1"></a>match_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>)</span>
<span id="cb98-648"><a href="#cb98-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-649"><a href="#cb98-649" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert education to dummy variables for inclusion in distance calculation</span></span>
<span id="cb98-650"><a href="#cb98-650" aria-hidden="true" tabindex="-1"></a>edu_dummies <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> education <span class="sc">-</span> <span class="dv">1</span>, <span class="at">data =</span> dt_matched)</span>
<span id="cb98-651"><a href="#cb98-651" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(edu_dummies) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"edu_"</span>, <span class="fu">levels</span>(dt_matched<span class="sc">$</span>education))</span>
<span id="cb98-652"><a href="#cb98-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-653"><a href="#cb98-653" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine numeric variables with education dummies</span></span>
<span id="cb98-654"><a href="#cb98-654" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">as.matrix</span>(dt_matched[, ..match_vars]), edu_dummies)</span>
<span id="cb98-655"><a href="#cb98-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-656"><a href="#cb98-656" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate covariance matrix and inverse</span></span>
<span id="cb98-657"><a href="#cb98-657" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">cov</span>(X)</span>
<span id="cb98-658"><a href="#cb98-658" aria-hidden="true" tabindex="-1"></a>S_inv <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb98-659"><a href="#cb98-659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve</span>(S)  <span class="co"># Try to compute inverse</span></span>
<span id="cb98-660"><a href="#cb98-660" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb98-661"><a href="#cb98-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Covariance matrix is singular, using pseudoinverse...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-662"><a href="#cb98-662" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use pseudoinverse if matrix is singular</span></span>
<span id="cb98-663"><a href="#cb98-663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MASS)</span>
<span id="cb98-664"><a href="#cb98-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ginv</span>(S)</span>
<span id="cb98-665"><a href="#cb98-665" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb98-666"><a href="#cb98-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-667"><a href="#cb98-667" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Calculate pairwise Mahalanobis distances between all units</span></span>
<span id="cb98-668"><a href="#cb98-668" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt_matched)</span>
<span id="cb98-669"><a href="#cb98-669" aria-hidden="true" tabindex="-1"></a>dist_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, n)</span>
<span id="cb98-670"><a href="#cb98-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-671"><a href="#cb98-671" aria-hidden="true" tabindex="-1"></a><span class="co"># Store original IDs to maintain correct mapping</span></span>
<span id="cb98-672"><a href="#cb98-672" aria-hidden="true" tabindex="-1"></a>original_ids <span class="ot">&lt;-</span> dt_matched<span class="sc">$</span>id</span>
<span id="cb98-673"><a href="#cb98-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-674"><a href="#cb98-674" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Calculating Mahalanobis distances between all units...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-675"><a href="#cb98-675" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)) {</span>
<span id="cb98-676"><a href="#cb98-676" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> (i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n) {</span>
<span id="cb98-677"><a href="#cb98-677" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate vector of differences between units i and j</span></span>
<span id="cb98-678"><a href="#cb98-678" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> X[i,] <span class="sc">-</span> X[j,]</span>
<span id="cb98-679"><a href="#cb98-679" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-680"><a href="#cb98-680" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Mahalanobis distance</span></span>
<span id="cb98-681"><a href="#cb98-681" aria-hidden="true" tabindex="-1"></a>    dist_matrix[i,j] <span class="ot">&lt;-</span> dist_matrix[j,i] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">t</span>(diff) <span class="sc">%*%</span> S_inv <span class="sc">%*%</span> diff)</span>
<span id="cb98-682"><a href="#cb98-682" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-683"><a href="#cb98-683" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-684"><a href="#cb98-684" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">%%</span> <span class="dv">100</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"Processed"</span>, i, <span class="st">"of"</span>, n, <span class="st">"units...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-685"><a href="#cb98-685" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-686"><a href="#cb98-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-687"><a href="#cb98-687" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Create optimal pairs using greedy algorithm</span></span>
<span id="cb98-688"><a href="#cb98-688" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Creating optimal pairs...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-689"><a href="#cb98-689" aria-hidden="true" tabindex="-1"></a>unpaired_idx <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>n  <span class="co"># These are indices, not IDs</span></span>
<span id="cb98-690"><a href="#cb98-690" aria-hidden="true" tabindex="-1"></a>pairs_idx <span class="ot">&lt;-</span> <span class="fu">list</span>()  <span class="co"># Store pairs of indices</span></span>
<span id="cb98-691"><a href="#cb98-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-692"><a href="#cb98-692" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="fu">length</span>(unpaired_idx) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb98-693"><a href="#cb98-693" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the nearest neighbor for the first unpaired unit</span></span>
<span id="cb98-694"><a href="#cb98-694" aria-hidden="true" tabindex="-1"></a>  current_idx <span class="ot">&lt;-</span> unpaired_idx[<span class="dv">1</span>]</span>
<span id="cb98-695"><a href="#cb98-695" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> dist_matrix[current_idx, unpaired_idx[<span class="sc">-</span><span class="dv">1</span>]]</span>
<span id="cb98-696"><a href="#cb98-696" aria-hidden="true" tabindex="-1"></a>  nearest_pos <span class="ot">&lt;-</span> <span class="fu">which.min</span>(distances)</span>
<span id="cb98-697"><a href="#cb98-697" aria-hidden="true" tabindex="-1"></a>  nearest_idx <span class="ot">&lt;-</span> unpaired_idx[nearest_pos <span class="sc">+</span> <span class="dv">1</span>]  <span class="co"># +1 because we excluded current from unpaired</span></span>
<span id="cb98-698"><a href="#cb98-698" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-699"><a href="#cb98-699" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a new pair of indices</span></span>
<span id="cb98-700"><a href="#cb98-700" aria-hidden="true" tabindex="-1"></a>  pairs_idx <span class="ot">&lt;-</span> <span class="fu">c</span>(pairs_idx, <span class="fu">list</span>(<span class="fu">c</span>(current_idx, nearest_idx)))</span>
<span id="cb98-701"><a href="#cb98-701" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-702"><a href="#cb98-702" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove these indices from unpaired</span></span>
<span id="cb98-703"><a href="#cb98-703" aria-hidden="true" tabindex="-1"></a>  unpaired_idx <span class="ot">&lt;-</span> unpaired_idx[<span class="sc">!</span>unpaired_idx <span class="sc">%in%</span> <span class="fu">c</span>(current_idx, nearest_idx)]</span>
<span id="cb98-704"><a href="#cb98-704" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-705"><a href="#cb98-705" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(pairs_idx) <span class="sc">%%</span> <span class="dv">50</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"Created"</span>, <span class="fu">length</span>(pairs_idx), <span class="st">"pairs...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-706"><a href="#cb98-706" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-707"><a href="#cb98-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-708"><a href="#cb98-708" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle leftover unit if odd number of units</span></span>
<span id="cb98-709"><a href="#cb98-709" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(unpaired_idx) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb98-710"><a href="#cb98-710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Note: Odd number of units. Unit index"</span>, unpaired_idx, <span class="st">"will be randomly assigned.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-711"><a href="#cb98-711" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This unit will be handled separately</span></span>
<span id="cb98-712"><a href="#cb98-712" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-713"><a href="#cb98-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-714"><a href="#cb98-714" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Convert index pairs to ID pairs and assign treatments</span></span>
<span id="cb98-715"><a href="#cb98-715" aria-hidden="true" tabindex="-1"></a>pairs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(pairs_idx, <span class="cf">function</span>(p) original_ids[p])</span>
<span id="cb98-716"><a href="#cb98-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-717"><a href="#cb98-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset pair_id and treatment in the dataset</span></span>
<span id="cb98-718"><a href="#cb98-718" aria-hidden="true" tabindex="-1"></a>dt_matched[, pair_id <span class="sc">:</span><span class="er">=</span> <span class="cn">NA_integer_</span>]</span>
<span id="cb98-719"><a href="#cb98-719" aria-hidden="true" tabindex="-1"></a>dt_matched[, treatment <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]  <span class="co"># Initialize all to control</span></span>
<span id="cb98-720"><a href="#cb98-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-721"><a href="#cb98-721" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Assigning pair IDs and treatment...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-722"><a href="#cb98-722" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(pairs)) {</span>
<span id="cb98-723"><a href="#cb98-723" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign pair ID to both units in the pair</span></span>
<span id="cb98-724"><a href="#cb98-724" aria-hidden="true" tabindex="-1"></a>  dt_matched[id <span class="sc">%in%</span> pairs[[i]], pair_id <span class="sc">:</span><span class="er">=</span> i]</span>
<span id="cb98-725"><a href="#cb98-725" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-726"><a href="#cb98-726" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Randomly select one unit for treatment</span></span>
<span id="cb98-727"><a href="#cb98-727" aria-hidden="true" tabindex="-1"></a>  treated_id <span class="ot">&lt;-</span> <span class="fu">sample</span>(pairs[[i]], <span class="dv">1</span>)</span>
<span id="cb98-728"><a href="#cb98-728" aria-hidden="true" tabindex="-1"></a>  dt_matched[id <span class="sc">==</span> treated_id, treatment <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span>]</span>
<span id="cb98-729"><a href="#cb98-729" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-730"><a href="#cb98-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-731"><a href="#cb98-731" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle leftover unit if exists</span></span>
<span id="cb98-732"><a href="#cb98-732" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(unpaired_idx) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb98-733"><a href="#cb98-733" aria-hidden="true" tabindex="-1"></a>  leftover_id <span class="ot">&lt;-</span> original_ids[unpaired_idx]</span>
<span id="cb98-734"><a href="#cb98-734" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-735"><a href="#cb98-735" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign to a special "pair" ID</span></span>
<span id="cb98-736"><a href="#cb98-736" aria-hidden="true" tabindex="-1"></a>  dt_matched[id <span class="sc">==</span> leftover_id, pair_id <span class="sc">:</span><span class="er">=</span> <span class="fu">length</span>(pairs) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb98-737"><a href="#cb98-737" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-738"><a href="#cb98-738" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Randomly assign to treatment or control</span></span>
<span id="cb98-739"><a href="#cb98-739" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> <span class="fl">0.5</span>) {</span>
<span id="cb98-740"><a href="#cb98-740" aria-hidden="true" tabindex="-1"></a>    dt_matched[id <span class="sc">==</span> leftover_id, treatment <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span>]</span>
<span id="cb98-741"><a href="#cb98-741" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-742"><a href="#cb98-742" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-743"><a href="#cb98-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-744"><a href="#cb98-744" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify pair assignments</span></span>
<span id="cb98-745"><a href="#cb98-745" aria-hidden="true" tabindex="-1"></a>pair_counts <span class="ot">&lt;-</span> dt_matched[<span class="sc">!</span><span class="fu">is.na</span>(pair_id), .N, by <span class="ot">=</span> pair_id]</span>
<span id="cb98-746"><a href="#cb98-746" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Verifying pair assignments:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-747"><a href="#cb98-747" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of unique pairs:"</span>, <span class="fu">nrow</span>(pair_counts), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-748"><a href="#cb98-748" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Distribution of pair sizes:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-749"><a href="#cb98-749" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(pair_counts<span class="sc">$</span>N))</span>
<span id="cb98-750"><a href="#cb98-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-751"><a href="#cb98-751" aria-hidden="true" tabindex="-1"></a><span class="co"># Check treatment balance</span></span>
<span id="cb98-752"><a href="#cb98-752" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Treatment balance:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-753"><a href="#cb98-753" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Treatment group size:"</span>, dt_matched[treatment <span class="sc">==</span> <span class="dv">1</span>, .N], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-754"><a href="#cb98-754" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Control group size:"</span>, dt_matched[treatment <span class="sc">==</span> <span class="dv">0</span>, .N], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-755"><a href="#cb98-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-756"><a href="#cb98-756" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first 10 pairs, sorted by pair_id</span></span>
<span id="cb98-757"><a href="#cb98-757" aria-hidden="true" tabindex="-1"></a>dt_matched[pair_id <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>][<span class="fu">order</span>(pair_id), .(id, pair_id, treatment, age, education, income)]</span>
<span id="cb98-758"><a href="#cb98-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-759"><a href="#cb98-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-760"><a href="#cb98-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-761"><a href="#cb98-761" aria-hidden="true" tabindex="-1"></a><span class="fu">### Advantages and Limitations</span></span>
<span id="cb98-762"><a href="#cb98-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-763"><a href="#cb98-763" aria-hidden="true" tabindex="-1"></a>**Advantages:** - Achieves excellent balance on matching variables - Works well with continuous covariates - Reduces variance in treatment effect estimates</span>
<span id="cb98-764"><a href="#cb98-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-765"><a href="#cb98-765" aria-hidden="true" tabindex="-1"></a>**Limitations:** - Finding good matches becomes difficult with many covariates - May discard units that can't be well-matched - Requires all baseline data before randomization - Analysis must account for pairing structure</span>
<span id="cb98-766"><a href="#cb98-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-767"><a href="#cb98-767" aria-hidden="true" tabindex="-1"></a><span class="fu">## Verifying Balance: Approaches and Best Practices</span></span>
<span id="cb98-768"><a href="#cb98-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-769"><a href="#cb98-769" aria-hidden="true" tabindex="-1"></a>After randomization, it's crucial to verify that balance between the treatment and control group was achieved. Several approaches exist:</span>
<span id="cb98-770"><a href="#cb98-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-771"><a href="#cb98-771" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Individual Covariate Tests: Test balance one-by-one</span>
<span id="cb98-772"><a href="#cb98-772" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Joint Omnibus Test: Test that all covariates are jointly balanced (often combined with tests on each covariate)</span>
<span id="cb98-773"><a href="#cb98-773" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Regression-Based Tests: Regress treatment assignment on each covariate. Also allows you to control for strata or matched pair fixed effects.</span>
<span id="cb98-774"><a href="#cb98-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-775"><a href="#cb98-775" aria-hidden="true" tabindex="-1"></a><span class="fu">### Individual Covariate Tests</span></span>
<span id="cb98-776"><a href="#cb98-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-777"><a href="#cb98-777" aria-hidden="true" tabindex="-1"></a>The most common approach is to test each covariate separately: - t-tests for continuous variables - Chi-square tests for categorical variables</span>
<span id="cb98-778"><a href="#cb98-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-779"><a href="#cb98-779" aria-hidden="true" tabindex="-1"></a>Let's demonstrate this with data from the strata randomization example.</span>
<span id="cb98-780"><a href="#cb98-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-783"><a href="#cb98-783" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-784"><a href="#cb98-784" aria-hidden="true" tabindex="-1"></a><span class="co"># List of all baseline covariates to test</span></span>
<span id="cb98-785"><a href="#cb98-785" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"education"</span>, <span class="st">"female"</span>, <span class="st">"income"</span>, <span class="st">"rural"</span>, <span class="st">"chronic_disease"</span>, <span class="st">"satisfaction"</span>)</span>
<span id="cb98-786"><a href="#cb98-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-787"><a href="#cb98-787" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to perform t-tests and create a formatted results table</span></span>
<span id="cb98-788"><a href="#cb98-788" aria-hidden="true" tabindex="-1"></a>run_ttests <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, title) {</span>
<span id="cb98-789"><a href="#cb98-789" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb98-790"><a href="#cb98-790" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">character</span>(),</span>
<span id="cb98-791"><a href="#cb98-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">character</span>(),</span>
<span id="cb98-792"><a href="#cb98-792" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_control =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-793"><a href="#cb98-793" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_treated =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-794"><a href="#cb98-794" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-795"><a href="#cb98-795" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-796"><a href="#cb98-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> <span class="fu">character</span>()</span>
<span id="cb98-797"><a href="#cb98-797" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-798"><a href="#cb98-798" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-799"><a href="#cb98-799" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> baseline_vars) {</span>
<span id="cb98-800"><a href="#cb98-800" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For categorical variables (factor), we need to handle differently</span></span>
<span id="cb98-801"><a href="#cb98-801" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.factor</span>(dt[[var]])) {</span>
<span id="cb98-802"><a href="#cb98-802" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For each level of the factor</span></span>
<span id="cb98-803"><a href="#cb98-803" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (level <span class="cf">in</span> <span class="fu">levels</span>(dt[[var]])) {</span>
<span id="cb98-804"><a href="#cb98-804" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create temporary binary indicator</span></span>
<span id="cb98-805"><a href="#cb98-805" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">get</span>(var) <span class="sc">==</span> level)]</span>
<span id="cb98-806"><a href="#cb98-806" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-807"><a href="#cb98-807" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate means</span></span>
<span id="cb98-808"><a href="#cb98-808" aria-hidden="true" tabindex="-1"></a>        mean_control <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">mean</span>(temp)]</span>
<span id="cb98-809"><a href="#cb98-809" aria-hidden="true" tabindex="-1"></a>        mean_treated <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(temp)]</span>
<span id="cb98-810"><a href="#cb98-810" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-811"><a href="#cb98-811" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run t-test</span></span>
<span id="cb98-812"><a href="#cb98-812" aria-hidden="true" tabindex="-1"></a>        t_result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(dt[treatment <span class="sc">==</span> <span class="dv">1</span>, temp], </span>
<span id="cb98-813"><a href="#cb98-813" aria-hidden="true" tabindex="-1"></a>                           dt[treatment <span class="sc">==</span> <span class="dv">0</span>, temp])</span>
<span id="cb98-814"><a href="#cb98-814" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-815"><a href="#cb98-815" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add to results</span></span>
<span id="cb98-816"><a href="#cb98-816" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-817"><a href="#cb98-817" aria-hidden="true" tabindex="-1"></a>          <span class="at">variable =</span> <span class="fu">paste0</span>(var, <span class="st">": "</span>, level),</span>
<span id="cb98-818"><a href="#cb98-818" aria-hidden="true" tabindex="-1"></a>          <span class="at">method =</span> title,</span>
<span id="cb98-819"><a href="#cb98-819" aria-hidden="true" tabindex="-1"></a>          <span class="at">mean_control =</span> mean_control,</span>
<span id="cb98-820"><a href="#cb98-820" aria-hidden="true" tabindex="-1"></a>          <span class="at">mean_treated =</span> mean_treated,</span>
<span id="cb98-821"><a href="#cb98-821" aria-hidden="true" tabindex="-1"></a>          <span class="at">diff =</span> mean_treated <span class="sc">-</span> mean_control,</span>
<span id="cb98-822"><a href="#cb98-822" aria-hidden="true" tabindex="-1"></a>          <span class="at">p_value =</span> t_result<span class="sc">$</span>p.value,</span>
<span id="cb98-823"><a href="#cb98-823" aria-hidden="true" tabindex="-1"></a>          <span class="at">significant =</span> <span class="fu">ifelse</span>(t_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-824"><a href="#cb98-824" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb98-825"><a href="#cb98-825" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-826"><a href="#cb98-826" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove temporary variable</span></span>
<span id="cb98-827"><a href="#cb98-827" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb98-828"><a href="#cb98-828" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-829"><a href="#cb98-829" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb98-830"><a href="#cb98-830" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For continuous and binary variables</span></span>
<span id="cb98-831"><a href="#cb98-831" aria-hidden="true" tabindex="-1"></a>      mean_control <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">mean</span>(<span class="fu">get</span>(var), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb98-832"><a href="#cb98-832" aria-hidden="true" tabindex="-1"></a>      mean_treated <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(<span class="fu">get</span>(var), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb98-833"><a href="#cb98-833" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-834"><a href="#cb98-834" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Run t-test</span></span>
<span id="cb98-835"><a href="#cb98-835" aria-hidden="true" tabindex="-1"></a>      t_result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(</span>
<span id="cb98-836"><a href="#cb98-836" aria-hidden="true" tabindex="-1"></a>        dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">get</span>(var)], </span>
<span id="cb98-837"><a href="#cb98-837" aria-hidden="true" tabindex="-1"></a>        dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">get</span>(var)]</span>
<span id="cb98-838"><a href="#cb98-838" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb98-839"><a href="#cb98-839" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-840"><a href="#cb98-840" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add to results</span></span>
<span id="cb98-841"><a href="#cb98-841" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-842"><a href="#cb98-842" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> var,</span>
<span id="cb98-843"><a href="#cb98-843" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> title,</span>
<span id="cb98-844"><a href="#cb98-844" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_control =</span> mean_control,</span>
<span id="cb98-845"><a href="#cb98-845" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_treated =</span> mean_treated,</span>
<span id="cb98-846"><a href="#cb98-846" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff =</span> mean_treated <span class="sc">-</span> mean_control,</span>
<span id="cb98-847"><a href="#cb98-847" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_value =</span> t_result<span class="sc">$</span>p.value,</span>
<span id="cb98-848"><a href="#cb98-848" aria-hidden="true" tabindex="-1"></a>        <span class="at">significant =</span> <span class="fu">ifelse</span>(t_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-849"><a href="#cb98-849" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb98-850"><a href="#cb98-850" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-851"><a href="#cb98-851" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-852"><a href="#cb98-852" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-853"><a href="#cb98-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb98-854"><a href="#cb98-854" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-855"><a href="#cb98-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-856"><a href="#cb98-856" aria-hidden="true" tabindex="-1"></a><span class="co"># Run t-tests for all randomization methods</span></span>
<span id="cb98-857"><a href="#cb98-857" aria-hidden="true" tabindex="-1"></a>ttest_strat <span class="ot">&lt;-</span> <span class="fu">run_ttests</span>(dt_strat, <span class="st">"Stratified - t-test"</span>)</span>
<span id="cb98-858"><a href="#cb98-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-859"><a href="#cb98-859" aria-hidden="true" tabindex="-1"></a><span class="co">#Display Result</span></span>
<span id="cb98-860"><a href="#cb98-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-861"><a href="#cb98-861" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-862"><a href="#cb98-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-863"><a href="#cb98-863" aria-hidden="true" tabindex="-1"></a><span class="fu">### Joint Omnibus Tests</span></span>
<span id="cb98-864"><a href="#cb98-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-865"><a href="#cb98-865" aria-hidden="true" tabindex="-1"></a>F-tests can test multiple covariates simultaneously, reducing the multiple testing problem.</span>
<span id="cb98-866"><a href="#cb98-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-869"><a href="#cb98-869" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-870"><a href="#cb98-870" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to perform F-test</span></span>
<span id="cb98-871"><a href="#cb98-871" aria-hidden="true" tabindex="-1"></a>joint_balance_test <span class="ot">&lt;-</span> <span class="cf">function</span>(dt) {</span>
<span id="cb98-872"><a href="#cb98-872" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Regress treatment on covariates</span></span>
<span id="cb98-873"><a href="#cb98-873" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> income <span class="sc">+</span> female <span class="sc">+</span> education <span class="sc">+</span> chronic_disease, </span>
<span id="cb98-874"><a href="#cb98-874" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> dt)</span>
<span id="cb98-875"><a href="#cb98-875" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-876"><a href="#cb98-876" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract F-statistic and p-value for joint significance</span></span>
<span id="cb98-877"><a href="#cb98-877" aria-hidden="true" tabindex="-1"></a>  f_test <span class="ot">&lt;-</span> <span class="fu">summary</span>(model)<span class="sc">$</span>fstatistic</span>
<span id="cb98-878"><a href="#cb98-878" aria-hidden="true" tabindex="-1"></a>  f_value <span class="ot">&lt;-</span> f_test[<span class="dv">1</span>]</span>
<span id="cb98-879"><a href="#cb98-879" aria-hidden="true" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> f_test[<span class="dv">2</span>]</span>
<span id="cb98-880"><a href="#cb98-880" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> f_test[<span class="dv">3</span>]</span>
<span id="cb98-881"><a href="#cb98-881" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">&lt;-</span> <span class="fu">pf</span>(f_value, df1, df2, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb98-882"><a href="#cb98-882" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-883"><a href="#cb98-883" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb98-884"><a href="#cb98-884" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_value =</span> f_value,</span>
<span id="cb98-885"><a href="#cb98-885" aria-hidden="true" tabindex="-1"></a>    <span class="at">df1 =</span> df1,</span>
<span id="cb98-886"><a href="#cb98-886" aria-hidden="true" tabindex="-1"></a>    <span class="at">df2 =</span> df2,</span>
<span id="cb98-887"><a href="#cb98-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> p_value</span>
<span id="cb98-888"><a href="#cb98-888" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-889"><a href="#cb98-889" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-890"><a href="#cb98-890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb98-891"><a href="#cb98-891" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-892"><a href="#cb98-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-893"><a href="#cb98-893" aria-hidden="true" tabindex="-1"></a><span class="co"># Run joint test</span></span>
<span id="cb98-894"><a href="#cb98-894" aria-hidden="true" tabindex="-1"></a>joint_test <span class="ot">&lt;-</span> <span class="fu">joint_balance_test</span>(dt_strat)</span>
<span id="cb98-895"><a href="#cb98-895" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Joint balance test (F-test):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-896"><a href="#cb98-896" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"F("</span>, joint_test<span class="sc">$</span>df1, <span class="st">","</span>, joint_test<span class="sc">$</span>df2, <span class="st">") = "</span>, </span>
<span id="cb98-897"><a href="#cb98-897" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(joint_test<span class="sc">$</span>f_value, <span class="dv">2</span>), <span class="st">", p = "</span>, <span class="fu">round</span>(joint_test<span class="sc">$</span>p_value, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb98-898"><a href="#cb98-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-899"><a href="#cb98-899" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-900"><a href="#cb98-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-901"><a href="#cb98-901" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regression-Based Tests</span></span>
<span id="cb98-902"><a href="#cb98-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-903"><a href="#cb98-903" aria-hidden="true" tabindex="-1"></a>Regress treatment assignment on each covariate; if randomization worked, coefficients should be insignificant.</span>
<span id="cb98-904"><a href="#cb98-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-905"><a href="#cb98-905" aria-hidden="true" tabindex="-1"></a>Again, we'll use the data created for the stratified randomization example. First, let's look at this approach not controlling for strata fixed effects:</span>
<span id="cb98-906"><a href="#cb98-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-909"><a href="#cb98-909" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-910"><a href="#cb98-910" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest) <span class="co"># For fixed effects</span></span>
<span id="cb98-911"><a href="#cb98-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-912"><a href="#cb98-912" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to perform OLS regressions without strata fixed effects</span></span>
<span id="cb98-913"><a href="#cb98-913" aria-hidden="true" tabindex="-1"></a>run_ols_no_strata <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, title) {</span>
<span id="cb98-914"><a href="#cb98-914" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb98-915"><a href="#cb98-915" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">character</span>(),</span>
<span id="cb98-916"><a href="#cb98-916" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">character</span>(),</span>
<span id="cb98-917"><a href="#cb98-917" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficient =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-918"><a href="#cb98-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_error =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-919"><a href="#cb98-919" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-920"><a href="#cb98-920" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> <span class="fu">character</span>()</span>
<span id="cb98-921"><a href="#cb98-921" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-922"><a href="#cb98-922" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-923"><a href="#cb98-923" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> baseline_vars) {</span>
<span id="cb98-924"><a href="#cb98-924" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle factor variables</span></span>
<span id="cb98-925"><a href="#cb98-925" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.factor</span>(dt[[var]])) {</span>
<span id="cb98-926"><a href="#cb98-926" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create one-hot encoding</span></span>
<span id="cb98-927"><a href="#cb98-927" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (level <span class="cf">in</span> <span class="fu">levels</span>(dt[[var]])[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">levels</span>(dt[[var]]))]) {  <span class="co"># Skip first level (reference)</span></span>
<span id="cb98-928"><a href="#cb98-928" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">get</span>(var) <span class="sc">==</span> level)]</span>
<span id="cb98-929"><a href="#cb98-929" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-930"><a href="#cb98-930" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run regression</span></span>
<span id="cb98-931"><a href="#cb98-931" aria-hidden="true" tabindex="-1"></a>        reg <span class="ot">&lt;-</span> <span class="fu">feols</span>(temp <span class="sc">~</span> treatment, <span class="at">data =</span> dt)</span>
<span id="cb98-932"><a href="#cb98-932" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-933"><a href="#cb98-933" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add to results</span></span>
<span id="cb98-934"><a href="#cb98-934" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-935"><a href="#cb98-935" aria-hidden="true" tabindex="-1"></a>          <span class="at">variable =</span> <span class="fu">paste0</span>(var, <span class="st">": "</span>, level, <span class="st">" vs "</span>, <span class="fu">levels</span>(dt[[var]])[<span class="dv">1</span>]),</span>
<span id="cb98-936"><a href="#cb98-936" aria-hidden="true" tabindex="-1"></a>          <span class="at">method =</span> title,</span>
<span id="cb98-937"><a href="#cb98-937" aria-hidden="true" tabindex="-1"></a>          <span class="at">coefficient =</span> <span class="fu">coef</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-938"><a href="#cb98-938" aria-hidden="true" tabindex="-1"></a>          <span class="at">std_error =</span> <span class="fu">se</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-939"><a href="#cb98-939" aria-hidden="true" tabindex="-1"></a>          <span class="at">p_value =</span> <span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-940"><a href="#cb98-940" aria-hidden="true" tabindex="-1"></a>          <span class="at">significant =</span> <span class="fu">ifelse</span>(<span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-941"><a href="#cb98-941" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb98-942"><a href="#cb98-942" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-943"><a href="#cb98-943" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove temporary variable</span></span>
<span id="cb98-944"><a href="#cb98-944" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb98-945"><a href="#cb98-945" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-946"><a href="#cb98-946" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb98-947"><a href="#cb98-947" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For continuous and binary variables</span></span>
<span id="cb98-948"><a href="#cb98-948" aria-hidden="true" tabindex="-1"></a>      formula_str <span class="ot">&lt;-</span> <span class="fu">paste0</span>(var, <span class="st">" ~ treatment"</span>)</span>
<span id="cb98-949"><a href="#cb98-949" aria-hidden="true" tabindex="-1"></a>      reg <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> dt)</span>
<span id="cb98-950"><a href="#cb98-950" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-951"><a href="#cb98-951" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add to results</span></span>
<span id="cb98-952"><a href="#cb98-952" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-953"><a href="#cb98-953" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> var,</span>
<span id="cb98-954"><a href="#cb98-954" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> title,</span>
<span id="cb98-955"><a href="#cb98-955" aria-hidden="true" tabindex="-1"></a>        <span class="at">coefficient =</span> <span class="fu">coef</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-956"><a href="#cb98-956" aria-hidden="true" tabindex="-1"></a>        <span class="at">std_error =</span> <span class="fu">se</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-957"><a href="#cb98-957" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_value =</span> <span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-958"><a href="#cb98-958" aria-hidden="true" tabindex="-1"></a>        <span class="at">significant =</span> <span class="fu">ifelse</span>(<span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-959"><a href="#cb98-959" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb98-960"><a href="#cb98-960" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-961"><a href="#cb98-961" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-962"><a href="#cb98-962" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-963"><a href="#cb98-963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb98-964"><a href="#cb98-964" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-965"><a href="#cb98-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-966"><a href="#cb98-966" aria-hidden="true" tabindex="-1"></a><span class="co"># Run OLS without strata for both randomization methods</span></span>
<span id="cb98-967"><a href="#cb98-967" aria-hidden="true" tabindex="-1"></a>ols_strat <span class="ot">&lt;-</span> <span class="fu">run_ols_no_strata</span>(dt_strat, <span class="st">"Stratified  - OLS no Strata FE"</span>)</span>
<span id="cb98-968"><a href="#cb98-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-969"><a href="#cb98-969" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb98-970"><a href="#cb98-970" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ols_strat)</span>
<span id="cb98-971"><a href="#cb98-971" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-972"><a href="#cb98-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-973"><a href="#cb98-973" aria-hidden="true" tabindex="-1"></a>These should be very close to the t-tests above.</span>
<span id="cb98-974"><a href="#cb98-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-975"><a href="#cb98-975" aria-hidden="true" tabindex="-1"></a>Now let's do this controlling for strata. The reason we'd want to do this is because, as we'll see later, we need to estimate the treatment effect following the way the randomization was done, period. In other words, these need to be aligned. So, if we want to test our balance on baseline covariates, estimate the treatment effect once we have the endline data, it makes sense to include strata fixed effects here.</span>
<span id="cb98-976"><a href="#cb98-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-979"><a href="#cb98-979" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-980"><a href="#cb98-980" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to perform OLS regressions with strata fixed effects</span></span>
<span id="cb98-981"><a href="#cb98-981" aria-hidden="true" tabindex="-1"></a>run_ols_with_strata <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, title) {</span>
<span id="cb98-982"><a href="#cb98-982" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb98-983"><a href="#cb98-983" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">character</span>(),</span>
<span id="cb98-984"><a href="#cb98-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">character</span>(),</span>
<span id="cb98-985"><a href="#cb98-985" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficient =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-986"><a href="#cb98-986" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_error =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-987"><a href="#cb98-987" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-988"><a href="#cb98-988" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> <span class="fu">character</span>()</span>
<span id="cb98-989"><a href="#cb98-989" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-990"><a href="#cb98-990" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-991"><a href="#cb98-991" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> baseline_vars) {</span>
<span id="cb98-992"><a href="#cb98-992" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle factor variables</span></span>
<span id="cb98-993"><a href="#cb98-993" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.factor</span>(dt[[var]])) {</span>
<span id="cb98-994"><a href="#cb98-994" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (level <span class="cf">in</span> <span class="fu">levels</span>(dt[[var]])[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">levels</span>(dt[[var]]))]) {  <span class="co"># Skip first level (reference)</span></span>
<span id="cb98-995"><a href="#cb98-995" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">get</span>(var) <span class="sc">==</span> level)]</span>
<span id="cb98-996"><a href="#cb98-996" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-997"><a href="#cb98-997" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run regression with strata fixed effects</span></span>
<span id="cb98-998"><a href="#cb98-998" aria-hidden="true" tabindex="-1"></a>        reg <span class="ot">&lt;-</span> <span class="fu">feols</span>(temp <span class="sc">~</span> treatment <span class="sc">|</span> strata, <span class="at">data =</span> dt)</span>
<span id="cb98-999"><a href="#cb98-999" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-1000"><a href="#cb98-1000" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add to results</span></span>
<span id="cb98-1001"><a href="#cb98-1001" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-1002"><a href="#cb98-1002" aria-hidden="true" tabindex="-1"></a>          <span class="at">variable =</span> <span class="fu">paste0</span>(var, <span class="st">": "</span>, level, <span class="st">" vs "</span>, <span class="fu">levels</span>(dt[[var]])[<span class="dv">1</span>]),</span>
<span id="cb98-1003"><a href="#cb98-1003" aria-hidden="true" tabindex="-1"></a>          <span class="at">method =</span> title,</span>
<span id="cb98-1004"><a href="#cb98-1004" aria-hidden="true" tabindex="-1"></a>          <span class="at">coefficient =</span> <span class="fu">coef</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-1005"><a href="#cb98-1005" aria-hidden="true" tabindex="-1"></a>          <span class="at">std_error =</span> <span class="fu">se</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-1006"><a href="#cb98-1006" aria-hidden="true" tabindex="-1"></a>          <span class="at">p_value =</span> <span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-1007"><a href="#cb98-1007" aria-hidden="true" tabindex="-1"></a>          <span class="at">significant =</span> <span class="fu">ifelse</span>(<span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-1008"><a href="#cb98-1008" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb98-1009"><a href="#cb98-1009" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-1010"><a href="#cb98-1010" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove temporary variable</span></span>
<span id="cb98-1011"><a href="#cb98-1011" aria-hidden="true" tabindex="-1"></a>        dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb98-1012"><a href="#cb98-1012" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-1013"><a href="#cb98-1013" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb98-1014"><a href="#cb98-1014" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For continuous and binary variables</span></span>
<span id="cb98-1015"><a href="#cb98-1015" aria-hidden="true" tabindex="-1"></a>      formula_str <span class="ot">&lt;-</span> <span class="fu">paste0</span>(var, <span class="st">" ~ treatment | strata"</span>)</span>
<span id="cb98-1016"><a href="#cb98-1016" aria-hidden="true" tabindex="-1"></a>      reg <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> dt)</span>
<span id="cb98-1017"><a href="#cb98-1017" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-1018"><a href="#cb98-1018" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add to results</span></span>
<span id="cb98-1019"><a href="#cb98-1019" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-1020"><a href="#cb98-1020" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> var,</span>
<span id="cb98-1021"><a href="#cb98-1021" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> title,</span>
<span id="cb98-1022"><a href="#cb98-1022" aria-hidden="true" tabindex="-1"></a>        <span class="at">coefficient =</span> <span class="fu">coef</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-1023"><a href="#cb98-1023" aria-hidden="true" tabindex="-1"></a>        <span class="at">std_error =</span> <span class="fu">se</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-1024"><a href="#cb98-1024" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_value =</span> <span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>],</span>
<span id="cb98-1025"><a href="#cb98-1025" aria-hidden="true" tabindex="-1"></a>        <span class="at">significant =</span> <span class="fu">ifelse</span>(<span class="fu">pvalue</span>(reg)[<span class="st">"treatment"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb98-1026"><a href="#cb98-1026" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb98-1027"><a href="#cb98-1027" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-1028"><a href="#cb98-1028" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-1029"><a href="#cb98-1029" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1030"><a href="#cb98-1030" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb98-1031"><a href="#cb98-1031" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-1032"><a href="#cb98-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1033"><a href="#cb98-1033" aria-hidden="true" tabindex="-1"></a><span class="co"># Run OLS with strata/pair fixed effects</span></span>
<span id="cb98-1034"><a href="#cb98-1034" aria-hidden="true" tabindex="-1"></a>ols_strat_fe <span class="ot">&lt;-</span> <span class="fu">run_ols_with_strata</span>(dt_strat, <span class="st">"Stratified - OLS with strata FE"</span>)</span>
<span id="cb98-1035"><a href="#cb98-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1036"><a href="#cb98-1036" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb98-1037"><a href="#cb98-1037" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ols_strat_fe)</span>
<span id="cb98-1038"><a href="#cb98-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1039"><a href="#cb98-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1040"><a href="#cb98-1040" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb98-1041"><a href="#cb98-1041" aria-hidden="true" tabindex="-1"></a>Notice the regressions for education variables are not computing. Why do you think this is?</span>
<span id="cb98-1042"><a href="#cb98-1042" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb98-1043"><a href="#cb98-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1044"><a href="#cb98-1044" aria-hidden="true" tabindex="-1"></a><span class="fu">### Standardized Differences</span></span>
<span id="cb98-1045"><a href="#cb98-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1046"><a href="#cb98-1046" aria-hidden="true" tabindex="-1"></a>For large samples, p-values become less informative as tiny imbalances become statistically significant. Standardized mean differences (SMDs) provide a sample size-independent measure:</span>
<span id="cb98-1047"><a href="#cb98-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1048"><a href="#cb98-1048" aria-hidden="true" tabindex="-1"></a>$$SMD = \frac{\bar{X}_{treatment} - \bar{X}_{control}}{\sqrt{\frac{s^2_{treatment} + s^2_{control}}{2}}}$$</span>
<span id="cb98-1049"><a href="#cb98-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1050"><a href="#cb98-1050" aria-hidden="true" tabindex="-1"></a>A common rule of thumb is that an absolute SMD less than 0.1 indicates negligible imbalance.</span>
<span id="cb98-1051"><a href="#cb98-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1054"><a href="#cb98-1054" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1055"><a href="#cb98-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate standardized differences </span></span>
<span id="cb98-1056"><a href="#cb98-1056" aria-hidden="true" tabindex="-1"></a>standardized_diff <span class="ot">&lt;-</span> <span class="cf">function</span>(dt) {</span>
<span id="cb98-1057"><a href="#cb98-1057" aria-hidden="true" tabindex="-1"></a>  covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"income"</span>, <span class="st">"female"</span>, <span class="st">"chronic_disease"</span>)</span>
<span id="cb98-1058"><a href="#cb98-1058" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb98-1059"><a href="#cb98-1059" aria-hidden="true" tabindex="-1"></a>    <span class="at">covariate =</span> <span class="fu">character</span>(),</span>
<span id="cb98-1060"><a href="#cb98-1060" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_treated =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-1061"><a href="#cb98-1061" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_control =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-1062"><a href="#cb98-1062" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_treated =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-1063"><a href="#cb98-1063" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_control =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-1064"><a href="#cb98-1064" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_diff =</span> <span class="fu">numeric</span>(),</span>
<span id="cb98-1065"><a href="#cb98-1065" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb98-1066"><a href="#cb98-1066" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-1067"><a href="#cb98-1067" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1068"><a href="#cb98-1068" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (cov <span class="cf">in</span> covariates) {</span>
<span id="cb98-1069"><a href="#cb98-1069" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate means and SDs by group</span></span>
<span id="cb98-1070"><a href="#cb98-1070" aria-hidden="true" tabindex="-1"></a>    treated <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">get</span>(cov)]  <span class="co"># Use get() to retrieve column dynamically</span></span>
<span id="cb98-1071"><a href="#cb98-1071" aria-hidden="true" tabindex="-1"></a>    control <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">get</span>(cov)]  <span class="co"># Use get() to retrieve column dynamically</span></span>
<span id="cb98-1072"><a href="#cb98-1072" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-1073"><a href="#cb98-1073" aria-hidden="true" tabindex="-1"></a>    mean_treated <span class="ot">&lt;-</span> <span class="fu">mean</span>(treated, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-1074"><a href="#cb98-1074" aria-hidden="true" tabindex="-1"></a>    mean_control <span class="ot">&lt;-</span> <span class="fu">mean</span>(control, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-1075"><a href="#cb98-1075" aria-hidden="true" tabindex="-1"></a>    sd_treated <span class="ot">&lt;-</span> <span class="fu">sd</span>(treated, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-1076"><a href="#cb98-1076" aria-hidden="true" tabindex="-1"></a>    sd_control <span class="ot">&lt;-</span> <span class="fu">sd</span>(control, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-1077"><a href="#cb98-1077" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-1078"><a href="#cb98-1078" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate standardized difference</span></span>
<span id="cb98-1079"><a href="#cb98-1079" aria-hidden="true" tabindex="-1"></a>    pooled_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((sd_treated<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> sd_control<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb98-1080"><a href="#cb98-1080" aria-hidden="true" tabindex="-1"></a>    std_diff <span class="ot">&lt;-</span> (mean_treated <span class="sc">-</span> mean_control) <span class="sc">/</span> pooled_sd</span>
<span id="cb98-1081"><a href="#cb98-1081" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-1082"><a href="#cb98-1082" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-1083"><a href="#cb98-1083" aria-hidden="true" tabindex="-1"></a>      <span class="at">covariate =</span> cov,</span>
<span id="cb98-1084"><a href="#cb98-1084" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_treated =</span> mean_treated,</span>
<span id="cb98-1085"><a href="#cb98-1085" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_control =</span> mean_control,</span>
<span id="cb98-1086"><a href="#cb98-1086" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_treated =</span> sd_treated,</span>
<span id="cb98-1087"><a href="#cb98-1087" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_control =</span> sd_control,</span>
<span id="cb98-1088"><a href="#cb98-1088" aria-hidden="true" tabindex="-1"></a>      <span class="at">std_diff =</span> std_diff</span>
<span id="cb98-1089"><a href="#cb98-1089" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb98-1090"><a href="#cb98-1090" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-1091"><a href="#cb98-1091" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1092"><a href="#cb98-1092" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle education separately (categorical variable)</span></span>
<span id="cb98-1093"><a href="#cb98-1093" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"education"</span> <span class="sc">%in%</span> <span class="fu">names</span>(dt)) {</span>
<span id="cb98-1094"><a href="#cb98-1094" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each level of education</span></span>
<span id="cb98-1095"><a href="#cb98-1095" aria-hidden="true" tabindex="-1"></a>    edu_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(dt<span class="sc">$</span>education)</span>
<span id="cb98-1096"><a href="#cb98-1096" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (level <span class="cf">in</span> edu_levels) {</span>
<span id="cb98-1097"><a href="#cb98-1097" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create indicator for this level</span></span>
<span id="cb98-1098"><a href="#cb98-1098" aria-hidden="true" tabindex="-1"></a>      dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(education <span class="sc">==</span> level)]</span>
<span id="cb98-1099"><a href="#cb98-1099" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-1100"><a href="#cb98-1100" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate means by group</span></span>
<span id="cb98-1101"><a href="#cb98-1101" aria-hidden="true" tabindex="-1"></a>      treated <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(temp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb98-1102"><a href="#cb98-1102" aria-hidden="true" tabindex="-1"></a>      control <span class="ot">&lt;-</span> dt[treatment <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">mean</span>(temp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb98-1103"><a href="#cb98-1103" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-1104"><a href="#cb98-1104" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For proportions, the SD is sqrt(p*(1-p))</span></span>
<span id="cb98-1105"><a href="#cb98-1105" aria-hidden="true" tabindex="-1"></a>      sd_treated <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(treated <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>treated))</span>
<span id="cb98-1106"><a href="#cb98-1106" aria-hidden="true" tabindex="-1"></a>      sd_control <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(control <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>control))</span>
<span id="cb98-1107"><a href="#cb98-1107" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-1108"><a href="#cb98-1108" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate standardized difference</span></span>
<span id="cb98-1109"><a href="#cb98-1109" aria-hidden="true" tabindex="-1"></a>      pooled_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((sd_treated<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> sd_control<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb98-1110"><a href="#cb98-1110" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Avoid division by zero</span></span>
<span id="cb98-1111"><a href="#cb98-1111" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (pooled_sd <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb98-1112"><a href="#cb98-1112" aria-hidden="true" tabindex="-1"></a>        std_diff <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-1113"><a href="#cb98-1113" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb98-1114"><a href="#cb98-1114" aria-hidden="true" tabindex="-1"></a>        std_diff <span class="ot">&lt;-</span> (treated <span class="sc">-</span> control) <span class="sc">/</span> pooled_sd</span>
<span id="cb98-1115"><a href="#cb98-1115" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-1116"><a href="#cb98-1116" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-1117"><a href="#cb98-1117" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.table</span>(</span>
<span id="cb98-1118"><a href="#cb98-1118" aria-hidden="true" tabindex="-1"></a>        <span class="at">covariate =</span> <span class="fu">paste0</span>(<span class="st">"education: "</span>, level),</span>
<span id="cb98-1119"><a href="#cb98-1119" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_treated =</span> treated,</span>
<span id="cb98-1120"><a href="#cb98-1120" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_control =</span> control,</span>
<span id="cb98-1121"><a href="#cb98-1121" aria-hidden="true" tabindex="-1"></a>        <span class="at">sd_treated =</span> sd_treated,</span>
<span id="cb98-1122"><a href="#cb98-1122" aria-hidden="true" tabindex="-1"></a>        <span class="at">sd_control =</span> sd_control,</span>
<span id="cb98-1123"><a href="#cb98-1123" aria-hidden="true" tabindex="-1"></a>        <span class="at">std_diff =</span> std_diff</span>
<span id="cb98-1124"><a href="#cb98-1124" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb98-1125"><a href="#cb98-1125" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb98-1126"><a href="#cb98-1126" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Remove temporary variable</span></span>
<span id="cb98-1127"><a href="#cb98-1127" aria-hidden="true" tabindex="-1"></a>      dt[, temp <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb98-1128"><a href="#cb98-1128" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-1129"><a href="#cb98-1129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-1130"><a href="#cb98-1130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1131"><a href="#cb98-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb98-1132"><a href="#cb98-1132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-1133"><a href="#cb98-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1134"><a href="#cb98-1134" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate standardized differences</span></span>
<span id="cb98-1135"><a href="#cb98-1135" aria-hidden="true" tabindex="-1"></a>std_diffs <span class="ot">&lt;-</span> <span class="fu">standardized_diff</span>(dt_strat)</span>
<span id="cb98-1136"><a href="#cb98-1136" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(std_diffs)</span>
<span id="cb98-1137"><a href="#cb98-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1138"><a href="#cb98-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1139"><a href="#cb98-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1140"><a href="#cb98-1140" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comprehensive "Table 1"</span></span>
<span id="cb98-1141"><a href="#cb98-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1142"><a href="#cb98-1142" aria-hidden="true" tabindex="-1"></a>Now, let's create a comprehensive "Table 1" for the stratified random sample</span>
<span id="cb98-1143"><a href="#cb98-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1146"><a href="#cb98-1146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1147"><a href="#cb98-1147" aria-hidden="true" tabindex="-1"></a><span class="co"># Install and load required packages</span></span>
<span id="cb98-1148"><a href="#cb98-1148" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb98-1149"><a href="#cb98-1149" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb98-1150"><a href="#cb98-1150" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb98-1151"><a href="#cb98-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1152"><a href="#cb98-1152" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate standardized differences for stratified randomization</span></span>
<span id="cb98-1153"><a href="#cb98-1153" aria-hidden="true" tabindex="-1"></a>std_diff_strat <span class="ot">&lt;-</span> <span class="fu">standardized_diff</span>(dt_strat)</span>
<span id="cb98-1154"><a href="#cb98-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1155"><a href="#cb98-1155" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to extract p-values from all balance tests</span></span>
<span id="cb98-1156"><a href="#cb98-1156" aria-hidden="true" tabindex="-1"></a>extract_pvalues <span class="ot">&lt;-</span> <span class="cf">function</span>(test_results) {</span>
<span id="cb98-1157"><a href="#cb98-1157" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> test_results[, .(variable, p_value)]</span>
<span id="cb98-1158"><a href="#cb98-1158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(results, <span class="st">"variable"</span>, <span class="st">"covariate"</span>)</span>
<span id="cb98-1159"><a href="#cb98-1159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb98-1160"><a href="#cb98-1160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-1161"><a href="#cb98-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1162"><a href="#cb98-1162" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract p-values from different testing approaches for stratified randomization</span></span>
<span id="cb98-1163"><a href="#cb98-1163" aria-hidden="true" tabindex="-1"></a>pvals_strat_ttest <span class="ot">&lt;-</span> <span class="fu">extract_pvalues</span>(ttest_strat)</span>
<span id="cb98-1164"><a href="#cb98-1164" aria-hidden="true" tabindex="-1"></a>pvals_strat_ttest[, approach <span class="sc">:</span><span class="er">=</span> <span class="st">"t-test"</span>]</span>
<span id="cb98-1165"><a href="#cb98-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1166"><a href="#cb98-1166" aria-hidden="true" tabindex="-1"></a>pvals_strat_ols <span class="ot">&lt;-</span> <span class="fu">extract_pvalues</span>(ols_strat)</span>
<span id="cb98-1167"><a href="#cb98-1167" aria-hidden="true" tabindex="-1"></a>pvals_strat_ols[, approach <span class="sc">:</span><span class="er">=</span> <span class="st">"OLS (no strata FE)"</span>]</span>
<span id="cb98-1168"><a href="#cb98-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1169"><a href="#cb98-1169" aria-hidden="true" tabindex="-1"></a>pvals_strat_ols_fe <span class="ot">&lt;-</span> <span class="fu">extract_pvalues</span>(ols_strat_fe)</span>
<span id="cb98-1170"><a href="#cb98-1170" aria-hidden="true" tabindex="-1"></a>pvals_strat_ols_fe[, approach <span class="sc">:</span><span class="er">=</span> <span class="st">"OLS (with strata FE)"</span>]</span>
<span id="cb98-1171"><a href="#cb98-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1172"><a href="#cb98-1172" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all p-values for stratified randomization</span></span>
<span id="cb98-1173"><a href="#cb98-1173" aria-hidden="true" tabindex="-1"></a>strat_pvals <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb98-1174"><a href="#cb98-1174" aria-hidden="true" tabindex="-1"></a>  pvals_strat_ttest,</span>
<span id="cb98-1175"><a href="#cb98-1175" aria-hidden="true" tabindex="-1"></a>  pvals_strat_ols,</span>
<span id="cb98-1176"><a href="#cb98-1176" aria-hidden="true" tabindex="-1"></a>  pvals_strat_ols_fe</span>
<span id="cb98-1177"><a href="#cb98-1177" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-1178"><a href="#cb98-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1179"><a href="#cb98-1179" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a wide format of p-values</span></span>
<span id="cb98-1180"><a href="#cb98-1180" aria-hidden="true" tabindex="-1"></a>pvals_wide <span class="ot">&lt;-</span> strat_pvals <span class="sc">%&gt;%</span></span>
<span id="cb98-1181"><a href="#cb98-1181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb98-1182"><a href="#cb98-1182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb98-1183"><a href="#cb98-1183" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> covariate,</span>
<span id="cb98-1184"><a href="#cb98-1184" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> approach,</span>
<span id="cb98-1185"><a href="#cb98-1185" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> p_value</span>
<span id="cb98-1186"><a href="#cb98-1186" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-1187"><a href="#cb98-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1188"><a href="#cb98-1188" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with standardized differences</span></span>
<span id="cb98-1189"><a href="#cb98-1189" aria-hidden="true" tabindex="-1"></a>strat_balance_table <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb98-1190"><a href="#cb98-1190" aria-hidden="true" tabindex="-1"></a>  std_diff_strat, </span>
<span id="cb98-1191"><a href="#cb98-1191" aria-hidden="true" tabindex="-1"></a>  pvals_wide,</span>
<span id="cb98-1192"><a href="#cb98-1192" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"covariate"</span>, </span>
<span id="cb98-1193"><a href="#cb98-1193" aria-hidden="true" tabindex="-1"></a>  <span class="at">all =</span> <span class="cn">TRUE</span></span>
<span id="cb98-1194"><a href="#cb98-1194" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-1195"><a href="#cb98-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1196"><a href="#cb98-1196" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark significant values with asterisks directly in the data</span></span>
<span id="cb98-1197"><a href="#cb98-1197" aria-hidden="true" tabindex="-1"></a>strat_balance_table <span class="ot">&lt;-</span> strat_balance_table <span class="sc">%&gt;%</span></span>
<span id="cb98-1198"><a href="#cb98-1198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb98-1199"><a href="#cb98-1199" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_diff_mark =</span> <span class="fu">ifelse</span>(<span class="fu">abs</span>(std_diff) <span class="sc">&gt;</span> <span class="fl">0.25</span>, </span>
<span id="cb98-1200"><a href="#cb98-1200" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">round</span>(std_diff, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>), <span class="st">"†"</span>), </span>
<span id="cb98-1201"><a href="#cb98-1201" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">format</span>(<span class="fu">round</span>(std_diff, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>)),</span>
<span id="cb98-1202"><a href="#cb98-1202" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">t-test_mark</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">t-test</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>, </span>
<span id="cb98-1203"><a href="#cb98-1203" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">round</span>(<span class="st">`</span><span class="at">t-test</span><span class="st">`</span>, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>), <span class="st">"*"</span>), </span>
<span id="cb98-1204"><a href="#cb98-1204" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">format</span>(<span class="fu">round</span>(<span class="st">`</span><span class="at">t-test</span><span class="st">`</span>, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>)),</span>
<span id="cb98-1205"><a href="#cb98-1205" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">OLS (no strata FE)_mark</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">OLS (no strata FE)</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>, </span>
<span id="cb98-1206"><a href="#cb98-1206" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">round</span>(<span class="st">`</span><span class="at">OLS (no strata FE)</span><span class="st">`</span>, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>), <span class="st">"*"</span>), </span>
<span id="cb98-1207"><a href="#cb98-1207" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">format</span>(<span class="fu">round</span>(<span class="st">`</span><span class="at">OLS (no strata FE)</span><span class="st">`</span>, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>)),</span>
<span id="cb98-1208"><a href="#cb98-1208" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">OLS (with strata FE)_mark</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">OLS (with strata FE)</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>, </span>
<span id="cb98-1209"><a href="#cb98-1209" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">round</span>(<span class="st">`</span><span class="at">OLS (with strata FE)</span><span class="st">`</span>, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>), <span class="st">"*"</span>), </span>
<span id="cb98-1210"><a href="#cb98-1210" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">format</span>(<span class="fu">round</span>(<span class="st">`</span><span class="at">OLS (with strata FE)</span><span class="st">`</span>, <span class="dv">3</span>), <span class="at">nsmall=</span><span class="dv">3</span>))</span>
<span id="cb98-1211"><a href="#cb98-1211" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-1212"><a href="#cb98-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1213"><a href="#cb98-1213" aria-hidden="true" tabindex="-1"></a><span class="co"># Create gt table with the marked columns</span></span>
<span id="cb98-1214"><a href="#cb98-1214" aria-hidden="true" tabindex="-1"></a>strat_balance_table <span class="sc">%&gt;%</span></span>
<span id="cb98-1215"><a href="#cb98-1215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(covariate, std_diff_mark, <span class="st">`</span><span class="at">t-test_mark</span><span class="st">`</span>, <span class="st">`</span><span class="at">OLS (no strata FE)_mark</span><span class="st">`</span>, <span class="st">`</span><span class="at">OLS (with strata FE)_mark</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-1216"><a href="#cb98-1216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb98-1217"><a href="#cb98-1217" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename columns</span></span>
<span id="cb98-1218"><a href="#cb98-1218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb98-1219"><a href="#cb98-1219" aria-hidden="true" tabindex="-1"></a>    <span class="at">covariate =</span> <span class="st">"Baseline Covariate"</span>,</span>
<span id="cb98-1220"><a href="#cb98-1220" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_diff_mark =</span> <span class="st">"Standardized Difference"</span>,</span>
<span id="cb98-1221"><a href="#cb98-1221" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">t-test_mark</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"t-test"</span>,</span>
<span id="cb98-1222"><a href="#cb98-1222" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">OLS (no strata FE)_mark</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"OLS (standard)"</span>,</span>
<span id="cb98-1223"><a href="#cb98-1223" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">OLS (with strata FE)_mark</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"OLS (with strata FE)"</span></span>
<span id="cb98-1224"><a href="#cb98-1224" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb98-1225"><a href="#cb98-1225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add column spanners for organization</span></span>
<span id="cb98-1226"><a href="#cb98-1226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb98-1227"><a href="#cb98-1227" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Balance Measure"</span>,</span>
<span id="cb98-1228"><a href="#cb98-1228" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="st">"std_diff_mark"</span></span>
<span id="cb98-1229"><a href="#cb98-1229" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb98-1230"><a href="#cb98-1230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb98-1231"><a href="#cb98-1231" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"P-values by Testing Approach"</span>,</span>
<span id="cb98-1232"><a href="#cb98-1232" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"t-test_mark"</span>, <span class="st">"OLS (no strata FE)_mark"</span>, <span class="st">"OLS (with strata FE)_mark"</span>)</span>
<span id="cb98-1233"><a href="#cb98-1233" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb98-1234"><a href="#cb98-1234" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add title and footnotes</span></span>
<span id="cb98-1235"><a href="#cb98-1235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb98-1236"><a href="#cb98-1236" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Table 1: Balance Assessment in Stratified Randomization"</span>,</span>
<span id="cb98-1237"><a href="#cb98-1237" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparison of Different Testing Approaches"</span></span>
<span id="cb98-1238"><a href="#cb98-1238" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb98-1239"><a href="#cb98-1239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_footnote</span>(</span>
<span id="cb98-1240"><a href="#cb98-1240" aria-hidden="true" tabindex="-1"></a>    <span class="at">footnote =</span> <span class="st">"† Standardized differences &gt;0.25, indicating potential imbalance."</span>,</span>
<span id="cb98-1241"><a href="#cb98-1241" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>(<span class="at">columns =</span> <span class="st">"std_diff_mark"</span>)</span>
<span id="cb98-1242"><a href="#cb98-1242" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb98-1243"><a href="#cb98-1243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_footnote</span>(</span>
<span id="cb98-1244"><a href="#cb98-1244" aria-hidden="true" tabindex="-1"></a>    <span class="at">footnote =</span> <span class="st">"* P-values &lt;0.05, indicating statistically significant differences."</span>,</span>
<span id="cb98-1245"><a href="#cb98-1245" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="st">"P-values by Testing Approach"</span>)</span>
<span id="cb98-1246"><a href="#cb98-1246" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb98-1247"><a href="#cb98-1247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_footnote</span>(</span>
<span id="cb98-1248"><a href="#cb98-1248" aria-hidden="true" tabindex="-1"></a>    <span class="at">footnote =</span> <span class="st">"OLS with strata fixed effects is the most appropriate approach given the stratified design."</span>,</span>
<span id="cb98-1249"><a href="#cb98-1249" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>(<span class="at">columns =</span> <span class="st">"OLS (with strata FE)_mark"</span>)</span>
<span id="cb98-1250"><a href="#cb98-1250" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb98-1251"><a href="#cb98-1251" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Nicer formatting</span></span>
<span id="cb98-1252"><a href="#cb98-1252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(</span>
<span id="cb98-1253"><a href="#cb98-1253" aria-hidden="true" tabindex="-1"></a>    <span class="at">column_labels.font.weight =</span> <span class="st">"bold"</span>,</span>
<span id="cb98-1254"><a href="#cb98-1254" aria-hidden="true" tabindex="-1"></a>    <span class="at">column_labels.background.color =</span> <span class="st">"#EEEEEE"</span>,</span>
<span id="cb98-1255"><a href="#cb98-1255" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.width =</span> <span class="fu">pct</span>(<span class="dv">100</span>),</span>
<span id="cb98-1256"><a href="#cb98-1256" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.background.color =</span> <span class="st">"#E6F0FF"</span>,</span>
<span id="cb98-1257"><a href="#cb98-1257" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.title.font.size =</span> <span class="fu">px</span>(<span class="dv">16</span>),</span>
<span id="cb98-1258"><a href="#cb98-1258" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.subtitle.font.size =</span> <span class="fu">px</span>(<span class="dv">14</span>)</span>
<span id="cb98-1259"><a href="#cb98-1259" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-1260"><a href="#cb98-1260" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1261"><a href="#cb98-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1262"><a href="#cb98-1262" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpreting Balance Results</span></span>
<span id="cb98-1263"><a href="#cb98-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1264"><a href="#cb98-1264" aria-hidden="true" tabindex="-1"></a>When reviewing balance tables, it's important to consider:</span>
<span id="cb98-1265"><a href="#cb98-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1266"><a href="#cb98-1266" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Statistical vs. Practical Significance**: With large samples, even tiny differences can be statistically significant. Focus on the magnitude of differences (SMD) rather than p-values.</span>
<span id="cb98-1267"><a href="#cb98-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1268"><a href="#cb98-1268" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Multiple Testing**: With many covariates, expect some to show "significant" differences by chance. This is why joint tests and SMDs are often more informative.</span>
<span id="cb98-1269"><a href="#cb98-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1270"><a href="#cb98-1270" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Key Predictors**: Pay special attention to covariates that strongly predict outcomes. Imbalance on these variables is more concerning.</span>
<span id="cb98-1271"><a href="#cb98-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1272"><a href="#cb98-1272" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Visual Inspection**: Sometimes graphical displays of covariate distributions can complement statistical tests. Consider density plots or boxplots comparing treatment and control.</span>
<span id="cb98-1273"><a href="#cb98-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1274"><a href="#cb98-1274" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**Overall Assessment**: Look at the pattern of results rather than focusing on any single test. If multiple measures suggest imbalance on important predictors, consider covariate adjustment in analysis.</span>
<span id="cb98-1275"><a href="#cb98-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1276"><a href="#cb98-1276" aria-hidden="true" tabindex="-1"></a>Let's create visual assessments of balance as well:</span>
<span id="cb98-1277"><a href="#cb98-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1278"><a href="#cb98-1278" aria-hidden="true" tabindex="-1"></a><span class="fu"># Plot the proportion treated in each stratum</span></span>
<span id="cb98-1279"><a href="#cb98-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1282"><a href="#cb98-1282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1283"><a href="#cb98-1283" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb98-1284"><a href="#cb98-1284" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb98-1285"><a href="#cb98-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1286"><a href="#cb98-1286" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize treatment assignment by strata</span></span>
<span id="cb98-1287"><a href="#cb98-1287" aria-hidden="true" tabindex="-1"></a>strata_summary <span class="ot">&lt;-</span> dt_strat[, .(</span>
<span id="cb98-1288"><a href="#cb98-1288" aria-hidden="true" tabindex="-1"></a>  <span class="at">count =</span> .N,</span>
<span id="cb98-1289"><a href="#cb98-1289" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_treated =</span> <span class="fu">sum</span>(treatment),</span>
<span id="cb98-1290"><a href="#cb98-1290" aria-hidden="true" tabindex="-1"></a>  <span class="at">pct_treated =</span> <span class="fu">mean</span>(treatment) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb98-1291"><a href="#cb98-1291" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> strata]</span>
<span id="cb98-1292"><a href="#cb98-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1293"><a href="#cb98-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1294"><a href="#cb98-1294" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(strata_summary, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(strata), <span class="at">y =</span> pct_treated)) <span class="sc">+</span></span>
<span id="cb98-1295"><a href="#cb98-1295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb98-1296"><a href="#cb98-1296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">50</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb98-1297"><a href="#cb98-1297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1298"><a href="#cb98-1298" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Treatment Assignment by Strata in Stratified Randomization"</span>,</span>
<span id="cb98-1299"><a href="#cb98-1299" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red line indicates 50% treatment assignment"</span>,</span>
<span id="cb98-1300"><a href="#cb98-1300" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Strata ID"</span>,</span>
<span id="cb98-1301"><a href="#cb98-1301" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percent Treated (%)"</span></span>
<span id="cb98-1302"><a href="#cb98-1302" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1303"><a href="#cb98-1303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb98-1304"><a href="#cb98-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1305"><a href="#cb98-1305" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb98-1306"><a href="#cb98-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1307"><a href="#cb98-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1308"><a href="#cb98-1308" aria-hidden="true" tabindex="-1"></a><span class="fu"># Compare age distribution by treatment status for all randomization methods</span></span>
<span id="cb98-1309"><a href="#cb98-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1312"><a href="#cb98-1312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1313"><a href="#cb98-1313" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dt_bern, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(treatment), <span class="at">y =</span> age)) <span class="sc">+</span></span>
<span id="cb98-1314"><a href="#cb98-1314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb98-1315"><a href="#cb98-1315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1316"><a href="#cb98-1316" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Age Distribution by Treatment (Bernoulli Randomization)"</span>,</span>
<span id="cb98-1317"><a href="#cb98-1317" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb98-1318"><a href="#cb98-1318" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Age"</span></span>
<span id="cb98-1319"><a href="#cb98-1319" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1320"><a href="#cb98-1320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb98-1321"><a href="#cb98-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1322"><a href="#cb98-1322" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dt_cr, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(treatment), <span class="at">y =</span> age)) <span class="sc">+</span></span>
<span id="cb98-1323"><a href="#cb98-1323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb98-1324"><a href="#cb98-1324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1325"><a href="#cb98-1325" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Age Distribution by Treatment (Complete Randomization)"</span>,</span>
<span id="cb98-1326"><a href="#cb98-1326" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb98-1327"><a href="#cb98-1327" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Age"</span></span>
<span id="cb98-1328"><a href="#cb98-1328" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1329"><a href="#cb98-1329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb98-1330"><a href="#cb98-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1331"><a href="#cb98-1331" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dt_rerand_threshold, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(treatment), <span class="at">y =</span> age)) <span class="sc">+</span></span>
<span id="cb98-1332"><a href="#cb98-1332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"lightpink"</span>) <span class="sc">+</span></span>
<span id="cb98-1333"><a href="#cb98-1333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1334"><a href="#cb98-1334" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Age Distribution by Treatment (Re-randomization - Threshold)"</span>,</span>
<span id="cb98-1335"><a href="#cb98-1335" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb98-1336"><a href="#cb98-1336" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Age"</span></span>
<span id="cb98-1337"><a href="#cb98-1337" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1338"><a href="#cb98-1338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb98-1339"><a href="#cb98-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1340"><a href="#cb98-1340" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dt_rerand_optimal, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(treatment), <span class="at">y =</span> age)) <span class="sc">+</span></span>
<span id="cb98-1341"><a href="#cb98-1341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"lightyellow"</span>) <span class="sc">+</span></span>
<span id="cb98-1342"><a href="#cb98-1342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1343"><a href="#cb98-1343" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Age Distribution by Treatment (Re-randomization - Optimization)"</span>,</span>
<span id="cb98-1344"><a href="#cb98-1344" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb98-1345"><a href="#cb98-1345" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Age"</span></span>
<span id="cb98-1346"><a href="#cb98-1346" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1347"><a href="#cb98-1347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb98-1348"><a href="#cb98-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1349"><a href="#cb98-1349" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dt_strat, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(treatment), <span class="at">y =</span> age)) <span class="sc">+</span></span>
<span id="cb98-1350"><a href="#cb98-1350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"lightgreen"</span>) <span class="sc">+</span></span>
<span id="cb98-1351"><a href="#cb98-1351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1352"><a href="#cb98-1352" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Age Distribution by Treatment (Stratified Randomization)"</span>,</span>
<span id="cb98-1353"><a href="#cb98-1353" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb98-1354"><a href="#cb98-1354" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Age"</span></span>
<span id="cb98-1355"><a href="#cb98-1355" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1356"><a href="#cb98-1356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb98-1357"><a href="#cb98-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1358"><a href="#cb98-1358" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dt_matched, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(treatment), <span class="at">y =</span> age)) <span class="sc">+</span></span>
<span id="cb98-1359"><a href="#cb98-1359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"lightsalmon"</span>) <span class="sc">+</span></span>
<span id="cb98-1360"><a href="#cb98-1360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1361"><a href="#cb98-1361" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Age Distribution by Treatment (Matched Randomization)"</span>,</span>
<span id="cb98-1362"><a href="#cb98-1362" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb98-1363"><a href="#cb98-1363" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Age"</span></span>
<span id="cb98-1364"><a href="#cb98-1364" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1365"><a href="#cb98-1365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb98-1366"><a href="#cb98-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1367"><a href="#cb98-1367" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the boxplots</span></span>
<span id="cb98-1368"><a href="#cb98-1368" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p1)</span>
<span id="cb98-1369"><a href="#cb98-1369" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p2)</span>
<span id="cb98-1370"><a href="#cb98-1370" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p3)</span>
<span id="cb98-1371"><a href="#cb98-1371" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p4)</span>
<span id="cb98-1372"><a href="#cb98-1372" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p5)</span>
<span id="cb98-1373"><a href="#cb98-1373" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p6)</span>
<span id="cb98-1374"><a href="#cb98-1374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1375"><a href="#cb98-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1376"><a href="#cb98-1376" aria-hidden="true" tabindex="-1"></a><span class="fu"># Visualize matched pairs (first 20 pairs)</span></span>
<span id="cb98-1377"><a href="#cb98-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1380"><a href="#cb98-1380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1381"><a href="#cb98-1381" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize matched pairs (first 20 pairs) with jittering</span></span>
<span id="cb98-1382"><a href="#cb98-1382" aria-hidden="true" tabindex="-1"></a>sample_pairs <span class="ot">&lt;-</span> dt_matched[pair_id <span class="sc">&lt;=</span> <span class="dv">20</span>]</span>
<span id="cb98-1383"><a href="#cb98-1383" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sample_pairs, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(pair_id), <span class="at">y =</span> age, <span class="at">color =</span> <span class="fu">factor</span>(treatment))) <span class="sc">+</span></span>
<span id="cb98-1384"><a href="#cb98-1384" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add jitter to horizontal position, keep vertical position exact</span></span>
<span id="cb98-1385"><a href="#cb98-1385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">height =</span> <span class="dv">0</span>), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb98-1386"><a href="#cb98-1386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1387"><a href="#cb98-1387" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Age within Matched Pairs (First 20 Pairs)"</span>,</span>
<span id="cb98-1388"><a href="#cb98-1388" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pair ID"</span>,</span>
<span id="cb98-1389"><a href="#cb98-1389" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Age"</span>,</span>
<span id="cb98-1390"><a href="#cb98-1390" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Treatment"</span></span>
<span id="cb98-1391"><a href="#cb98-1391" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1392"><a href="#cb98-1392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"red"</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Treatment"</span>)) <span class="sc">+</span></span>
<span id="cb98-1393"><a href="#cb98-1393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb98-1394"><a href="#cb98-1394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span>
<span id="cb98-1395"><a href="#cb98-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1396"><a href="#cb98-1396" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p6)</span>
<span id="cb98-1397"><a href="#cb98-1397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1398"><a href="#cb98-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1399"><a href="#cb98-1399" aria-hidden="true" tabindex="-1"></a><span class="fu"># Compare balance across methods with a p-value visualization</span></span>
<span id="cb98-1400"><a href="#cb98-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1403"><a href="#cb98-1403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1404"><a href="#cb98-1404" aria-hidden="true" tabindex="-1"></a>ttest_strat <span class="ot">&lt;-</span> <span class="fu">run_ttests</span>(dt_strat, <span class="st">"Stratified - t-test"</span>)</span>
<span id="cb98-1405"><a href="#cb98-1405" aria-hidden="true" tabindex="-1"></a>ttest_rerand_threshold <span class="ot">&lt;-</span> <span class="fu">run_ttests</span>(dt_rerand_threshold, <span class="st">"ReRand Threshold - t-test"</span>)</span>
<span id="cb98-1406"><a href="#cb98-1406" aria-hidden="true" tabindex="-1"></a>ttest_rerand_optimal <span class="ot">&lt;-</span> <span class="fu">run_ttests</span>(dt_rerand_optimal, <span class="st">"ReRand Optimal - t-test"</span>)</span>
<span id="cb98-1407"><a href="#cb98-1407" aria-hidden="true" tabindex="-1"></a>ttest_matched <span class="ot">&lt;-</span> <span class="fu">run_ttests</span>(dt_matched, <span class="st">"Matched - t-test"</span>)</span>
<span id="cb98-1408"><a href="#cb98-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1409"><a href="#cb98-1409" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all results</span></span>
<span id="cb98-1410"><a href="#cb98-1410" aria-hidden="true" tabindex="-1"></a>all_ttest_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(ttest_bern, ttest_cr, ttest_rerand_threshold, ttest_rerand_optimal, ttest_strat, ttest_matched)</span>
<span id="cb98-1411"><a href="#cb98-1411" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb98-1412"><a href="#cb98-1412" aria-hidden="true" tabindex="-1"></a>method_order <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Bernoulli - t-test"</span>, </span>
<span id="cb98-1413"><a href="#cb98-1413" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Complete - t-test"</span>,</span>
<span id="cb98-1414"><a href="#cb98-1414" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"ReRand Threshold - t-test"</span>, </span>
<span id="cb98-1415"><a href="#cb98-1415" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"ReRand Optimal - t-test"</span>,</span>
<span id="cb98-1416"><a href="#cb98-1416" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Stratified - t-test"</span>, </span>
<span id="cb98-1417"><a href="#cb98-1417" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Matched - t-test"</span>)</span>
<span id="cb98-1418"><a href="#cb98-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1419"><a href="#cb98-1419" aria-hidden="true" tabindex="-1"></a>balance_viz_data <span class="ot">&lt;-</span> all_ttest_results[method <span class="sc">%in%</span> method_order, </span>
<span id="cb98-1420"><a href="#cb98-1420" aria-hidden="true" tabindex="-1"></a>                                    .(variable, method, p_value)]</span>
<span id="cb98-1421"><a href="#cb98-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1422"><a href="#cb98-1422" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder methods for better visualization</span></span>
<span id="cb98-1423"><a href="#cb98-1423" aria-hidden="true" tabindex="-1"></a>balance_viz_data[, method <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(method, <span class="at">levels =</span> method_order)]</span>
<span id="cb98-1424"><a href="#cb98-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1425"><a href="#cb98-1425" aria-hidden="true" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(balance_viz_data, <span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> <span class="fu">reorder</span>(variable, <span class="sc">-</span>p_value), <span class="at">fill =</span> p_value)) <span class="sc">+</span></span>
<span id="cb98-1426"><a href="#cb98-1426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb98-1427"><a href="#cb98-1427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"red"</span>, <span class="at">mid =</span> <span class="st">"yellow"</span>, <span class="at">high =</span> <span class="st">"green"</span>, </span>
<span id="cb98-1428"><a href="#cb98-1428" aria-hidden="true" tabindex="-1"></a>                      <span class="at">midpoint =</span> <span class="fl">0.5</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb98-1429"><a href="#cb98-1429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(p_value, <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb98-1430"><a href="#cb98-1430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-1431"><a href="#cb98-1431" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Balance Test P-values Across Randomization Methods"</span>,</span>
<span id="cb98-1432"><a href="#cb98-1432" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Randomization Method"</span>,</span>
<span id="cb98-1433"><a href="#cb98-1433" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Variable"</span>,</span>
<span id="cb98-1434"><a href="#cb98-1434" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"P-value"</span></span>
<span id="cb98-1435"><a href="#cb98-1435" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-1436"><a href="#cb98-1436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb98-1437"><a href="#cb98-1437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb98-1438"><a href="#cb98-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1439"><a href="#cb98-1439" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p7)</span>
<span id="cb98-1440"><a href="#cb98-1440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1441"><a href="#cb98-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1442"><a href="#cb98-1442" aria-hidden="true" tabindex="-1"></a>This combination of numerical metrics and visual displays provides a comprehensive assessment of balance.</span>
<span id="cb98-1443"><a href="#cb98-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1444"><a href="#cb98-1444" aria-hidden="true" tabindex="-1"></a><span class="fu">## Complex Experimental Designs</span></span>
<span id="cb98-1445"><a href="#cb98-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1446"><a href="#cb98-1446" aria-hidden="true" tabindex="-1"></a>Beyond the basic approaches, several complex randomization designs address specific research challenges:</span>
<span id="cb98-1447"><a href="#cb98-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1448"><a href="#cb98-1448" aria-hidden="true" tabindex="-1"></a><span class="fu">### Units of Randomization &amp; Spillovers</span></span>
<span id="cb98-1449"><a href="#cb98-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1450"><a href="#cb98-1450" aria-hidden="true" tabindex="-1"></a>A critical decision is choosing what entity (e.g. person or cluster) to randomize:</span>
<span id="cb98-1451"><a href="#cb98-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1452"><a href="#cb98-1452" aria-hidden="true" tabindex="-1"></a>**Key considerations:**</span>
<span id="cb98-1453"><a href="#cb98-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1454"><a href="#cb98-1454" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Match observational unit when possible</span>
<span id="cb98-1455"><a href="#cb98-1455" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Align with treatment delivery</span>
<span id="cb98-1456"><a href="#cb98-1456" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Minimize spillovers</span>
<span id="cb98-1457"><a href="#cb98-1457" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Consider statistical power</span>
<span id="cb98-1458"><a href="#cb98-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1459"><a href="#cb98-1459" aria-hidden="true" tabindex="-1"></a>**Common units:**</span>
<span id="cb98-1460"><a href="#cb98-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1461"><a href="#cb98-1461" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Individual**: Patients, students</span>
<span id="cb98-1462"><a href="#cb98-1462" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Cluster**: Villages, clinics, schools</span>
<span id="cb98-1463"><a href="#cb98-1463" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Time periods**: Days, weeks, shifts</span>
<span id="cb98-1464"><a href="#cb98-1464" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Networks**: Households, peer groups</span>
<span id="cb98-1465"><a href="#cb98-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1466"><a href="#cb98-1466" aria-hidden="true" tabindex="-1"></a>The tradeoff is often between statistical power (favoring individual randomization) and internal validity (which may require cluster randomization to minimize spillovers).</span>
<span id="cb98-1467"><a href="#cb98-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1468"><a href="#cb98-1468" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Spillover Problem</span></span>
<span id="cb98-1469"><a href="#cb98-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1470"><a href="#cb98-1470" aria-hidden="true" tabindex="-1"></a>Spillovers occur when treatment affects untreated units, through:</span>
<span id="cb98-1471"><a href="#cb98-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1472"><a href="#cb98-1472" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Direct interaction between units</span>
<span id="cb98-1473"><a href="#cb98-1473" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>General equilibrium effects</span>
<span id="cb98-1474"><a href="#cb98-1474" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Information diffusion</span>
<span id="cb98-1475"><a href="#cb98-1475" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Resource competition</span>
<span id="cb98-1476"><a href="#cb98-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1477"><a href="#cb98-1477" aria-hidden="true" tabindex="-1"></a>When spillovers are a concern, randomization at a higher level (clustering) can help minimize unwanted contamination. Alternatively, a two-stage randomization design can help measure spillover effects explicitly.</span>
<span id="cb98-1478"><a href="#cb98-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1479"><a href="#cb98-1479" aria-hidden="true" tabindex="-1"></a><span class="fu">### Two-Stage Randomization for Measuring Spillovers</span></span>
<span id="cb98-1480"><a href="#cb98-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1481"><a href="#cb98-1481" aria-hidden="true" tabindex="-1"></a>This approach:</span>
<span id="cb98-1482"><a href="#cb98-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1483"><a href="#cb98-1483" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>First randomizes clusters to high or low treatment intensity</span>
<span id="cb98-1484"><a href="#cb98-1484" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Then randomizes individuals within clusters to treatment or control</span>
<span id="cb98-1485"><a href="#cb98-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1486"><a href="#cb98-1486" aria-hidden="true" tabindex="-1"></a>This design allows measurement of:</span>
<span id="cb98-1487"><a href="#cb98-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1488"><a href="#cb98-1488" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Direct treatment effects</span>
<span id="cb98-1489"><a href="#cb98-1489" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Within-cluster spillovers</span>
<span id="cb98-1490"><a href="#cb98-1490" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Between-cluster spillovers</span>
<span id="cb98-1491"><a href="#cb98-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1492"><a href="#cb98-1492" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cluster Randomization</span></span>
<span id="cb98-1493"><a href="#cb98-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1494"><a href="#cb98-1494" aria-hidden="true" tabindex="-1"></a>Cluster randomization assigns groups rather than individuals to treatment conditions: (we saw this last unit)</span>
<span id="cb98-1495"><a href="#cb98-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1496"><a href="#cb98-1496" aria-hidden="true" tabindex="-1"></a>**Examples of clusters:**</span>
<span id="cb98-1497"><a href="#cb98-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1498"><a href="#cb98-1498" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Schools</span>
<span id="cb98-1499"><a href="#cb98-1499" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Clinics</span>
<span id="cb98-1500"><a href="#cb98-1500" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Villages</span>
<span id="cb98-1501"><a href="#cb98-1501" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Neighborhoods</span>
<span id="cb98-1502"><a href="#cb98-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1503"><a href="#cb98-1503" aria-hidden="true" tabindex="-1"></a>The key parameter affecting statistical power is the intraclass correlation coefficient (ICC), which measures how correlated outcomes are within clusters. The design effect formula shows how clustering reduces effective sample size:</span>
<span id="cb98-1504"><a href="#cb98-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1505"><a href="#cb98-1505" aria-hidden="true" tabindex="-1"></a>$$DE = 1 + (m-1) \times ICC$$</span>
<span id="cb98-1506"><a href="#cb98-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1507"><a href="#cb98-1507" aria-hidden="true" tabindex="-1"></a>where $m$ is the average cluster size. A larger design effect means a larger required sample size to achieve the same power.</span>
<span id="cb98-1508"><a href="#cb98-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1509"><a href="#cb98-1509" aria-hidden="true" tabindex="-1"></a>Analysis needs to account for clustering through one of:</span>
<span id="cb98-1510"><a href="#cb98-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1511"><a href="#cb98-1511" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Cluster-robust standard errors</span>
<span id="cb98-1512"><a href="#cb98-1512" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Mixed-effects models</span>
<span id="cb98-1513"><a href="#cb98-1513" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Generalized estimating equations (GEE)</span>
<span id="cb98-1514"><a href="#cb98-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1515"><a href="#cb98-1515" aria-hidden="true" tabindex="-1"></a><span class="fu">### Factorial Designs: Testing Multiple Treatments</span></span>
<span id="cb98-1516"><a href="#cb98-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1517"><a href="#cb98-1517" aria-hidden="true" tabindex="-1"></a>Factorial designs test multiple interventions simultaneously:</span>
<span id="cb98-1518"><a href="#cb98-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1519"><a href="#cb98-1519" aria-hidden="true" tabindex="-1"></a>| Intervention B | No Intervention A | Intervention A |</span>
<span id="cb98-1520"><a href="#cb98-1520" aria-hidden="true" tabindex="-1"></a>|----------------|-------------------|----------------|</span>
<span id="cb98-1521"><a href="#cb98-1521" aria-hidden="true" tabindex="-1"></a>| **No**         | Control           | A only         |</span>
<span id="cb98-1522"><a href="#cb98-1522" aria-hidden="true" tabindex="-1"></a>| **Yes**        | B only            | A and B        |</span>
<span id="cb98-1523"><a href="#cb98-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1524"><a href="#cb98-1524" aria-hidden="true" tabindex="-1"></a>This approach:</span>
<span id="cb98-1525"><a href="#cb98-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1526"><a href="#cb98-1526" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Tests multiple treatments simultaneously</span>
<span id="cb98-1527"><a href="#cb98-1527" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Estimates main effects AND interactions</span>
<span id="cb98-1528"><a href="#cb98-1528" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Uses resources efficiently</span>
<span id="cb98-1529"><a href="#cb98-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1530"><a href="#cb98-1530" aria-hidden="true" tabindex="-1"></a>For example, with two interventions (A and B), we have four groups:</span>
<span id="cb98-1531"><a href="#cb98-1531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1532"><a href="#cb98-1532" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>No intervention (control)</span>
<span id="cb98-1533"><a href="#cb98-1533" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Intervention A only</span>
<span id="cb98-1534"><a href="#cb98-1534" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Intervention B only</span>
<span id="cb98-1535"><a href="#cb98-1535" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Both A and B</span>
<span id="cb98-1536"><a href="#cb98-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1537"><a href="#cb98-1537" aria-hidden="true" tabindex="-1"></a>Factorial designs are particularly valuable when:</span>
<span id="cb98-1538"><a href="#cb98-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1539"><a href="#cb98-1539" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>You want to test combinations of interventions</span>
<span id="cb98-1540"><a href="#cb98-1540" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>You suspect treatments might interact (enhance or interfere with each other)</span>
<span id="cb98-1541"><a href="#cb98-1541" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>You need to maximize efficiency with limited resources</span>
<span id="cb98-1542"><a href="#cb98-1542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1543"><a href="#cb98-1543" aria-hidden="true" tabindex="-1"></a>Here's how we might implement a 2×2 factorial design in R:</span>
<span id="cb98-1544"><a href="#cb98-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1547"><a href="#cb98-1547" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1548"><a href="#cb98-1548" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb98-1549"><a href="#cb98-1549" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">072311</span>)</span>
<span id="cb98-1550"><a href="#cb98-1550" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span>  <span class="co"># Total sample size</span></span>
<span id="cb98-1551"><a href="#cb98-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1552"><a href="#cb98-1552" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data table</span></span>
<span id="cb98-1553"><a href="#cb98-1553" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb98-1554"><a href="#cb98-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1555"><a href="#cb98-1555" aria-hidden="true" tabindex="-1"></a><span class="co"># First randomization for factor A</span></span>
<span id="cb98-1556"><a href="#cb98-1556" aria-hidden="true" tabindex="-1"></a>dt[, A <span class="sc">:</span><span class="er">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, n<span class="sc">/</span><span class="dv">2</span>), <span class="fu">rep</span>(<span class="dv">0</span>, n<span class="sc">/</span><span class="dv">2</span>))[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n)]]</span>
<span id="cb98-1557"><a href="#cb98-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1558"><a href="#cb98-1558" aria-hidden="true" tabindex="-1"></a><span class="co"># Second randomization for factor B</span></span>
<span id="cb98-1559"><a href="#cb98-1559" aria-hidden="true" tabindex="-1"></a>dt[, B <span class="sc">:</span><span class="er">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, n<span class="sc">/</span><span class="dv">2</span>), <span class="fu">rep</span>(<span class="dv">0</span>, n<span class="sc">/</span><span class="dv">2</span>))[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n)]]</span>
<span id="cb98-1560"><a href="#cb98-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1561"><a href="#cb98-1561" aria-hidden="true" tabindex="-1"></a><span class="co"># Create combined treatment variable</span></span>
<span id="cb98-1562"><a href="#cb98-1562" aria-hidden="true" tabindex="-1"></a>dt[, treatment <span class="sc">:</span><span class="er">=</span> <span class="fu">paste0</span>(<span class="st">"A"</span>, A, <span class="st">"B"</span>, B)]</span>
<span id="cb98-1563"><a href="#cb98-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1564"><a href="#cb98-1564" aria-hidden="true" tabindex="-1"></a><span class="co"># Check allocation</span></span>
<span id="cb98-1565"><a href="#cb98-1565" aria-hidden="true" tabindex="-1"></a>dt[, .N, by <span class="ot">=</span> treatment]</span>
<span id="cb98-1566"><a href="#cb98-1566" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1567"><a href="#cb98-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1568"><a href="#cb98-1568" aria-hidden="true" tabindex="-1"></a><span class="fu">### Randomized Phase-in Designs</span></span>
<span id="cb98-1569"><a href="#cb98-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1570"><a href="#cb98-1570" aria-hidden="true" tabindex="-1"></a>In randomized phase-in designs, all units eventually receive treatment, but the timing of treatment is randomized.</span>
<span id="cb98-1571"><a href="#cb98-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1572"><a href="#cb98-1572" aria-hidden="true" tabindex="-1"></a>**Advantages:**</span>
<span id="cb98-1573"><a href="#cb98-1573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1574"><a href="#cb98-1574" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Improves compliance since everyone gets treatment eventually</span>
<span id="cb98-1575"><a href="#cb98-1575" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Works well with resource constraints</span>
<span id="cb98-1576"><a href="#cb98-1576" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Offers a politically appealing compromise</span>
<span id="cb98-1577"><a href="#cb98-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1578"><a href="#cb98-1578" aria-hidden="true" tabindex="-1"></a>**Limitations:**</span>
<span id="cb98-1579"><a href="#cb98-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1580"><a href="#cb98-1580" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>May create anticipation effects</span>
<span id="cb98-1581"><a href="#cb98-1581" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Limits long-term impact measurement</span>
<span id="cb98-1582"><a href="#cb98-1582" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Eventually loses the control group</span>
<span id="cb98-1583"><a href="#cb98-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1584"><a href="#cb98-1584" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adaptive Randomization</span></span>
<span id="cb98-1585"><a href="#cb98-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1586"><a href="#cb98-1586" aria-hidden="true" tabindex="-1"></a>Adaptive designs update assignment probabilities based on accumulated data, balancing:</span>
<span id="cb98-1587"><a href="#cb98-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1588"><a href="#cb98-1588" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Exploration**: Learning which treatment works best</span>
<span id="cb98-1589"><a href="#cb98-1589" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Exploitation**: Assigning more units to better treatments</span>
<span id="cb98-1590"><a href="#cb98-1590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1591"><a href="#cb98-1591" aria-hidden="true" tabindex="-1"></a>The key <span class="sc">\*</span>ethical<span class="sc">\*\*</span> advantage is that fewer participants receive inferior treatments as evidence accumulates. We'll cover adaptive designs in more detail in a future lecture.</span>
<span id="cb98-1592"><a href="#cb98-1592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1593"><a href="#cb98-1593" aria-hidden="true" tabindex="-1"></a>A simple example of response-adaptive randomization might look like this:</span>
<span id="cb98-1594"><a href="#cb98-1594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1597"><a href="#cb98-1597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1598"><a href="#cb98-1598" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb98-1599"><a href="#cb98-1599" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified response-adaptive randomization simulation</span></span>
<span id="cb98-1600"><a href="#cb98-1600" aria-hidden="true" tabindex="-1"></a>simulate_adaptive_randomization <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_total =</span> <span class="dv">100</span>, </span>
<span id="cb98-1601"><a href="#cb98-1601" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">true_success_A =</span> <span class="fl">0.3</span>, </span>
<span id="cb98-1602"><a href="#cb98-1602" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">true_success_B =</span> <span class="fl">0.5</span>) {</span>
<span id="cb98-1603"><a href="#cb98-1603" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize data storage</span></span>
<span id="cb98-1604"><a href="#cb98-1604" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb98-1605"><a href="#cb98-1605" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n_total,</span>
<span id="cb98-1606"><a href="#cb98-1606" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> <span class="cn">NA</span>,</span>
<span id="cb98-1607"><a href="#cb98-1607" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="cn">NA</span></span>
<span id="cb98-1608"><a href="#cb98-1608" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-1609"><a href="#cb98-1609" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1610"><a href="#cb98-1610" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial equal assignment probabilities</span></span>
<span id="cb98-1611"><a href="#cb98-1611" aria-hidden="true" tabindex="-1"></a>  prob_A <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb98-1612"><a href="#cb98-1612" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1613"><a href="#cb98-1613" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Track successes and failures</span></span>
<span id="cb98-1614"><a href="#cb98-1614" aria-hidden="true" tabindex="-1"></a>  success_A <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-1615"><a href="#cb98-1615" aria-hidden="true" tabindex="-1"></a>  total_A <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-1616"><a href="#cb98-1616" aria-hidden="true" tabindex="-1"></a>  success_B <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-1617"><a href="#cb98-1617" aria-hidden="true" tabindex="-1"></a>  total_B <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-1618"><a href="#cb98-1618" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1619"><a href="#cb98-1619" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate sequential enrollment</span></span>
<span id="cb98-1620"><a href="#cb98-1620" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_total) {</span>
<span id="cb98-1621"><a href="#cb98-1621" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign treatment based on current probability</span></span>
<span id="cb98-1622"><a href="#cb98-1622" aria-hidden="true" tabindex="-1"></a>    treatment <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>), <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(prob_A, <span class="dv">1</span><span class="sc">-</span>prob_A))</span>
<span id="cb98-1623"><a href="#cb98-1623" aria-hidden="true" tabindex="-1"></a>    results<span class="sc">$</span>treatment[i] <span class="ot">&lt;-</span> treatment</span>
<span id="cb98-1624"><a href="#cb98-1624" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-1625"><a href="#cb98-1625" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate outcome based on true success rates</span></span>
<span id="cb98-1626"><a href="#cb98-1626" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (treatment <span class="sc">==</span> <span class="st">"A"</span>) {</span>
<span id="cb98-1627"><a href="#cb98-1627" aria-hidden="true" tabindex="-1"></a>      outcome <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, true_success_A)</span>
<span id="cb98-1628"><a href="#cb98-1628" aria-hidden="true" tabindex="-1"></a>      success_A <span class="ot">&lt;-</span> success_A <span class="sc">+</span> outcome</span>
<span id="cb98-1629"><a href="#cb98-1629" aria-hidden="true" tabindex="-1"></a>      total_A <span class="ot">&lt;-</span> total_A <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb98-1630"><a href="#cb98-1630" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb98-1631"><a href="#cb98-1631" aria-hidden="true" tabindex="-1"></a>      outcome <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, true_success_B)</span>
<span id="cb98-1632"><a href="#cb98-1632" aria-hidden="true" tabindex="-1"></a>      success_B <span class="ot">&lt;-</span> success_B <span class="sc">+</span> outcome</span>
<span id="cb98-1633"><a href="#cb98-1633" aria-hidden="true" tabindex="-1"></a>      total_B <span class="ot">&lt;-</span> total_B <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb98-1634"><a href="#cb98-1634" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-1635"><a href="#cb98-1635" aria-hidden="true" tabindex="-1"></a>    results<span class="sc">$</span>outcome[i] <span class="ot">&lt;-</span> outcome</span>
<span id="cb98-1636"><a href="#cb98-1636" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-1637"><a href="#cb98-1637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update probability for next assignment using Beta prior</span></span>
<span id="cb98-1638"><a href="#cb98-1638" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&lt;</span> n_total) {  <span class="co"># No need to update after last patient</span></span>
<span id="cb98-1639"><a href="#cb98-1639" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Beta-Bernoulli update (adding 1 for prior)</span></span>
<span id="cb98-1640"><a href="#cb98-1640" aria-hidden="true" tabindex="-1"></a>      prob_A <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>, success_A <span class="sc">+</span> <span class="dv">1</span>, total_A <span class="sc">-</span> success_A <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span></span>
<span id="cb98-1641"><a href="#cb98-1641" aria-hidden="true" tabindex="-1"></a>               (<span class="fu">rbeta</span>(<span class="dv">1</span>, success_A <span class="sc">+</span> <span class="dv">1</span>, total_A <span class="sc">-</span> success_A <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb98-1642"><a href="#cb98-1642" aria-hidden="true" tabindex="-1"></a>                <span class="fu">rbeta</span>(<span class="dv">1</span>, success_B <span class="sc">+</span> <span class="dv">1</span>, total_B <span class="sc">-</span> success_B <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb98-1643"><a href="#cb98-1643" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-1644"><a href="#cb98-1644" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-1645"><a href="#cb98-1645" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-1646"><a href="#cb98-1646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb98-1647"><a href="#cb98-1647" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-1648"><a href="#cb98-1648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1649"><a href="#cb98-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1650"><a href="#cb98-1650" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical Implementation Tips</span></span>
<span id="cb98-1651"><a href="#cb98-1651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1652"><a href="#cb98-1652" aria-hidden="true" tabindex="-1"></a>Regardless of which randomization approach you choose, follow these best practices:</span>
<span id="cb98-1653"><a href="#cb98-1653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1654"><a href="#cb98-1654" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Create a single entry per randomization unit</span>
<span id="cb98-1655"><a href="#cb98-1655" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Sort the file in a reproducible way</span>
<span id="cb98-1656"><a href="#cb98-1656" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Set and preserve a random seed</span>
<span id="cb98-1657"><a href="#cb98-1657" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Assign treatments</span>
<span id="cb98-1658"><a href="#cb98-1658" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>Save assignments securely</span>
<span id="cb98-1659"><a href="#cb98-1659" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>Test balance extensively</span>
<span id="cb98-1660"><a href="#cb98-1660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1661"><a href="#cb98-1661" aria-hidden="true" tabindex="-1"></a>Always document your randomization procedure thoroughly to enhance transparency and reproducibility.</span>
<span id="cb98-1662"><a href="#cb98-1662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1663"><a href="#cb98-1663" aria-hidden="true" tabindex="-1"></a>Below is a template for implementing and documenting randomization:</span>
<span id="cb98-1664"><a href="#cb98-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1667"><a href="#cb98-1667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1668"><a href="#cb98-1668" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb98-1669"><a href="#cb98-1669" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomization implementation template</span></span>
<span id="cb98-1670"><a href="#cb98-1670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1671"><a href="#cb98-1671" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Document parameters</span></span>
<span id="cb98-1672"><a href="#cb98-1672" aria-hidden="true" tabindex="-1"></a>study_name <span class="ot">&lt;-</span> <span class="st">"My Clinical Trial"</span></span>
<span id="cb98-1673"><a href="#cb98-1673" aria-hidden="true" tabindex="-1"></a>randomization_date <span class="ot">&lt;-</span> <span class="st">"2025-02-25"</span></span>
<span id="cb98-1674"><a href="#cb98-1674" aria-hidden="true" tabindex="-1"></a>randomization_conducted_by <span class="ot">&lt;-</span> <span class="st">"J. Smith"</span></span>
<span id="cb98-1675"><a href="#cb98-1675" aria-hidden="true" tabindex="-1"></a>random_seed <span class="ot">&lt;-</span> <span class="dv">072311</span>  <span class="co"># Document why this seed was chosen</span></span>
<span id="cb98-1676"><a href="#cb98-1676" aria-hidden="true" tabindex="-1"></a>allocation_ratio <span class="ot">&lt;-</span> <span class="fl">0.5</span>  <span class="co"># Equal allocation</span></span>
<span id="cb98-1677"><a href="#cb98-1677" aria-hidden="true" tabindex="-1"></a>stratification_variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"site"</span>, <span class="st">"gender"</span>)</span>
<span id="cb98-1678"><a href="#cb98-1678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1679"><a href="#cb98-1679" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Set up reproducible environment</span></span>
<span id="cb98-1680"><a href="#cb98-1680" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(random_seed)</span>
<span id="cb98-1681"><a href="#cb98-1681" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb98-1682"><a href="#cb98-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1683"><a href="#cb98-1683" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Load and prepare data</span></span>
<span id="cb98-1684"><a href="#cb98-1684" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"participant_data.csv"</span>)</span>
<span id="cb98-1685"><a href="#cb98-1685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1686"><a href="#cb98-1686" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Implement randomization</span></span>
<span id="cb98-1687"><a href="#cb98-1687" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: stratified randomization</span></span>
<span id="cb98-1688"><a href="#cb98-1688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1689"><a href="#cb98-1689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1690"><a href="#cb98-1690" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Check balance</span></span>
<span id="cb98-1691"><a href="#cb98-1691" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate Balance Table</span></span>
<span id="cb98-1692"><a href="#cb98-1692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1693"><a href="#cb98-1693" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Save results securely</span></span>
<span id="cb98-1694"><a href="#cb98-1694" aria-hidden="true" tabindex="-1"></a><span class="co"># a) Save randomization details</span></span>
<span id="cb98-1695"><a href="#cb98-1695" aria-hidden="true" tabindex="-1"></a>randomization_log <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb98-1696"><a href="#cb98-1696" aria-hidden="true" tabindex="-1"></a>  <span class="at">study_name =</span> study_name,</span>
<span id="cb98-1697"><a href="#cb98-1697" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> randomization_date,</span>
<span id="cb98-1698"><a href="#cb98-1698" aria-hidden="true" tabindex="-1"></a>  <span class="at">conducted_by =</span> randomization_conducted_by,</span>
<span id="cb98-1699"><a href="#cb98-1699" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> random_seed,</span>
<span id="cb98-1700"><a href="#cb98-1700" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"stratified"</span>,</span>
<span id="cb98-1701"><a href="#cb98-1701" aria-hidden="true" tabindex="-1"></a>  <span class="at">stratification_variables =</span> <span class="fu">paste</span>(stratification_variables, <span class="at">collapse =</span> <span class="st">", "</span>)</span>
<span id="cb98-1702"><a href="#cb98-1702" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-1703"><a href="#cb98-1703" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(randomization_log, <span class="st">"randomization_log.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb98-1704"><a href="#cb98-1704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1705"><a href="#cb98-1705" aria-hidden="true" tabindex="-1"></a><span class="co"># b) Save assignment data</span></span>
<span id="cb98-1706"><a href="#cb98-1706" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(</span>
<span id="cb98-1707"><a href="#cb98-1707" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, treatment, stratum_id), </span>
<span id="cb98-1708"><a href="#cb98-1708" aria-hidden="true" tabindex="-1"></a>  <span class="st">"treatment_assignments.csv"</span>, </span>
<span id="cb98-1709"><a href="#cb98-1709" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb98-1710"><a href="#cb98-1710" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-1711"><a href="#cb98-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1712"><a href="#cb98-1712" aria-hidden="true" tabindex="-1"></a><span class="co"># c) Save balance checks</span></span>
<span id="cb98-1713"><a href="#cb98-1713" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(balance_table, <span class="st">"balance_checks.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb98-1714"><a href="#cb98-1714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1715"><a href="#cb98-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1716"><a href="#cb98-1716" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ethical Considerations in Randomization</span></span>
<span id="cb98-1717"><a href="#cb98-1717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1718"><a href="#cb98-1718" aria-hidden="true" tabindex="-1"></a>Randomization raises several ethical considerations:</span>
<span id="cb98-1719"><a href="#cb98-1719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1720"><a href="#cb98-1720" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Long-term benefits** vs. short-term resource distribution</span>
<span id="cb98-1721"><a href="#cb98-1721" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Equity** in who receives potentially beneficial treatments</span>
<span id="cb98-1722"><a href="#cb98-1722" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Transparency** with participants about randomization</span>
<span id="cb98-1723"><a href="#cb98-1723" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Minimizing harm** from potentially ineffective interventions</span>
<span id="cb98-1724"><a href="#cb98-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1725"><a href="#cb98-1725" aria-hidden="true" tabindex="-1"></a>These issues must be carefully considered and addressed in the design phase. Specific approaches that can address ethical concerns include:</span>
<span id="cb98-1726"><a href="#cb98-1726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1727"><a href="#cb98-1727" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Randomized phase-in designs**: Ensures everyone eventually receives the intervention</span>
<span id="cb98-1728"><a href="#cb98-1728" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Adaptive randomization**: Skews allocation toward better-performing treatments over time</span>
<span id="cb98-1729"><a href="#cb98-1729" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Risk-based randomization**: Targets interventions toward those most likely to benefit (we'll cover in the future if time)</span>
<span id="cb98-1730"><a href="#cb98-1730" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Minimization of control group size**: Uses unequal allocation ratios to minimize the number of participants not receiving intervention (could add this consideration to optimal allocation)</span>
<span id="cb98-1731"><a href="#cb98-1731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1732"><a href="#cb98-1732" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion: Which Method When?</span></span>
<span id="cb98-1733"><a href="#cb98-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1734"><a href="#cb98-1734" aria-hidden="true" tabindex="-1"></a>There is no one-size-fits-all approach. The best randomization strategy depends on:</span>
<span id="cb98-1735"><a href="#cb98-1735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1736"><a href="#cb98-1736" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The research question</span>
<span id="cb98-1737"><a href="#cb98-1737" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Available baseline data</span>
<span id="cb98-1738"><a href="#cb98-1738" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Logistical constraints</span>
<span id="cb98-1739"><a href="#cb98-1739" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Expected heterogeneity in treatment effects</span>
<span id="cb98-1740"><a href="#cb98-1740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1741"><a href="#cb98-1741" aria-hidden="true" tabindex="-1"></a>| Approach         | When to Use              | Key Consideration          |</span>
<span id="cb98-1742"><a href="#cb98-1742" aria-hidden="true" tabindex="-1"></a>|------------------|--------------------------|----------------------------|</span>
<span id="cb98-1743"><a href="#cb98-1743" aria-hidden="true" tabindex="-1"></a>| Simple           | Large samples            | Simplicity                 |</span>
<span id="cb98-1744"><a href="#cb98-1744" aria-hidden="true" tabindex="-1"></a>| Stratified       | Strong predictors known  | Number of strata           |</span>
<span id="cb98-1745"><a href="#cb98-1745" aria-hidden="true" tabindex="-1"></a>| Matched-Pair     | Small samples            | Finding good matches       |</span>
<span id="cb98-1746"><a href="#cb98-1746" aria-hidden="true" tabindex="-1"></a>| Re-randomization | Balance is critical      | Complexity of inference    |</span>
<span id="cb98-1747"><a href="#cb98-1747" aria-hidden="true" tabindex="-1"></a>| Cluster          | Group-level intervention | ICC and number of clusters |</span>
<span id="cb98-1748"><a href="#cb98-1748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1749"><a href="#cb98-1749" aria-hidden="true" tabindex="-1"></a>The choice of randomization method should be guided by:</span>
<span id="cb98-1750"><a href="#cb98-1750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1751"><a href="#cb98-1751" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>The unit of randomization (individual vs. cluster)</span>
<span id="cb98-1752"><a href="#cb98-1752" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>The importance of balance on specific variables</span>
<span id="cb98-1753"><a href="#cb98-1753" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Feasibility constraints</span>
<span id="cb98-1754"><a href="#cb98-1754" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Analysis plans</span>
<span id="cb98-1755"><a href="#cb98-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1756"><a href="#cb98-1756" aria-hidden="true" tabindex="-1"></a>Happy randomizing!</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Sean Sylvia</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/hpm883/edit/main/unit-2/lec-2-2.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/hpm883/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>