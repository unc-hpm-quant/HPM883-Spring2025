{
  "hash": "56f8e317018405aa6601a506a956d6fd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab 2: Power by Simulation\"\nsubtitle: \"(Possible)Solutions\"\nauthor: \"Sean Sylvia\"\ndate: \"2025-02-24\"\nslug: \"lab-2\"\ncategories: [Lab, Internal Validity]\ndescription: \"Conducting power calculations by simulation, first without clusters and then with clusters.\"\nformat: \n  html:\n    toc: true\n    toc-depth: 2\n    code-tools: true\neditor: visual\ndraft: false\n---\n\n\n\n## **Overview and Learning Objectives**\n\nIn this lab, you will explore the concept of **statistical conclusion validity** by conducting **power calculations via simulation**. Specifically, you will:\n\n1.  Conduct a power simulation for a simple randomized experiment **without clustering** (i.e., ignoring the fact that participants may be grouped within clinics).\n2.  Extend that simulation to **account for clustering** (i.e., clinics as the unit of randomization).\n3.  Examine the impact of **sample size**, **effect size**, and **clustering** on statistical power, and visualize how minimum detectable effect sizes (MDE) change with sample size.\n\nBy the end of this lab, you will have a deeper understanding of:\n\n-   How **sources of uncertainty** (sampling variation, variance in potential outcomes across participants, and measurement error) affect your study’s outcomes.\n-   Why we must beware of **Type I** (false positive) and **Type II** (false negative) errors—especially if Dr. P-Hacker is anywhere near our data.\n-   How **p-values** should (and should not!) be interpreted.\n-   How to **simulate data** that include cluster-level effects and adjust for these effects in your analysis.\n\n------------------------------------------------------------------------\n\n## **The Hospital Drama Begins**\n\nWelcome to **St. Null’s Memorial Hospital**, where a brand-new quality improvement intervention is about to be tested. The hospital’s network of clinics, collectively called **The Null Distribution**, is famous for its dedication to meticulous data collection—and also for some questionable statistical practices performed by a rather infamous staff member.\n\n-   **CEO Barnaby Beta** has championed a new, cost-intensive intervention aimed at improving patient satisfaction.\n-   **Nurse Random** insists on conducting a proper **randomized control trial (RCT)**, but quickly realizes **Dr. P-Hacker** might have already meddled with the initial power calculations.\n-   **Dr. P-Hacker** is known to declare victory (“Significant at the 5% level!”) before even cleaning the data, and is rumored to own a golden “`p < 0.05`” sign that he waves in staff meetings.\n-   **Dr. Doub R. Obust** is the voice of reason, reminding everyone of fundamental statistical principles.\n\nIn this lab, you (the consultants) have been summoned to **salvage** the situation. Let’s see how this plays out.\n\n------------------------------------------------------------------------\n\n## **The Plot Thickens: Power Calculations Without Clustering**\n\n### Scene 1: The Mysterious Spreadsheet\n\n**Nurse Random** bursts into the conference room, clutching a color-coded spreadsheet.\n\n> **Nurse Random:** “Dr. P-Hacker, your power calculations look suspiciously high. Did you account for the fact that we’re randomizing by clinic, not by individual patient?”\n\n> **Dr. P-Hacker:** “Of course not, Nurse Random. Look, a random patient is a random patient—no matter which clinic they come from! Besides, I love high power. It makes me feel like my study can conquer the world!”\n\n> **Dr. Doub R. Obust (rolling eyes):** “We’re going to need to run a simulation that properly reflects how the intervention is assigned at the **clinic** level, not just among individual patients. Otherwise, your calculations will be as overconfident as your new P-value neon sign.”\n\nNonetheless, **Dr. P-Hacker** shares his “method” with you first. Let’s start by **replicating** his approach (ignoring clustering). This will be our baseline—**what not to do** if clinics are truly the unit of randomization.\n\n------------------------------------------------------------------------\n\n### **Step 1: Flawed Power Simulation (Ignoring Clustering)**\n\nWe’ll simulate a dataset **as if** individual patients are randomly assigned to treatment or control. We’ll compute the statistical power for detecting a **true treatment effect** of a specified size, ignoring any clinic-level differences.\n\n::: callout-note\n## Task 1: Flawed Simulation Setup\n\nFill in the code below to acheive a power of around 0.8 (may not be exact, but get as close as you can):\n\n1.  Set a **sample size** for the total number of patients.\\\n2.  Specify a **treatment effect** (`effect`).\\\n3.  Decide on the **proportion** of participants to receive treatment (`prop`).\\\n4.  Select a **significance level** (`t_alpha`).\\\n5.  Run multiple simulations (`sim.size`).\n\nThen, run a linear regression on each simulated dataset, gather the *p*-values, and compute how often the null hypothesis is rejected (i.e., estimate power).\n\nNote: The code below is not executable. You need to change the `eval: false` to `eval: true` to make it work and fill in the blanks.\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nset.seed(123456)\n\n# Define parameters\nsample_size <- 790     # e.g. 500\neffect <- 0.2          # e.g. 0.2\nprop <- 0.5            # e.g. 0.5\nt_alpha <- 0.05        # e.g. 0.05\nsim.size <- 2000       # e.g. 2000\n\n# Initialize storage for results\nreject_t <- numeric(sim.size)\n\n# Simulation loop\nfor (i in 1:sim.size) {\n  dt <- data.table(id = 1:sample_size)\n  \n  # Assign treatment individually (incorrect for cluster randomization!)\n  dt[, treatment := rbinom(.N, 1, prop)]\n  \n  # Simulate outcome (10 is baseline, 'effect' is added if treatment=1)\n  dt[, outcome := 10 + effect * treatment + rnorm(.N, mean = 0, sd = 1)]\n  \n  # Estimate the effect\n  fit <- lm(outcome ~ treatment, data = dt)\n  p_value <- summary(fit)$coefficients[2,4]\n  \n  # Check if we reject H0: (p-value < alpha)\n  reject_t[i] <- ifelse(p_value < t_alpha, 1, 0)\n}\n\n# Compute estimated power\npower_flawed <- mean(reject_t)\ncat(\"Estimated Power (Ignoring Clustering):\", power_flawed, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nEstimated Power (Ignoring Clustering): 0.8035 \n```\n\n\n:::\n:::\n\n\n\n### **Discussion of Step 1**\n\n-   **Nurse Random** sighs: “We got an estimated power of 0.8 (yours might be slightly different). But do we trust this number?”\n-   **Dr. Doub R. Obust** chimes in: “Nope. We’re ignoring that patients within the same clinic might be more similar to each other than to patients in other clinics. Our standard errors are artificially small.”\n\nAt this point, **CEO Barnaby Beta** perks up: “Artificially small standard errors? That means we’re basically claiming more precision than we actually have, right?”\n\nYes, indeed. If we disregard the **clustering** of patients, we risk making a **Type I error** more often than we realize. Dr. P-Hacker, in typical fashion, responds:\n\n> **Dr. P-Hacker:** “Type I error? Isn’t that just when we see something interesting that’s obviously there?!”\\\n> **Dr. Doub R. Obust (groaning):** “No. A Type I error is a *false positive*—we conclude there *is* an effect even though, in truth, there isn’t. Like thinking you’ve discovered a rare golden banana flavor at the cafeteria soda machine when really it’s just seltzer water with a weird label!”\n\n------------------------------------------------------------------------\n\n## **Understanding the Sources of Uncertainty**\n\nBefore we fix our simulation, **Dr. Doub R. Obust** insists that you reflect on **why** ignoring clinic-level clustering is a problem. He ticks off sources of variability that a real experiment faces:\n\n1.  **Sampling Variation**: Even if you have a large population of patients, the sample you select is just one draw from a bigger population. Different samples might give different estimates.\\\n2.  **Measurement Error**: If your measurement tool for patient well-being is noisy (e.g., patients often mis-report how they feel, or staff record data incorrectly), it introduces extra variability that can muddy your effect estimates.\n3.  **Variance in Potential Outcomes**: Not all patients respond to treatments in the same way. Some might be strongly affected, some not at all—leading to variation in the outcomes. This includes **clustering**: Patients in the *same clinic* share certain characteristics, environmental factors, or staff practices that can affect their potential outcomes. This correlation *must* be accounted for in the design and analysis.\n\n> **Nurse Random:** “So if we ignore that last point—clustering—our estimate of the variability (and thus the standard error) is off, and we might incorrectly claim significance. That’s basically p-hacking 101!”\n\n------------------------------------------------------------------------\n\n## **Power Calculations With Clustering**\n\n### Scene 2: A (Cluster-)Randomized Trial\n\nNow we come to the **correct** approach: our **unit of randomization** is the **clinic**, not the individual. That means each clinic either receives the intervention or does not, and all patients in a clinic share the same treatment assignment.\n\n------------------------------------------------------------------------\n\n### **Step 2: Incorporating Clustering**\n\nWe’ll model:\n\n-   **`num_clusters`** = number of clinics.\\\n-   **`cluster_size`** = number of patients per clinic.\\\n-   **`icc`** (*Intraclass Correlation Coefficient*): A measure of how strongly patients in the same clinic resemble each other. High ICC means patients within a clinic are more correlated.\\\n-   We’ll generate clinic-level “random effects” and individual-level error terms to reflect **both** measurement error and the variability in potential outcomes across individuals.\n\n::: callout-note\n## Task 2: Correcting the Simulation for Clustering\n\nFill in the code below to acheive a power of 0.8:\n\n1.  Define the **number of clinics** and the **number of patients per clinic**.\\\n2.  Assign each entire clinic to treatment or control.\\\n3.  Incorporate **cluster-level** random effects.\\\n4.  Fit the model but adjust standard errors for clustering.\\\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(multiwayvcov)  # for cluster-robust standard errors\nlibrary(lmtest)        # for coeftest\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: zoo\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'zoo'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:data.table':\n\n    yearmon, yearqtr\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    as.Date, as.Date.numeric\n```\n\n\n:::\n\n```{.r .cell-code}\n# Define cluster parameters\nnum_clusters <- 241    # e.g. 50\ncluster_size <- 20     # e.g. 10\ntotal_sample <- num_clusters * cluster_size\nicc <- 0.2             # e.g. 0.4\n\n# Variances\nind_err_var <- 1\n# cluster_err_var is derived from the intraclass correlation coefficient\ncluster_err_var <- (icc * ind_err_var) / (1 - icc)\n\nsim.size <- 2000        # e.g. 2000\neffect <- 0.2           # e.g. 0.2\nprop <- 0.5             # e.g. 0.5\nt_alpha <- 0.05         # e.g. 0.05\n\nreject_t <- numeric(sim.size)\n\nset.seed(654321)\nfor (i in 1:sim.size) {\n  \n  # Create a data table with one row per cluster, repeated for each patient\n  clusters <- data.table(\n    cluster = rep(1:num_clusters, each = cluster_size)\n  )\n  \n  # Generate a cluster-level random effect\n  clusters[, cluster_error := rep(\n    rnorm(num_clusters, mean = 0, sd = sqrt(cluster_err_var)),\n    each = cluster_size\n  )]\n  \n  # Randomize at the clinic level\n  clusters[, treatment := rep(\n    rbinom(num_clusters, 1, prop),\n    each = cluster_size\n  )]\n  \n  # Add an individual-level error\n  clusters[, individual_error := rnorm(.N, mean = 0, sd = sqrt(ind_err_var))]\n  \n  # Final outcome for each individual\n  clusters[, outcome := 10 + effect * treatment + cluster_error + individual_error]\n  \n  # Fit a naive linear model (ignoring clustering in standard errors)\n  fit <- lm(outcome ~ treatment, data = clusters)\n  \n  # Adjust standard errors for clustering\n  robust_SE <- cluster.vcov(fit, clusters$cluster, df_correction = TRUE)\n  robust_coef <- coeftest(fit, robust_SE)\n  \n  # Get the p-value for the treatment coefficient\n  p_value <- robust_coef[2,4]\n  reject_t[i] <- ifelse(p_value < t_alpha, 1, 0)\n}\n\n# Compute estimated power with clustering\npower_clustered <- mean(reject_t)\ncat(\"Estimated Power (Clustered):\", power_clustered, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nEstimated Power (Clustered): 0.82 \n```\n\n\n:::\n:::\n\n\n\n### **Discussion of Step 2**\n\n**Dr. Doub R. Obust** looks at the new power estimate and remarks:\n\n> “As you can see, once we account for clustering, the power is (usually) **lower** than in the flawed approach. That’s because those cluster-level similarities effectively reduce the amount of independent information we have. Our standard errors are bigger, so it’s harder to find significance unless the effect size or sample size is larger.”\n\n**CEO Barnaby Beta** shakes his head: “But that means our study might be underpowered if we stick to our current budget!”\n\n**Nurse Random** replies with a grin: “Don’t worry, we can plan more carefully. Otherwise, if we run a smaller study, we risk a **Type II error**—failing to reject the null hypothesis when there really is an effect. You know, like leaving the gold standard intervention on the shelf because we didn’t gather enough data to prove it works.”\n\n**Dr. P-Hacker** interjects:\n\n> “And there’s always `p < 0.10`, right? We can move our threshold for significance to get more ‘positive’ results!”\\\n> **Nurse Random (scolding):** “That’s *literally* p-hacking. Please step away from the analysis, Doctor.”\n\n------------------------------------------------------------------------\n\n## **The Truth About *p*-Values**\n\nA quick comedic break for a lesson on *p*-values:\n\n-   **Dr. P-Hacker** keeps shouting that *p* \\< 0.05 means there’s a 5% chance the null hypothesis is true.\\\n-   **Nurse Random** corrects him: “No, no, no. A *p*-value is the probability of observing a result *at least as extreme as ours* if the null is true. It’s NOT the probability the null is true. You can’t interpret it that way.”\n\n> **Dr. P-Hacker**: “I was so sure it was the probability that *I* was right.”\\\n> **Dr. Doub R. Obust**: “We live and learn, Doctor.”\n\n------------------------------------------------------------------------\n\n## **Plotting the Minimum Detectable Effect (MDE)**\n\nBecause **CEO Barnaby Beta** wants to know how large an effect must be to have a reasonable chance of detection, you might want to simulate across a range of effect sizes and/or sample sizes. You can then plot the resulting power curves to see what the **Minimum Detectable Effect** (MDE) is for a given power requirement.\n\n::: callout-note\n### Task 3: Create an MDE Plot\n\n1.  Loop over a grid of *effect sizes* (or sample sizes).\\\n2.  For each value, compute power using the cluster-based simulation approach.\\\n3.  Plot the *effect size* on the x-axis and the corresponding *power* on the y-axis.\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\n# Simulation parameters for clustering\nnum_clusters <- 241    # Number of clinics\ncluster_size <- 20     # Patients per clinic\ntotal_sample <- num_clusters * cluster_size\nicc <- 0.2             # Intraclass correlation coefficient\n\n# Variance parameters\nind_err_var <- 1\ncluster_err_var <- (icc * ind_err_var) / (1 - icc)\n\nsim.size <- 2000       # Number of simulation iterations per effect size\nprop <- 0.5            # Proportion of clinics assigned to treatment\nt_alpha <- 0.05        # Significance level\n\n# Define a grid of effect sizes\neffect_sizes <- seq(0, 0.5, by = 0.05) \nresults <- data.table(effect = effect_sizes, power = NA_real_)\n\nset.seed(072111)  # For reproducibility\n\n# Loop over each effect size\nfor (e in seq_along(effect_sizes)) {\n  current_effect <- effect_sizes[e]\n  reject_t <- numeric(sim.size)\n  \n  for (i in 1:sim.size) {\n    # Create a data table with one row per patient, with clinic identifier\n    clusters <- data.table(cluster = rep(1:num_clusters, each = cluster_size))\n    \n    # Generate cluster-level random effects\n    clusters[, cluster_error := rep(rnorm(num_clusters, mean = 0, \n                                            sd = sqrt(cluster_err_var)), \n                                     each = cluster_size)]\n    \n    # Randomize treatment at the clinic level (all patients in a clinic get the same assignment)\n    clusters[, treatment := rep(rbinom(num_clusters, 1, prop), each = cluster_size)]\n    \n    # Add individual-level random error\n    clusters[, individual_error := rnorm(.N, mean = 0, sd = sqrt(ind_err_var))]\n    \n    # Generate the outcome variable: baseline of 10 plus treatment effect and both errors\n    clusters[, outcome := 10 + current_effect * treatment + cluster_error + individual_error]\n    \n    # Fit the linear model (naively, without clustering adjustments)\n    fit <- lm(outcome ~ treatment, data = clusters)\n    \n    # Adjust standard errors for clustering\n    robust_SE <- cluster.vcov(fit, clusters$cluster, df_correction = TRUE)\n    robust_coef <- coeftest(fit, robust_SE)\n    \n    # Check if the p-value for the treatment coefficient is below the threshold\n    p_value <- robust_coef[2, 4]\n    reject_t[i] <- ifelse(p_value < t_alpha, 1, 0)\n  }\n  \n  # Compute the estimated power (proportion of rejections) for this effect size\n  results$power[e] <- mean(reject_t)\n}\n\n# Create the plot: Power vs. Effect Size\nggplot(results, aes(x = effect, y = power)) +\n  geom_line() +\n  geom_point() +\n  labs(\n    title = \"Power vs. Effect Size\",\n    x = \"Effect Size\",\n    y = \"Power\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](lab-2-Power-sols_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n## **Final Words from the Hospital Staff**\n\n**CEO Barnaby Beta**: “Alright, so if we need to ensure we have enough clinics and participants to achieve our desired power, we may need a bigger budget than expected. Let’s not forget that ignoring clustering would have given us a false sense of security in our power. Now we know better.”\n\n**Nurse Random**: “And no more Type I or Type II error confusion, Dr. P-Hacker. We must keep our definitions straight if we’re to have any credibility around here!”\n\n**Dr. P-Hacker (sighing):** “Fine, fine. Guess I’ll tone down the p-value hype. But I’m keeping my neon sign.”\n\n**Dr. Doub R. Obust (with a grin):** “We’ll allow the neon sign, as long as you promise to interpret it *correctly*.”\n\n------------------------------------------------------------------------\n\n## **Submission Instructions**\n\n1.  Make sure your `.qmd` file knits successfully (to `.pdf` or `.html`).\\\n2.  Upload your compiled document to [Gradescope](https://www.gradescope.com/courses/781406).\\\n3.  **Include** your discussion of the results, your code, and your responses to the callout sections.\n\nRemember, the moral of the story: **Always check who (or what) is being randomized, and account for clustering when necessary!** Otherwise, your study conclusions might be as random as Dr. P-Hacker’s next dinner choice.",
    "supporting": [
      "lab-2-Power-sols_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}